/**
 * NOVIUS OS - Web OS for digital communication
 *
 * @copyright  2011 Novius
 * @license    GNU Affero General Public License v3 or (at your option) any later version
 *             http://www.gnu.org/licenses/agpl-3.0.html
 * @link http://www.novius-os.org
 */
define("jquery-nos-inspector-tree-model-checkbox",["jquery","jquery-nos-treegrid"],function(a){a.fn.extend({nosInspectorTreeModelCheckbox:function(b){b=b||{};return this.each(function(){var d=a(this).css({height:b.height||"150px",width:b.width||""}),i,e=d.attr("id"),k=d.find("table"),h=d.closest(".nos-dispatcher, body").on("contextChange",function(){f();if(b.contextChange){k.nostreegrid("option","treeOptions",{context:h.data("nosContext")||""})}}),g=false,c,f=function(){if(b.reloadEvent){d.nosUnlistenEvent("inspector"+e);var l={name:b.reloadEvent};if(h.data("nosContext")){l.context=h.data("nosContext")}d.nosListenEvent(l,function(){k.nostreegrid("reload")},"inspector"+e)}},j=function(){f();var l=a.extend(true,{},b.treeOptions||{});if(!l.context){l.context=h.data("nosContext")||""}k.nostreegrid({sortable:false,movable:false,urlJson:b.urlJson,treeColumnIndex:1,treeOptions:l,preOpen:b.selected||{},columnsAutogenerationMode:"none",scrollMode:"auto",cellStyleFormatter:function(m){if(m.$cell.is("td")){m.$cell.removeClass("ui-state-highlight")}},rowStyleFormatter:function(m){if(m.type==a.wijmo.wijgrid.rowType.header){m.$rows.hide()}},rendering:function(){g=false},rendered:function(){g=true;k.css("height","auto");if(a.isPlainObject(b.selected)){a.each(b.selected,function(m,o){if(a.isPlainObject(o)&&o.id){var n=d.find(":checkbox[value="+o.id+"]").prop("checked",true);if(o.disable_check){n.attr("disabled",o.disable_check)}}})}if(a.isPlainObject(b.disabled)){a.each(b.disabled,function(m,n){if(a.isPlainObject(n)&&n.id){d.find(":checkbox[value="+n.id+"]").attr("disabled",true)}})}},columns:b.columns})};b.columns.unshift({allowMoving:false,allowSizing:false,width:35,ensurePxWidth:true,cellFormatter:function(l){if(a.isPlainObject(l.row.data)){a('<input type="checkbox" />').attr({value:l.row.data._id}).click(function(){var n=a(this),m=n.is(":checked");if(m){b.selected[l.row.data._model+"|"+l.row.data._id]={id:l.row.data._id,model:l.row.data._model};if(!c.filter('[value="'+l.row.data._id+'"]').size()){a('<input type="hidden" />').attr({name:b.input_name+"[]",value:l.row.data._id}).appendTo(d)}}else{b.selected[l.row.data._model+"|"+l.row.data._id]&&delete b.selected[l.row.data._model+"|"+l.row.data._id];c.filter('[value="'+l.row.data._id+'"]').remove()}c=d.find('input[name="'+b.input_name+'[]"]');n.trigger("selectionChanged",l.row.data)}).appendTo(l.$container);return true}}});if(a.isArray(b.selected)){i={};a.each(b.selected,function(l,m){if(a.isPlainObject(m)&&m.id&&m.model){i[m.model+"|"+m.id]=m}});b.selected=i}if(a.isPlainObject(b.selected)){a.each(b.selected,function(l,m){if(a.isPlainObject(m)&&m.id){a('<input type="hidden" />').attr({name:b.input_name+"[]",value:m.id}).appendTo(d)}})}c=d.find('input[name="'+b.input_name+'[]"]');k.css({height:"100%",width:"100%"});k.nosOnShow("one",j)})}});return a});