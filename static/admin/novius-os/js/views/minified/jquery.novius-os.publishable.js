/**
 * NOVIUS OS - Web OS for digital communication
 *
 * @copyright  2011 Novius
 * @license    GNU Affero General Public License v3 or (at your option) any later version
 *             http://www.gnu.org/licenses/agpl-3.0.html
 * @link http://www.novius-os.org
 */
define("jquery-nos-publishable",["jquery-nos","jquery-ui.button","jquery-ui.datetimepicker.i18n"],function(b){var a=function(f,c,e){var d=f.val();require(["jquery.globalize","jquery.globalize.cultures"],function(){if(d==""){var l=c.find("a.date_new");if(l.length>0){}else{c.empty().append(b('<a class="date_new"></a>').text(e.texts.pick).on("click",function i(m){m.preventDefault();f.datetimepicker("show")}))}}else{Globalize.culture(b.nosLang.substr(0,2));var g=f.datetimepicker("getDate");var k=Globalize.format(g,"d")+" "+Globalize.format(g,"t");var l=c.find("a.date_pick");if(l.length>0){l.text(k)}else{c.empty().append(b(e.texts.clear));c.find("a.date_pick").text(k).on("click",function h(m){m.preventDefault();f.datetimepicker("show")});c.find("a.date_clear").on("click",function j(m){m.preventDefault();f.val("").trigger("change")})}}})};b.fn.extend({nosPublishable:function(c){c=c||{initialStatus:"undefined",date_range:false,texts:{"undefined":{0:"Will not be published",1:"Will be published"},no:{0:"Not published",1:"Will be published"},yes:{0:"Will be unpublished",1:"Published"}}};return this.each(function(){var m=b(this),e=m.find("td:first"),k=e.next(),i=k.next(),g="initial",j=function(){e.find(":radio").each(function(){var n=b(this),o=e.find("label[for="+n.attr("id")+"] img");o.attr({title:c.texts[c.initialStatus][n.val()],alt:c.texts[c.initialStatus][n.val()]})})};if(c.date_range){var l=b("#"+c.date_range.container);var f=l.find("#"+c.date_range.inputStart);var h=l.find("#"+c.date_range.inputEnd);var d=c.date_range.now;d=new Date(d[0],d[1]-1,d[2],d[3],d[4],d[5]);f.add(h).on("change",function(q){var s=f.datetimepicker("getDate");var p=h.datetimepicker("getDate");var r="";if(s==null||s<d){r="published"}else{if(p!=null&&p<d){r="backdated"}else{r="scheduled"}}var o="planification_status_"+g+"_"+r;var n=i.find("table."+o);if(n.length>0){}else{n=b('<table class="publication_status '+o+'"></table>').append(c.date_range.texts[g][r]);i.empty().append(n);g="modified"}a(f,i.find("span.date_start"),c.date_range);a(h,i.find("span.date_end"),c.date_range)});b.timepicker.setDefaults(b.timepicker.regional[b.nosLang.substr(0,2)]);f.add(h).datetimepicker({timeFormat:"hh:mm:ss",dateFormat:"yy-mm-dd"});f.trigger("change")}j();e.buttonset();e.find(":radio").change(function(){var n=b(this).val();k.text(c.texts[c.initialStatus][n]);j();k[n==2?"hide":"show"]();i[n==2?"show":"hide"]()});e.find(":checked").triggerHandler("change");e.closest("form").bind("ajax_success",function(o,n){if(n.publication_initial_status==null){log("Potential error: publication_initial_status in JSON response.");return}c.initialStatus=n.publication_initial_status;if(c.date_range&&c.initialStatus==2){g="initial";b("#"+c.date_range.inputStart).trigger("change")}else{e.find(":radio[value="+c.initialStatus+"]")[0].checked=true;e.find(":checked").triggerHandler("change")}})})}});return b});