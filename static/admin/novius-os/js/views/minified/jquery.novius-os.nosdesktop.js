/**
 * NOVIUS OS - Web OS for digital communication
 *
 * @copyright  2011 Novius
 * @license    GNU Affero General Public License v3 or (at your option) any later version
 *             http://www.gnu.org/licenses/agpl-3.0.html
 * @link http://www.novius-os.org
 */
define("jquery-nos-nosdesktop",["jquery-nos","jquery-ui.sortable"],function(a){var b=Modernizr.touch;a.widget("nos.nosdesktop",{options:{launchers:[],reloadUrl:"admin/nos/noviusos/desktop"},launcherWidth:150,launcherHeight:0,grid:{positions:{},set:function(d,c){if(a.isPlainObject(d)){c=d.top;d=d.left}this.positions[d]=this.positions[d]||{};this.positions[d][c]=true},isSet:function(d,c){if(d<0||c<0){return true}return this.positions[d]&&this.positions[d][c]},unSet:function(d,c){if(a.isPlainObject(d)){c=d.top;d=d.left}this.positions[d]=this.positions[d]||{};this.positions[d][c]=false}},_create:function(){var c=this,d=c.options;this.grid.positions={};this.unPositioned=[];c.element.nosListenEvent({name:"Nos\\Application"},function(){if(c.jqxhrReload){c.jqxhrReload.abort()}c.jqxhrReload=a.ajax({url:d.reloadUrl,success:function(e){a(window).off("resize",c._windowResize);c.element.nosUnlistenEvent("nosdesktop").closest(".nos-dispatcher").off("showPanel");c.element.parent().empty().append(e)}})},"nosdesktop");c.maxWidth=c.element.width();a.each(d.launchers,function(){var e=this;a('<a href="#"><span class="icon"><img class="gloss" src="static/novius-os/admin/novius-os/img/64/gloss.png" /><img width="64" /></span><span class="text"></span></a>').addClass("app launcher-"+e.key).data("launcher",e).find("span.icon img:last").attr("src",e.icon).end().find("span.text").html(e.name).end().appendTo(c.element)});c.$launchers=c.element.find(".app");c._calculateLauncherHeight()._positionLaunchers(true)._positionUnpositioned();if(!b){c._initDrag()}c.$launchers.click(function(f){c._launcherClick(a(this),f)});c._windowResize=a.proxy(function(){var e=this;if(e.element.closest(".nos-dispatcher").is(":visible")){if(e.timeoutResize){window.clearTimeout(e.timeoutResize)}e.timeoutResize=window.setTimeout(function(){e.resize()},200)}else{e.element.closest(".nos-dispatcher").one("showPanel",function(){e.resize()})}},c);a(window).on("resize",c._windowResize)},_calculateLauncherHeight:function(){var c=this;c.$launchers.each(function(){var d=a(this).outerHeight(true);if(d>c.launcherHeight){c.launcherHeight=d}});return c},_positionLaunchers:function(d){var c=this;c.$launchers.each(function(){var e=a(this),f=e.data("launcher");if(a.isPlainObject(f.position)&&((f.position.left+1)*c.launcherWidth)<c.maxWidth){c._positionLauncher(e,f.position.left,f.position.top)}else{if(a.isPlainObject(f.position)){c.grid.unSet(f.position)}c.unPositioned.push(e)}if(d){f.savedPosition=a.extend({},f.position)}});return c},_positionUnpositioned:function(){var c=this;if(!c.unPositioned.length){return c}a.each(c.unPositioned,function(){var f=this,g=f.data("launcher"),e=0,d=0;while(1==1){if(c.grid.isSet(e,d)){e++;if(((e+1)*c.launcherWidth)>c.maxWidth){e=0;d++}continue}else{c._positionLauncher(f,e,d);break}}});c.unPositioned=[];return c},_initDrag:function(){var c=this;c.$launchers.draggable({containement:c.element,grid:[c.launcherWidth,c.launcherHeight],scroll:false,stop:function(h,d){var i=a(this),k=d.position,j=i.data("launcher"),g=parseInt(k.left/c.launcherWidth),f=parseInt(k.top/c.launcherHeight);i.unbind("click");i.one("click",function(e){e.preventDefault();e.stopImmediatePropagation();a(this).click(function(l){c._launcherClick(a(this),l)})});if((k.left+c.launcherWidth)>c.element.width()||c.grid.isSet(g,f)){i.animate({left:(j.position.left*c.launcherWidth)+"px",top:(j.position.top*c.launcherHeight)+"px"},200)}else{c.grid.unSet(j.position);c._positionLauncher(i,g,f);c.save()}}});return c},_positionLauncher:function(f,e,d){var c=this,g=f.data("launcher");g.position={left:e,top:d};f.css({left:(e*c.launcherWidth)+"px",top:(d*c.launcherHeight)+"px",visibility:"visible"});c.grid.set(e,d);return c},_launcherClick:function(f,d){var c=this,g=f.data("launcher");d.preventDefault();if(g.action.tab){g.action.tab=a.extend({app:true,iconSize:32,labelDisplay:false},g.action.tab)}f.nosAction(g.action);return c},resize:function(){var c=this;c.maxWidth=c.element.width();c.$launchers.each(function(){var d=a(this),e=d.data("launcher");if(e.savedPosition){c.grid.unSet(e.position);e.position=a.extend({},e.savedPosition)}});c._positionLaunchers()._positionUnpositioned();return c},reset:function(){var c=this;c.unPositioned=[];c.$launchers.each(function(){var d=a(this),e=d.data("launcher");if(a.isPlainObject(e.position)){c.grid.unSet(e.position)}e.position={};e.savedPosition={}});c.grid.positions={};c.unPositioned.sort(function(e,d){var g=e.data("launcher").name.toLowerCase();var f=d.data("launcher").name.toLowerCase();return((g<f)?-1:((g>f)?1:0))});c.resize()},save:function(){var c=this,d={};c.$launchers.each(function(){var e=a(this),f=e.data("launcher");f.savedPosition=a.extend({},f.position);d[f.key]={position:f.position}});c.$launchers.nosSaveUserConfig("misc.apps",d);return c}});return a});