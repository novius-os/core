(function(){tinymce.PluginManager.requireLangPack("nosenhancer");tinymce.create("tinymce.plugins.NosEnhancerPlugin",{init:function(b,c){var a=this;a.editor=b;a.url=c;a.nosenhancer_enhancers=b.getParam("nosenhancer_enhancers",[]);if(a.nosenhancer_enhancers){tinymce.each(a.nosenhancer_enhancers,function(g,h){a.nosenhancer_enhancers[h].id=h;if(!a.nosenhancer_enhancers[h].previewUrl){a.nosenhancer_enhancers[h].previewUrl="admin/nos/enhancer/preview"}})}if(!a.nosenhancer_enhancers){return false}b.addCommand("mceNosEnhancer",function(h,f,g){a._nosEnhancer(h,f,g)});b.onInit.add(function(f){f.dom.loadCSS(c+"/css/content.css")});function d(f){f.filter(".nosEnhancer, .nosEnhancerInline").empty();f.find(".nosEnhancer, .nosEnhancerInline").empty()}function e(f){f.find(".nosEnhancer, .nosEnhancerInline").each(function(){var g=$(this);g.html(b.getLang("nosenhancer.loading"));a.onEnhancerAdd(g);var j=$(this).data("enhancer");var h=a.nosenhancer_enhancers[j];var i=$.extend(true,{enhancer:j},$(this).data("config"));$.ajax({url:h.previewUrl,type:"POST",dataType:"json",data:i,success:function(k){g.html($.trim(k.preview));a.onEnhancerAdd(g,h)},error:function(){g.html(b.getLang("nosenhancer.loading_error"));a.onEnhancerAdd(g)}})})}b.onGetContent.add(function(f,h){var g=$(h.content);d(g);h.content=$("<div></div>").append(g).html()});b.onSetContent.add(function(f,g){setTimeout(function(){var h=$(f.getBody());e(h)},1)});b.onClick.add(function(f,l){var k=$(l.target);var i=k.data("action");var j=null;if(i=="addParagraphBefore"){j=$("<p></p>").text(f.getLang("nosenhancer.new_paragraph"));k.closest(".nosEnhancer, .nosEnhancerInline").before(j);f.selection.select(j.get(0),true);f.focus(false);f.execCommand("mceEndUndoLevel");l.preventDefault()}if(i=="addParagraphAfter"){j=$("<p></p>").text(f.getLang("nosenhancer.new_paragraph"));k.closest(".nosEnhancer, .nosEnhancerInline").after(j);f.selection.select(j.get(0),true);f.focus(false);f.execCommand("mceEndUndoLevel");l.preventDefault()}if(i=="editEnhancer"){var g=k.closest(".nosEnhancer, .nosEnhancerInline");var h=a.nosenhancer_enhancers[$(g).data("enhancer")];a._nosEnhancer(null,h,g);l.preventDefault()}if(i=="removeEnhancer"){k.closest(".nosEnhancer, .nosEnhancerInline").remove();f.execCommand("mceEndUndoLevel");l.preventDefault()}})},createControl:function(e,a){var b=this,d;if(e==="nosenhancer"){d=a.createMenuButton("nosenhancer",{title:"nosenhancer.desc",label:"nosenhancer.desc",image:b.url+"/img/enhancer.gif",cmd:"mceNosEnhancer"});d.onRenderMenu.add(function(g,f){f.settings.max_height=300;f.add({title:"nosenhancer.desc","class":"mceMenuItemTitle"}).setDisabled(1);tinymce.each(b.nosenhancer_enhancers,function(c){f.add({title:c.title,style:"background: url("+c.iconUrl+") no-repeat 5px center;",id:"enhancer_"+c.id,onclick:function(){b.editor.execCommand("mceNosEnhancer",false,c)}})})});return d}return null},_nosEnhancer:function(i,j,k){var f=tinyMCE.activeEditor;var h=null,l=this,c=(function(){var m=k?$(k).attr("data-config"):{};if($.type(m)==="string"){m=$.parseJSON(m)}return m})(),d=k?$.extend(true,{nosContext:$(f.getElement()).closest(".nos-dispatcher").data("nosContext"),enhancer:j.id,enhancerAction:"update"},c):{nosContext:$(f.getElement()).closest(".nos-dispatcher").data("nosContext"),enhancer:j.id,enhancerAction:"insert"},g=function(m){if(k){k=k[0]}else{f.execCommand("mceInsertContent",false,f.dom.createHTML("div",{id:"__mce_tmp","class":"mceNonEditable"}),{skip_undo:1});k=f.dom.get("__mce_tmp")}$(k).attr("data-enhancer",j.id).attr("data-config",$.type(m.config)==="string"?m.config:JSON.stringify(m.config)).removeAttr("id").html($.trim(m.preview));l.onEnhancerAdd(k,j);f.focus(true)};if(!$.isPlainObject(j.dialog)||!j.dialog.contentUrl){$.ajax({url:j.previewUrl,type:"POST",dataType:"json",data:{enhancer:j.id},success:g,error:function(){console.log("Error: unable to add the enhancer in the Wysiwyg (no popup)")}});return}if(j.dialog.ajax||!k){h=$nos(f.getElement()).nosDialog($.extend({title:j.title},$.extend({},j.dialog,{ajax:true,ajaxData:d})))}else{h=$nos(f.getElement()).nosDialog($.extend({title:j.title},$.extend({},j.dialog,{contentUrl:null})));var b=$("<form></form>").attr("action",j.dialog.contentUrl).attr("method","post").attr("target","tinymce_dialog").appendTo(h),e=$("<iframe></iframe>").attr("src",/^https/i.test(window.location.href||"")?"javascript:false":"about:blank").attr("frameborder","0").attr("name","tinymce_dialog").css({width:"100%",height:"99%"}).appendTo(h),a=function(m,n){if($.isArray(n)){$.each(n,function(o,p){a(m+"[]",p)})}else{$('<input type="hidden" name="'+m+'">').attr("value",n).appendTo(b)}};$.each(d||{},function(m,n){a(m,n)});h.css("padding","0px");b.submit()}h.bind("save.enhancer",function(n,m){g(m);h.nosDialog("close")})},onEnhancerAdd:function(a,f){var b=tinyMCE.activeEditor;a=$(a);var e=$('<a href="#" data-action="removeEnhancer"></a>').text(b.getLang("nosenhancer.delete")).attr("title",b.getLang("nosenhancer.delete")).addClass("nos_enhancer_action nos_enhancer_action_delete"),d=$('<a href="#" data-action="editEnhancer"></a>').text(b.getLang("nosenhancer.options")).attr("title",b.getLang("nosenhancer.options")).addClass("nos_enhancer_action nos_enhancer_action_edit"),g=$('<a href="#" data-action="addParagraphAfter"></a>').text(b.getLang("nosenhancer.p_after")).attr("title",b.getLang("nosenhancer.p_after")).addClass("nos_enhancer_action nos_enhancer_action_after"),c=$('<a href="#" data-action="addParagraphBefore"></a>').text(b.getLang("nosenhancer.p_before")).attr("title",b.getLang("nosenhancer.p_before")).addClass("nos_enhancer_action nos_enhancer_action_before");if(a.is("span")){a.addClass("nosEnhancerInline");a.append(document.createTextNode(" "));if(f&&$.isPlainObject(f.dialog)&&f.dialog.contentUrl){a.append(d)}a.append(e);a.before($("<span> </span>"));a.after($("<span> </span>"))}else{a.addClass("nosEnhancer");a.prepend(g.addClass("nos_enhancer_action_block"));a.prepend(c.addClass("nos_enhancer_action_block"));if(f&&$.isPlainObject(f.dialog)&&f.dialog.contentUrl){a.prepend(d.addClass("nos_enhancer_action_block"))}a.prepend(e.addClass("nos_enhancer_action_block"))}}});tinymce.PluginManager.add("nosenhancer",tinymce.plugins.NosEnhancerPlugin)})();