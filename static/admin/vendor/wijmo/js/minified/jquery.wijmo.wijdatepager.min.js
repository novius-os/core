/*
 *
 * Wijmo Library 2.2.2
 * http://wijmo.com/
 *
 * Copyright(c) GrapeCity, Inc.  All rights reserved.
 * 
 * Dual licensed under the Wijmo Commercial or GNU GPL Version 3 licenses.
 * licensing@wijmo.com
 * http://wijmo.com/license
 *
 *
 **/
(function(a){"use strict";a.widget("wijmo.wijdatepager",{options:{culture:"",localization:null,firstDayOfWeek:0,selectedDate:new Date,viewType:"day",nextTooltip:"right",prevTooltip:"left"},_setOption:function(c,b){a.Widget.prototype._setOption.apply(this,arguments);switch(c){case"culture":this.options.culture=b;this._initBackground();break;case"selectedDate":this.options.selectedDate=b;this._initBackground();break;case"disabled":if(b)this._disable();else this._enable();break;case"viewType":this.options.viewType=b;this._initBackground();break;case"nextTooltip":this.element.find(".wijmo-wijdatepager-increment").attr("title",b);break;case"prevTooltip":this.element.find(".wijmo-wijdatepager-decrement").attr("title",b)}return this},_disable:function(){this.element.addClass("ui-state-disabled");this.element.find(".wijmo-wijdatepager-decrement").button("option","disabled",true);this.element.find(".wijmo-wijdatepager-increment").button("option","disabled",true)},_enable:function(){this.element.removeClass("ui-state-disabled");this.element.find(".wijmo-wijdatepager-decrement").button("option","disabled",false);this.element.find(".wijmo-wijdatepager-increment").button("option","disabled",false)},_create:function(){var b=this.options,c;if(window.wijmoApplyWijTouchUtilEvents)a=window.wijmoApplyWijTouchUtilEvents(a);if(!b.selectedDate)b.selectedDate=new Date;this._dtpagernamespacekey="dtpager"+ +new Date;this.element.addClass("wijmo-wijdatepager ui-widget ui-helper-clearfix");c=a.proxy(this.invalidate,this);a(window).bind("resize."+this._dtpagernamespacekey,c);this.element.disableSelection();this.element.append(a('<a class="wijmo-wijdatepager-decrement"><span>'+b.prevTooltip+"</span></a>")).append('<div class="wijmo-wijdatepager-container ui-widget-content"><div class="wijmo-wijdatepager-pages"></div></div><a class="wijmo-wijdatepager-increment"><span>'+b.nextTooltip+"</span></a>");a.Widget.prototype._create.apply(this,arguments);this.element.find(".wijmo-wijdatepager-decrement").button({icons:{primary:"ui-icon-triangle-1-w"},text:false}).click(a.proxy(this.goLeft,this));this.element.find(".wijmo-wijdatepager-increment").button({icons:{primary:"ui-icon-triangle-1-e"},text:false}).click(a.proxy(this.goRight,this));this._initBackground();b.disabled&&this._disable()},destroy:function(){this.element.removeClass("wijmo-wijdatepager");a(window).unbind("."+this._dtpagernamespacekey)},refresh:function(){this.invalidate()},invalidate:function(){var b,l=this.options.selectedDate,h,f=this.element.find(".wijmo-wijdatepager-container"),j=this.element.find(".wijmo-wijdatepager-decrement"),k=this.element.find(".wijmo-wijdatepager-increment"),c=this.element.innerWidth(),i=j.is(":visible")?j.outerWidth(true):0,m=k.is(":visible")?k.outerWidth(true):0,e,d,g;b=this.element.find(".wijmo-wijdatepager-pagelabel."+this._getDateClass(l));if(b.length!==1)b=a(this.element.find(".wijmo-wijdatepager-pagelabel")[this._index]);else{h=this.element.find(".wijmo-wijdatepager-pagelabel").index(b);this._index=h}this.element.find(".wijmo-wijdatepager-pagelabel.ui-state-active").removeClass("ui-state-active");b.addClass("ui-state-active");f.css("left",i);this.element.removeClass("wijmo-wijdatepager-width-smallest wijmo-wijdatepager-width-small wijmo-wijdatepager-width-medium wijmo-wijdatepager-width-normal");if(c<300)this.element.addClass("wijmo-wijdatepager-width-smallest");else if(c<475)this.element.addClass("wijmo-wijdatepager-width-small");else if(c<600)this.element.addClass("wijmo-wijdatepager-width-medium");else this.element.addClass("wijmo-wijdatepager-width-normal");f.outerWidth(c-i-m);if(a.browser.msie&&parseInt(a.browser.version,10)<=7){e=this.element.find(".wijmo-wijdatepager-pages");d=e.find(".wijmo-wijdatepager-pagelabel");g=parseInt(e.width()/this._datesDef.length)-(d.outerWidth(true)-d.width());d.width(g)}},goLeft:function(){var a=this.options;if(a.disabled)return;this._setSelectedIndex(this._index-1,true)},goRight:function(){var a=this.options;if(a.disabled)return;this._setSelectedIndex(this._index+1)},_getCulture:function(a){return Globalize.findClosestCulture(a||this.options.culture)},_isRTL:function(){return!!this._getCulture().isRTL},_initBackground:function(j,i){var g,d,b,c,e,h,f=this,k;if(this._isInAnimate)return;this._index=0;this._datesDef=this._getDatesDefinition();this._min=0;this._max=this._datesDef.length-1;g="";for(d=0;d<this._datesDef.length;d+=1)g+='<div class="wijmo-wijdatepager-pagelabel'+(d===0?" wijmo-wijdatepager-pagelabel-first":"")+(this._datesDef[d].range?" wijmo-wijdatepager-pagerange":"")+(this._datesDef[d].header?" wijmo-wijdatepager-pageheader ui-state-highlight":"")+(d===this._datesDef.length-1?" wijmo-wijdatepager-pagelabel-last":"")+" "+this._getDateClass(this._datesDef[d].d)+'">'+this._datesDef[d].l+"</div>";c=this.element.find(".wijmo-wijdatepager-pages");if(j){this._isInAnimate=true;b=c.clone(true);c.html(g);e=c.find(".wijmo-wijdatepager-pagelabel");if(!i){b.insertBefore(c);h=a(e[this._index]).offset().left;c.css("opacity",0).css("left",b.outerWidth(true)).stop().animate({left:"0px",opacity:100});b.stop().animate({left:"-"+b.outerWidth(true)+"px",opacity:0},function(){b.remove();f._isInAnimate=false;f.invalidate()})}else{b.insertAfter(c);h=a(e[this._index]).offset().left;c.css("opacity",0).css("left",-b.outerWidth(true)).stop().animate({left:"0px",opacity:100});b.css("left",0).stop().animate({left:b.outerWidth(true)+"px",opacity:0},function(){b.remove();f._isInAnimate=false;f.invalidate()})}}else{c.html(g);this.invalidate()}e=c.find(".wijmo-wijdatepager-pagelabel");e.hover(a.proxy(this._pagelabelHover,this),a.proxy(this._pagelabelHout,this));e.bind("mousedown",a.proxy(this._pagelabelMouseDown,this));e.click(a.proxy(function(d){var c=a(d.target),b;b=this.element.find(".wijmo-wijdatepager-pagelabel").index(c);this._setSelectedIndex(b)},this))},_getDateClass:function(a){return"c1dt"+a.getFullYear()+"_"+a.getMonth()+"_"+a.getDate()},_addDays:function(a,b){return new Date(a.getFullYear(),a.getMonth(),a.getDate()+b)},_getDatesDefinition:function(){var g=this.options,i=g.viewType.toLowerCase(),d,c,b,f,h,e=[],a=g.selectedDate;switch(i){case"week":b=new Date(a.getFullYear(),a.getMonth(),-6);d=g.firstDayOfWeek-b.getDay();if(Math.abs(d)>6)d=b.getDay()-g.firstDayOfWeek;b=this._addDays(b,d);h=new Date(a.getFullYear(),a.getMonth()+1,7);d=0;while(b<h||b.getMonth()===a.getMonth()){f=this._addDays(b,7);e.push({l:this._formatString(this.localizeString("weekViewLabelFormat","{0:MMM dd}-{1:dd}"),b,this._addDays(b,6)),d:b,d2:this._addDays(b,6)});if(a>=b&&a<=f)this._index=d;b=f;d+=1}break;case"month":c=new Date(a.getFullYear()-1,0,1);e.push({l:c.getFullYear(),d:c,range:true});c=new Date(a.getFullYear(),0,1);e.push({l:c.getFullYear(),d:c,header:true});for(d=0;d<12;d+=1){c=new Date(a.getFullYear(),d,1);e.push({l:this._formatString(this.localizeString("monthViewLabelFormat","{0:MMM}"),c),d:c});f=new Date(a.getFullYear(),d+1,1);if(a>=c&&a<=f)this._index=d+2}c=new Date(a.getFullYear()+1,0,1);e.push({l:c.getFullYear(),d:c,range:true});break;default:c=new Date(a.getFullYear(),a.getMonth(),0);e.push({l:Globalize.format(c,"MMM",this._getCulture()),d:c,range:true});c=new Date(a.getFullYear(),a.getMonth(),1);e.push({l:Globalize.format(c,"MMM",this._getCulture()),d:c,header:true});b=c;d=2;while(b.getMonth()===a.getMonth()){f=new Date(b.getFullYear(),b.getMonth(),b.getDate()+1);e.push({l:this._formatString(this.localizeString("dayViewLabelFormat","{0:d }"),b),d:b});if(a>=b&&a<=f)this._index=d;b=f;d+=1}c=new Date(a.getFullYear(),a.getMonth()+1,1);e.push({l:Globalize.format(c,"MMM",this._getCulture()),d:c,range:true})}return e},_setSelectedIndex:function(a,d){var b=this.options,c;if(b.disabled)return;if(a>=this._min&&a<=this._max){this._dragActivated&&this._showTooltip(a);if(this._index!==a){if(this._datesDef[a].header)if(d)a=a-1;else return;this._index=a;c=this._datesDef[a].d;b.selectedDate=c;if(this._max>2&&this._index===0)this._initBackground(true,true);else if(this._index===this._max){if(b.viewType==="week")b.selectedDate=new Date(b.selectedDate.getFullYear(),b.selectedDate.getMonth(),b.selectedDate.getDate()+7);this._initBackground(true,false);b.selectedDate=c}else this.invalidate();this._trigger("selectedDateChanged",null,{selectedDate:b.selectedDate})}}},_pagelabelHover:function(c){var b=a(c.target);if(b.hasClass("wijmo-wijdatepager-pageheader"))return;b.addClass("ui-state-hover")},_showTooltip:function(d){var g=this.options,b=this._datesDef[d],e=g.viewType,c,f=this.element.find(".wijmo-wijdatepager-pagelabel")[d];if(!this._tooltip){this._tooltip=a('<div class="wijmo-wijdatepager-tooltip"><div class="wijmo-wijdatepager-tooltip-inner"></div><div class="wijmo-wijdatepager-triangle"></div></div>');this.element.append(this._tooltip);this._tooltip.wijpopup()}c="";switch(e){case"week":if(b.d.getMonth()!==b.d2.getMonth())c=this._formatString(this.localizeString("weekViewTooltip2MothesFormat","{0:MMMM d} - {1:MMMM d, yyyy}"),b.d,b.d2);else c=this._formatString(this.localizeString("weekViewTooltipFormat","{0:MMMM d} - {1:d, yyyy}"),b.d,b.d2);break;case"month":c=this._formatString(this.localizeString("monthViewTooltipFormat","{0:MMMM yyyy}"),b.d);break;default:c=this._formatString(this.localizeString("dayViewTooltipFormat","{0:dddd, MMMM d, yyyy}"),b.d);break}this._tooltip.wijpopup("show",{of:f,my:"center bottom",at:"center top",offset:"-10 -10"});this._tooltip.find(".wijmo-wijdatepager-tooltip-inner").html(c)},_hideTooltip:function(){this._tooltip.wijpopup("hide")},_pagelabelHout:function(b){a(b.target).removeClass("ui-state-hover")},_pagelabelMouseDown:function(c){this._dragActivated=false;if(this.options.disabled)return;c.preventDefault();var d=a(c.target),b;if(d.hasClass("wijmo-wijdatepager-pageheader"))return;b=this.element.find(".wijmo-wijdatepager-pagelabel").index(d);this._dragActivated=true;this._setSelectedIndex(b);this._mouseDownTimeFix20555=+new Date;this._startClientX=c.pageX;this._startInd=b;a(document).bind("mousemove."+this._dtpagernamespacekey,a.proxy(this._pageindicatorMouseMove,this));a(document).bind("mouseup."+this._dtpagernamespacekey,a.proxy(this._pageindicatorMouseUp,this))},_pageindicatorMouseMove:function(d){d.preventDefault();if(this._isInAnimate)return;var b=this.element.find(".wijmo-wijdatepager-pagelabel")[this._startInd],c,a;if(!b)return;c=b.offsetLeft+Math.round(b.offsetWidth/2)+(d.pageX-this._startClientX);a=this._findClosesPageIndexByPos(c);if(this._prevMoveInd===a)return;this._prevMoveInd=a;if(this._mouseDownTimeFix20555+150>+new Date)return;a!==-1&&a!==this._index&&this._setSelectedIndex(a)},_pageindicatorMouseUp:function(){this._dragActivated=false;a(document).unbind("."+this._dtpagernamespacekey);this._hideTooltip()},_findClosesPageIndexByPos:function(c){for(var b=this.element.find(".wijmo-wijdatepager-pages").find(".wijmo-wijdatepager-pagelabel"),a=0;a<b.length;a+=1)if(b[a].offsetLeft<c&&b[a].offsetLeft+b[a].offsetWidth>c)return a;return-1},localizeString:function(b,c){var a=this.options;return a.localization&&a.localization[b]?a.localization[b]:c},_formatString:function(a){var e,b=arguments,c,d,f=this;if(b.length<=1)return Globalize.format(b);if(typeof a==="string")if(typeof window[a]==="function")a=window[a];if(typeof a==="function"){d=[];for(c=1;c<b.length;c+=1)d[c-1]=b[c];return a.apply(this,d)}e=new RegExp("\\{(\\d+)(?:,([-+]?\\d+))?(?:\\:([^(^}]+)(?:\\(((?:\\\\\\)|[^)])+)\\)){0,1}){0,1}\\}","g");return a.replace(e,function(a,d,g,c){a=b[Number(d)+1];return c?Globalize.format(a,c,f._getCulture()):a})}})})(jQuery);