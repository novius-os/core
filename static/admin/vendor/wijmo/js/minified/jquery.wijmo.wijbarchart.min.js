/*
 *
 * Wijmo Library 2.3.7
 * http://wijmo.com/
 *
 * Copyright(c) GrapeCity, Inc.  All rights reserved.
 * 
 * Licensed under the Wijmo Commercial License. Also available under the GNU GPL Version 3 license.
 * licensing@wijmo.com
 * http://wijmo.com/widgets/license/
 *
 *
 **/
(function(a){"use strict";a.widget("wijmo.wijbarchart",a.wijmo.wijchartcore,{options:{horizontal:true,stacked:false,is100Percent:false,clusterOverlap:0,clusterWidth:85,clusterRadius:0,clusterSpacing:0,animation:{enabled:true,duration:400,easing:">"},seriesTransition:{enabled:true,duration:400,easing:">"},mouseDown:null,mouseUp:null,mouseOver:null,mouseOut:null,mouseMove:null,click:null},widgetEventPrefix:"wijbarchart",_create:function(){var c=this,b=c.options,e=c._getDefFill(),d;if(b.horizontal){d=b.axis.y.compass||"south";b.axis.y.compass=b.axis.x.compass||"west";b.axis.x.compass=d}a.extend(true,{compass:"east"},b.hint);c._hotFixForJQ1_9();a.each(b.seriesStyles,function(b,a){if(!a.fill)a.fill=e[b]});e=null;a.wijmo.wijchartcore.prototype._create.apply(c,arguments);c.chartElement.addClass("wijmo-wijbarchart")},_setOption:function(c,b){c==="horizontal"&&a.extend(true,this.options.axis,{x:{compass:b?"west":"south"},y:{compass:b?"south":"west"}});a.wijmo.wijchartcore.prototype._setOption.apply(this,arguments)},destroy:function(){var e=this,c=e.chartElement,d=c.data("fields"),b=d&&d.bars;c.removeClass("wijmo-wijbarchart");a.wijmo.wijchartcore.prototype.destroy.apply(this,arguments);b&&b.length&&a.each(b,function(b,a){a=null});c.data("fields",null)},_clearChartElement:function(){var b=this,d=b.options,c=b.chartElement.data("fields");a.wijmo.wijchartcore.prototype._clearChartElement.apply(b,arguments);b.element.removeData("plotInfos");if(!d.seriesTransition.enabled)if(c&&c.aniBarsAttr)c.aniBarsAttr=null},_isBarChart:function(){return true},getBar:function(c){var a=this.chartElement,b=a.data("fields");return b.chartElements.bars[c]},_paintTooltip:function(){var c=this,d=c.chartElement,b=d.data("fields");a.wijmo.wijchartcore.prototype._paintTooltip.apply(this,arguments);if(c.tooltip)if(b&&b.trackers&&b.trackers.length){c.tooltip.setTargets(b.trackers);c.tooltip.setOptions({relatedElement:b.trackers[0]})}},_getTooltipText:function(e,d){var c=a(d.node),b,f;if(c.data("owner"))c=c.data("owner");b=c.data("wijchartDataObj");f={data:b,value:b.value,label:b.label,total:b.total,target:d,fmt:e,x:b.x,y:b.y};return a.proxy(e,f)()},_paintPlotArea:function(){var b=this,c=b.options;b.chartElement.wijbar({canvas:b.canvas,bounds:b.canvasBounds,tooltip:b.tooltip,widgetName:b.widgetName,horizontal:c.horizontal,stacked:c.stacked,axis:c.axis,seriesList:c.seriesList,seriesStyles:c.seriesStyles,seriesHoverStyles:c.seriesHoverStyles,seriesTransition:c.seriesTransition,showChartLabels:c.showChartLabels,textStyle:c.textStyle,chartLabelStyle:c.chartLabelStyle,chartLabelFormatString:c.chartLabelFormatString,shadow:c.shadow,disabled:c.disabled,clusterOverlap:c.clusterOverlap,clusterWidth:c.clusterWidth,clusterSpacing:c.clusterSpacing,is100Percent:c.is100Percent,clusterRadius:c.clusterRadius,animation:c.animation,culture:b._getCulture(),isYTime:b.axisInfo.y[0].isTime,isXTime:b.axisInfo.x.isTime,mouseDown:a.proxy(b._mouseDown,b),mouseUp:a.proxy(b._mouseUp,b),mouseOver:a.proxy(b._mouseOver,b),mouseOut:a.proxy(b._mouseOut,b),mouseMove:a.proxy(b._mouseMove,b),click:a.proxy(b._click,b),widget:this})},_showSerieEles:function(b){a.each(b,function(c,b){if(b&&b.bar){b.bar.show();b.bar.shadow&&b.bar.shadow.show();b.bar.tracker&&b.bar.tracker.show();if(a(b.bar.node).data("wijchartDataObj"))a(b.bar.node).data("wijchartDataObj").visible=true}b&&b.dcl&&b.dcl.show();b&&b.animatedBar&&!b.animatedBar.removed&&b.animatedBar.show()})},_hideSerieEles:function(b){a.each(b,function(c,b){if(b&&b.bar){b.bar.hide();b.bar.shadow&&b.bar.shadow.hide();b.bar.tracker&&b.bar.tracker.hide();if(a(b.bar.node).data("wijchartDataObj"))a(b.bar.node).data("wijchartDataObj").visible=false}b&&b.dcl&&b.dcl.hide();b&&b.animatedBar&&!b.animatedBar.removed&&b.animatedBar.hide()})},_indicatorLineShowing:function(b){a.wijmo.wijchartcore.prototype._indicatorLineShowing.apply(this,arguments);a.each(b,function(b,a){a.bar&&a.bar.attr(a.hoverStyle)})},_removeIndicatorStyles:function(b){a.each(b,function(b,a){a.bar&&a.bar.attr(a.style)})},_supportStacked:function(){return true},_calculateParameters:function(c,e){a.wijmo.wijchartcore.prototype._calculateParameters.apply(this,arguments);if(c.id==="x"){var d=e.unitMinor,b=this._getBarAdjustment(c);if(b===0)b=d;else if(d<b&&d!==0)b=Math.floor(b/d)*d;c.min-=b;c.max+=b;this._calculateMajorMinor(e,c)}},_getBarAdjustment:function(e){for(var a=0,h=this.options,g=e.max,b=e.min,d=h.seriesList,c=0,f=0,c=0;c<d.length&&d[c].data.x;c++){f=d[c].data.x.length;if(a<f)a=f}if(a>1)return(g-b)/a*h.clusterWidth*.0125;else if(a===1){if(b===0&&g===1){b=-1;e.min=b}return(g-b)*.0125}else return 0}});function b(c){var b=this;b.x=c;b.paSpec=[];b.stackValues=function(){var d=b.paSpec.length,c;if(d>1){c=b.paSpec[0];a.each(b.paSpec,function(b,a){if(b===0)return true;a.y+=c.y;c=a})}}}a.fn.extend({wijbar:function(c){var E=function(b,d,e){c.shadow&&a.wijchart.paintShadow(b,d,e)},v=a.wijraphael.addClass,F=a.wijchart.getScaling,B=a.wijchart.getTranslation,f=this,e=c.canvas,i=c.widgetName,d=c.horizontal,m=c.stacked,u=a.arrayClone(c.seriesList),w=u.length,D=[].concat(c.seriesStyles.slice(0,w)),A=[].concat(c.seriesHoverStyles.slice(0,w)),s=c.bounds,r=c.animation,J=r&&r.enabled,q={x:s.startX,y:s.startY},O=s.endX-q.x,M=s.endY-q.y,n=c.axis.x,y=c.axis.y,l=c.disabled,G=c.mouseDown,L=c.mouseUp,I=c.mouseOver,K=c.mouseOut,H=c.mouseMove,N=c.click,x=F(d,n.max,n.min,d?M:O),P=B(d,q,n.max,n.min,x),t,z,g=f.data("fields")||{},p=g.chartElements||{},k=g.aniBarsAttr,h,bb=c.isYTime,ab=c.isXTime,Z=c.culture,j=c.widget;function X(d){for(var a=Number.MAX_VALUE,e=d.length,c,b=1;b<e;b++){c=d[b].x-d[b-1].x;if(c<a&&c>0)a=c}return a===Number.MAX_VALUE?2:a}function W(b){a.each(b,function(b,a){a.stackValues()});return b}function C(f){var c=[],d=a.wijchart.getXSortedPoints;function e(n,m){var h=d(m),l=m.length,f=null,o=0,e=0,g=0,k=true,i=0,j=false;if(h)o=h.length;if(c)g=c.length;if(h===undefined)return;a.each(h,function(d,a){if(k){k=false;i=a.x}else{if(i===a.x)j=true;else j=false;i=a.x}while(e<g&&c[e].x<a.x)e++;if(e<g)if(c[e].x!==a.x){f=new b(a.x,l);c.splice(e,0,f);g=c.length}else f=c[e];else{f=new b(a.x,l);c.push(f);g=c.length}f.paSpec.push({y:a.y,sIdx:n,pIdx:d,dupl:j})})}a.each(f,function(b,a){e(b,a)});return c}function o(a,c,b){return a<c?c:a>b?b:a}function S(c,d,e,f,g,b){a.each(b,function(j,a){var h=a.x,i=a.y,b=0;a.x=d*h+f;a.y=e*i+g;if(c){b=a.x;a.x=a.y;a.y=b}});return b}function Q(b,n,m,l){var i=a.extend(true,{},c.textStyle,c.chartLabelStyle),h=d?{x:b.x+b.width,y:b.y+b.height/2}:{x:b.x+b.width/2,y:b.y},k=c.chartLabelFormatString,j,f,g=n;if(l)i=a.extend(true,i,l);if(m)g=a.fromOADate(n);if(k&&k.length)g=Globalize.format(g,c.chartLabelFormatString,Z);else if(!m)g=a.round(g,2);f=e.text(h.x,h.y,g).attr(i);v(a(f.node),"wijbarchart-label");j=f.getBBox();if(d)f.attr({x:h.x+j.width/2});else f.attr({y:h.y-j.height/2});return f}function Y(j,r,P,v,w,s,H,F,D,M,p,C,O,L,t){var N=c.is100Percent,z=v.min,y=v.max,B=w.min,A=w.max,T=v.scale,U=v.late,I=w.scale,K=w.late,x,f,G,b,u=null,g,J=s,n=s["stroke-width"],R=s.stroke,h,k,i,l,q=-1;if(t.origin!==null)q=I*t.origin+K;if(m)if(N){if(C>0)j.height=r/C;if(p||p===0){j.y=p/C;j.height-=j.y}}else{j.height=r;if(p||p===0){j.height-=p;j.y=p}}else if(p||p===0){j.x+=j.width*(1-M);j.height=r}f=[{x:j.x,y:j.y},{x:j.x+j.width,y:j.y+j.height}];G=(z<=f[0].x&&f[0].x<=y||z<=f[1].x&&f[1].x<=y)&&(B<=f[0].y&&f[0].y<=A||B<=f[1].y&&f[1].y<=A);f[0].x=o(f[0].x,z,y);f[0].y=o(f[0].y,B,A);f[1].x=o(f[1].x,z,y);f[1].y=o(f[1].y,B,A);f=S(d,T,I,U,K,f);if(f[0].x>f[1].x){x=f[0].x;f[0].x=f[1].x;f[1].x=x}if(f[0].y>f[1].y){x=f[0].y;f[0].y=f[1].y;f[1].y=x}b={x:f[0].x,y:f[0].y,width:f[1].x-f[0].x,height:f[1].y-f[0].y};if(G){if(b.width===0)b.width=1;if(b.height===0){b.height=1;b.y-=1}}if(c.showChartLabels)u=Q(b,r,O,L);g=s.r?s.r:c.clusterRadius;if(g)J=a.extend(true,{},s,{r:0});if(R!=="none"&&n)n=parseInt(n,10);if(!n||isNaN(n))n=0;k=b.width;i=b.height;if(n>1){n--;k=b.width-n;i=b.height-n/2;b.x+=n/2}if(k<0)k=0;if(i<0)i=0;if(H){if(q===-1)if(d)q=D.x+n/2;else q=D.y+P-n/2;if(g){if(d){if(r>t.origin)h=e.roundRect(b.x,b.y,k,i,0,0,g,g).hide();else h=e.roundRect(b.x,b.y,k,i,g,g,0,0).hide();l=e.rect(q,b.y,0,i)}else{if(r>t.origin)h=e.roundRect(b.x,b.y,k,i,g,0,0,g).hide();else h=e.roundRect(b.x,b.y,k,i,0,g,g,0).hide();l=e.rect(b.x,q,b.width,0)}E(l,F);l.wijAttr(J);l.bar=h}else{if(d)h=e.rect(q,b.y,0,i);else h=e.rect(b.x,q,k,0);l=h}if(u){u.attr({opacity:0});l.chartLabel=u}l.left=b.x;l.top=b.y;l.width=k;l.height=i;l.r=g}else if(g)if(d)if(r>t.origin)h=e.roundRect(b.x,b.y,k,i,0,0,g,g);else h=e.roundRect(b.x,b.y,k,i,g,g,0,0);else if(r>t.origin)h=e.roundRect(b.x,b.y,k,i,g,0,0,g);else h=e.roundRect(b.x,b.y,k,i,0,g,g,0);else h=e.rect(b.x,b.y,k,i);E(h,F);if(H&&g)h.shadow&&h.shadow.hide();h.wijAttr(s);return{rect:b,dcl:u,animatedBar:l,bar:h}}function U(k,M,I,N,A,G,s,u,q,D){var f=c.clusterOverlap/100,L=c.clusterWidth/100,x=1,K=c.clusterSpacing+x,r=k.length,b,h,g,n=[],H=[],w=[],l=[],E=[],i=[],p=e.set(),o;if(q||D){a.each(k,function(d,c){var b=a.extend(true,{},c);b.data&&b.data.y&&b.data.y.length&&q&&a.each(b.data.y,function(d,c){b.data.y[d]=a.toOADate(c)});b.data&&b.data.x&&b.data.x.length&&D&&a.each(b.data.x,function(d,c){b.data.x[d]=a.toOADate(c)});E.push(b)});b=C(E)}else b=C(k);if(m)b=W(b);h=X(b)*L;if(r>1&&!m){f-=b.length*(r-1)*K/(d?s:G);h/=r*(1-f)+f}a.each(b,function(L,E){var r=E.paSpec,K=r.length,D,C,e,b;if(m)D=h;else D=h*(K*(1-f)+f);C={x:E.x-D/2,y:0,width:h,height:r[0].y};a.each(r,function(R,O){if(C.height===undefined)return true;var h=O.sIdx,K=O.pIdx,P=M[h],D=k[h],m,Q=D.yAxis||0,E=y[Q]||y,L=A[Q]||A;if(!l[h])l[h]=[];if(!i[h])i[h]=[];t=F(!d,E.max,E.min,d?G:s);z=B(!d,u,E.max,E.min,t);L.late=z;L.scale=t;b=Y(C,O.y,s,N,L,P,J,x,u,f,R>0?r[R-1].y:null,r[r.length-1].y,q,D.textStyle,E);e=b.bar;m=e.clone().attr({opacity:.01,fill:"white","stroke-width":0,"fill-opacity":.01});if(D.visible===false){e.hide();b.dcl&&b.dcl.hide();m.hide();e.shadow&&e.shadow.hide()}v(a(e.node),"wijchart-canvas-object wijbarchart");o=a.extend(false,{index:K,bar:e,type:"bar",style:P,hoverStyle:I[h],x:D.data.x[K],y:D.data.y[K],visible:true},D);a(e.node).data("wijchartDataObj",o);j.dataPoints=j.dataPoints||{};j.pointXs=j.pointXs||[];if(c.horizontal)g=a.round(b.rect.y+b.rect.height/2,2);else g=a.round(b.rect.x+b.rect.width/2,2);if(!j.dataPoints[g.toString()]){j.dataPoints[g.toString()]=[];j.pointXs.push(g)}j.dataPoints[g.toString()].push(o);a(m.node).data("owner",a(e.node));v(a(m.node),"wijbarchart bartracker");b.bar.tracker=m;p.push(m);H.push(e);b.animatedBar&&w.push(b.animatedBar);b.dcl&&n.push(b.dcl);l[h][K]=b.rect;i[h][K]=b;e=null;m=null})});a.each(n,function(b,a){a.toFront()});p.toFront();return{bars:H,animatedBars:w,rects:l,chartLabels:n,seriesEles:i,trackers:p}}function V(j){var e=c.seriesTransition,f,h,i=[],b;if(J){f=r.duration||2e3;h=r.easing||"linear";a.each(j,function(g,c){var j=d?{width:c.width,x:c.left}:{height:c.height,y:c.top};if(k&&e.enabled)if(k.length>g){b=a.wijchart.getDiffAttrs(k[g],c.attr());if(d){b.x=k[g].x;b.width=k[g].width}else{b.y=k[g].y;b.height=k[g].height}if(b.path)delete b.path;c.attr(b);f=e.duration;h=e.easing}i.push(a.extend(true,{},c.attr(),j));c.tracker&&c.tracker.hide();c.stop().wijAnimate(j,f,h,function(){var a=this,c=a.r,b=a;a.chartLabel&&a.chartLabel.wijAnimate({opacity:1},250);if(a.tracker){a.tracker.show();a.tracker.attr({width:a.width,height:a.height,x:a.attr("x"),y:a.attr("y")})}if(c){b=a.bar;b.show();b.shadow&&b.shadow.show();if(a.shadow){a.shadow.wijRemove();a.shadow=null}a.wijRemove();a=null}})});g.aniBarsAttr=i}}function T(){var b=a.isFunction;a(".wijbarchart",f[0]).live("mousedown."+i,function(e){if(l)return;if(b(G)){var c=a(e.target),d;if(c.data("owner"))c=c.data("owner");d=c.data("wijchartDataObj");G.call(f,e,d);d=null}}).live("mouseup."+i,function(e){if(l)return;if(b(L)){var c=a(e.target),d;if(c.data("owner"))c=c.data("owner");d=c.data("wijchartDataObj");L.call(f,e,d);d=null}}).live("mouseover."+i,function(e){if(l)return;if(b(I)){var c=a(e.target),d;if(c.data("owner"))c=c.data("owner");d=c.data("wijchartDataObj");I.call(f,e,d);d=null}}).live("mouseout."+i,function(g){if(l)return;var d=a(g.target),c,e;if(d.data("owner"))d=d.data("owner");c=d.data("wijchartDataObj");e=c.bar;if(!c.hoverStyle)e&&e.attr({opacity:"1"});else e.attr(c.style);b(K)&&K.call(f,g,c);c=null}).live("mousemove."+i,function(g){if(l)return;var d=a(g.target),c,e;if(d.data("owner"))d=d.data("owner");c=d.data("wijchartDataObj");e=c.bar;if(!c.hoverStyle)e&&e.attr({opacity:"0.8"});else e.attr(c.hoverStyle);b(H)&&H.call(f,g,c);c=null}).live("click."+i,function(e){if(l)return;if(b(N)){var c=a(e.target),d;if(c.data("owner"))c=c.data("owner");d=c.data("wijchartDataObj");N.call(f,e,d)}})}function R(){a(".wijbarchart",f[0]).die(i).die("."+i)}R();if(d&&!m){u.reverse();D.reverse();A.reverse()}if(w===0)return;h=U(u,D,A,{min:n.min,max:n.max,late:P,scale:x},y,O,M,q,bb,ab);f.data("plotInfos",{xscale:x,xlate:P,yscale:t,ylate:z,rects:h.rects});V(h.animatedBars);p.bars=h.bars;p.animatedBars=h.animatedBars;p.chartLabels=h.chartLabels;g.seriesEles=h.seriesEles;g.trackers=h.trackers;if(!g.chartElements)g.chartElements={};d&&!m&&g.seriesEles.reverse();a.extend(true,g.chartElements,p);f.data("fields",g);T()}})})(jQuery);