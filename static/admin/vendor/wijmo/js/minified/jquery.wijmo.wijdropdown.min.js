(function(a){a.widget("wijmo.wijdropdown",{options:{zIndex:1000,showingAnimation:{effect:"blind"},hidingAnimation:{effect:"blind"}},hoverClass:"ui-state-hover",activeClass:"ui-state-active",focusClass:"ui-state-focus",_setOption:function(b,c){a.Widget.prototype._setOption.apply(this,arguments);if(b==="disabled"){this._labelWrap.toggleClass("ui-state-disabled",c);this._label.toggleClass("ui-state-disabled",c);this.element.attr("disabled",c?"disabled":"")}},_create:function(){var b=this,c=b.element;if(window.wijmoApplyWijTouchUtilEvents){a=window.wijmoApplyWijTouchUtilEvents(a)}if(c.get(0).tagName.toLowerCase()!=="select"){return}if(c.is(":visible")){b._activeItem=null;b._createSelect();b._bindEvents();b.needInit=false}else{b.needInit=true}if(b.element.is(":hidden")&&b.element.wijAddVisibilityObserver){b.element.wijAddVisibilityObserver(function(){b.refresh();if(b.element.wijRemoveVisibilityObserver){b.element.wijRemoveVisibilityObserver()}},"wijdropdown")}},_createSelect:function(){var k=this,l=k.element,c=l.outerWidth(),e=c,d=l.wrap("<div></div>").parent().addClass("ui-helper-hidden"),b=d.wrap("<div></div>").parent().attr("role","select").addClass("wijmo-wijdropdown ui-widget ui-widwijmo-wijdropdownt-content ui-state-default ui-corner-all ui-helper-clearfix"),j=a('<label class="wijmo-dropdown-label ui-corner-all"></label>').attr("id",l.get(0).id+"_select").attr("name",l.attr("name")||""),i=a("<div></div>").addClass("wijmo-dropdown-trigger ui-state-default ui-corner-right"),f=a('<a href="#"></a>'),h=a("<div>").addClass("wijmo-dropdown"),g=a("<ul></ul>").addClass("wijmo-dropdown-list ui-widget-content ui-widget ui-corner-all ui-helper-reset").appendTo(h);a("<span></span>").addClass("ui-icon ui-icon-triangle-1-s").appendTo(i);c=Math.max(c,b.width());if(l.get(0).tabIndex!==""){f.attr("tabindex",l.attr("tabindex"))}if(l.get(0).disabled!==false){k.options.disabled=true;f.addClass("ui-state-disabled");j.addClass("ui-state-disabled")}f.append(j);b.append(d).append(f).append(i).append(h);e+=parseInt(j.css("padding-left").replace(/px/,""),10);e+=parseInt(j.css("padding-right").replace(/px/,""),10);e-=16;b.width(e);k._buildList(g,h,e);k._rightTrigger=i;k._label=j;k._listContainer=h;k._list=g;k._value=l.val();k._selectedIndex=a("option",l).index(l.find("option:selected"));k._selectWrap=d;k._labelWrap=f;k._container=b;b.attr("title",l.attr("title"));l.removeAttr("title")},_buildList:function(f,g,d){var c=this,e=c.element,b;g.show();e.children().each(function(h,o){var k=a(o),m,j,l;if(k.is("option")){f.append(c._buildItem(k))}else{m=a('<li class="wijmo-dropdown-optgroup"></li>');j=a("<span>"+k.attr("label")+"</span>").addClass("wijmo-optgroup-header ui-priority-primary");l=a("<ul></ul>").addClass("ui-helper-reset wijmo-dropdown-items");k.children("option").each(function(){l.append(c._buildItem(a(this)))});m.append(j).append(l);f.append(m)}});g.height("");b=g.height();b=f.outerHeight()<b?f.outerHeight():b;g.css({height:b,width:d});f.setOutWidth(f.parent().parent().innerWidth()-18);if(g.data("wijsuperpanel")){g.wijsuperpanel("paintPanel");c.superpanel=g.data("wijsuperpanel")}else{c.superpanel=g.wijsuperpanel().data("wijsuperpanel")}if(a.fn.bgiframe){c.superpanel.element.bgiframe()}if(!c.superpanel.vNeedScrollBar){f.setOutWidth(f.parent().parent().innerWidth());c.superpanel.refresh()}g.hide()},_handelEvents:function(e){var b=this,d="."+b.widgetName,c=b.element;e.bind("click"+d,function(f){if(b.options.disabled){return}if(b._listContainer.is(":hidden")){b._show()}else{b._hide()}c.click();if(e.get(0)===b._label.get(0)){f.preventDefault()}else{b._labelWrap.focus()}}).bind("mouseover"+d,function(){if(b.options.disabled){return}b._label.addClass(b.hoverClass);b._rightTrigger.addClass(b.hoverClass);c.trigger("mouseover")}).bind("mouseout"+d,function(){if(b.options.disabled){return}b._label.removeClass(b.hoverClass);b._rightTrigger.removeClass(b.hoverClass);c.trigger("mouseout")}).bind("mousedown"+d,function(){if(b.options.disabled){return}b._label.addClass(b.activeClass);b._rightTrigger.addClass(b.activeClass);c.trigger("mousedown")}).bind("mouseup"+d,function(){if(b.options.disabled){return}b._label.removeClass(b.activeClass);b._rightTrigger.removeClass(b.activeClass);c.trigger("mouseup")})},_bindEvents:function(){var c=this,e="."+c.widgetName,d=c._label,g=c._rightTrigger,b=c._labelWrap,i=c._listContainer,f=c.element,h;c._handelEvents(c._label);c._handelEvents(c._rightTrigger);a(document.body).bind("click"+e,function(j){if(i.is(":hidden")){return}h=i.offset();if(j.target===d.get(0)||j.target===g.get(0)||j.target===g.children().get(0)){return}if(j.pageX<h.left||j.pageX>h.left+i.width()||j.pageY<h.top||j.pageY>h.top+i.height()){c._hide()}});i.bind("click"+e,function(k){var j=a(k.target);if(j.closest("li.wijmo-dropdown-item",a(this)).length>0){c._setValue();i.css("z-index","");if(a.browser.msie&&/^[6,7].[0-9]+/.test(a.browser.version)){i.parent().css("z-index","")}i.hide();c._setValueToEle()}f.click()});b.bind("keydown"+e,function(k){if(c.options.disabled){return}var j=a.ui.keyCode;switch(k.which){case j.UP:case j.LEFT:c._previous();c._setValue();c._setValueToEle();break;case j.DOWN:case j.RIGHT:c._next();c._setValue();c._setValueToEle();break;case j.PAGE_DOWN:c._nextPage();c._setValue();c._setValueToEle();break;case j.PAGE_UP:c._previousPage();c._setValue();c._setValueToEle();break;case j.ENTER:case j.NUMPAD_ENTER:c._setValue();c._listContainer.hide();c._setValueToEle();break}if(k.which!==j.TAB){k.preventDefault()}f.trigger("keydown")}).bind("focus"+e,function(){if(c.options.disabled){return}d.addClass(c.focusClass);g.addClass(c.focusClass);f.focus()}).bind("blur"+e,function(){if(c.options.disabled){return}d.removeClass(c.focusClass);g.removeClass(c.focusClass);f.trigger("blur")}).bind("keypress"+e,function(){if(c.options.disabled){return}f.trigger("keypress")}).bind("keyup"+e,function(){if(c.options.disabled){return}f.trigger("keyup")})},_init:function(){var b=this;b._initActiveItem();if(b._activeItem){b._label.text(b._activeItem.text())}},_buildItem:function(c){var e=c.val(),d=c.text(),b=this,f;if(d===""){d="&nbsp;"}f=a('<li class="wijmo-dropdown-item ui-corner-all"><span>'+d+"</span></li>").mousemove(function(g){var h=a(g.target).closest(".wijmo-dropdown-item");if(h!==this.last){b._activate(a(this))}this.last=a(g.target).closest(".wijmo-dropdown-item")}).attr("role","option");f.data("value",e);return f},_show:function(){var b=this,d=b._listContainer,c=b.options.showingAnimation;d.css("z-index","100000");if(a.browser.msie&&/^[6,7]\.[0-9]+/.test(a.browser.version)){d.parent().css("z-index","99999")}if(c){d.show(c.effect,c.options,c.speed,function(){b._initActiveItem()})}else{d.show()}},_hide:function(){var b=this,d=b._listContainer,c=b.options.hidingAnimation;if(d.is(":hidden")){return}if(c){d.hide(c.effect,c.options,c.speed,function(){if(a.isFunction(c.callback)){c.callback.apply(b,arguments)}if(a.browser.msie&&/^[6,7]\.[0-9]+/.test(a.browser.version)){d.parent().css("z-index","")}d.css("z-index","")})}else{if(a.browser.msie&&a.browser.version==="6.0"){d.parent().css("z-index","")}d.css("z-index","");d.hide()}},_setValue:function(){var c=this,e=c._listContainer,d,b;if(c._activeItem){c._label.text(c._activeItem.text());c._value=c._activeItem.data("value");c._selectedIndex=a("li.wijmo-dropdown-item",e).index(c._activeItem);if(c.superpanel.vNeedScrollBar){d=c._activeItem.offset().top;b=c._activeItem.outerHeight();if(e.offset().top>d){e.wijsuperpanel("scrollTo",0,d-c._list.offset().top)}else{if(e.offset().top<d+b-e.innerHeight()){e.wijsuperpanel("scrollTo",0,d+b-e.height()-c._list.offset().top)}}}}},_setValueToEle:function(){var c=this,d=c.element,f=d.find("option[selected]"),e=a("option",d).index(f),b=c._selectedIndex;if(e!==b){d.find("option:eq("+b+")").attr("selected",true);f.removeAttr("selected");d.trigger("change")}},_initActiveItem:function(){var b=this;if(b._value!==undefined){if(b._selectedIndex===-1){b._activate(b._list.find("li.wijmo-dropdown-item").eq(0));return}b._list.find("li.wijmo-dropdown-item").each(function(c){if(c===b._selectedIndex){b._activate(a(this));return false}})}},_activate:function(c){var b=this;b._deactivate();b._activeItem=c;b._activeItem.addClass(b.hoverClass).attr("aria-selected",true)},_deactivate:function(){var b=this;if(b._activeItem){b._activeItem.removeClass(b.hoverClass).attr("aria-selected",false)}},_next:function(){this._move("next","first")},_previous:function(){this._move("prev","last")},_nextPage:function(){this._movePage("first")},_previousPage:function(){this._movePage("last")},refresh:function(){var b=this,d=b.element,c;if(b.needInit){if(b.element.is(":visible")){b._activeItem=null;b._createSelect();b._bindEvents();b._init();b.needInit=false}}else{if(!b._list){return}b._listContainer.show();b._selectWrap.removeClass("ui-helper-hidden");c=b.element.outerWidth();c+=parseInt(b._label.css("padding-left").replace(/px/,""),10);c+=parseInt(b._label.css("padding-right").replace(/px/,""),10);c-=16;b._container.width(c);b._selectWrap.addClass("ui-helper-hidden");b._list.empty();b._buildList(b._list,b._listContainer,c);b._value=b.element.val();b._selectedIndex=a("option",d).index(d.find("option:selected"));b._initActiveItem();if(b._activeItem){b._label.text(b._activeItem.text())}}},_move:function(e,d){var b=this,f,c;if(!b._activeItem){b._activate(b._list.find(".wijmo-dropdown-item:"+d));return}f=b._activeItem[e]().eq(0);if(f.length){c=b._getNextItem(f,e,d)}else{if(b._activeItem.closest(".wijmo-dropdown-optgroup").length){c=b._getNextItem(b._activeItem.closest(".wijmo-dropdown-optgroup")[e](),e,d)}}if(c&&c.length){b._activate(c)}else{b._activate(b._list.find(".wijmo-dropdown-item:"+d))}},_movePage:function(g){var e=this,f,c,b,d=g==="first"?"last":"first";if(e.superpanel.vNeedScrollBar){f=e._activeItem.offset().top;c=e.options.height;b=e._list.find(".wijmo-dropdown-item").filter(function(){var i=a(this).offset().top-f+(g==="first"?-c:c)+a(this).height(),h=a(this).height();return i<h&&i>-h});if(!b.length){b=e._list.find(".wijmo-dropdown-item:"+d)}e._activate(b)}else{e._activate(e._list.find(".wijmo-dropdown-item:"+(!e._activeItem?g:d)))}},_getNextItem:function(b,d,c){if(b.length){if(b.is(".wijmo-dropdown-optgroup")){if(!!b.find(">ul>li.wijmo-dropdown-item").length){return b.find(">ul>li.wijmo-dropdown-item:"+c).eq(0)}else{this._getNextItem(b[d]().eq(0))}}else{return b}}},destroy:function(){this.element.attr("title",this._container.attr("title"));this.element.closest(".wijmo-wijdropdown").find(">div.wijmo-dropdown-trigger,>div.wijmo-dropdown,>a").remove();this.element.unwrap().unwrap().removeData("maxZIndex");a.Widget.prototype.destroy.apply(this)}})}(jQuery));