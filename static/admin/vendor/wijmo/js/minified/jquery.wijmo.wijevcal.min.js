/*
 *
 * Wijmo Library 2.3.7
 * http://wijmo.com/
 *
 * Copyright(c) GrapeCity, Inc.  All rights reserved.
 * 
 * Licensed under the Wijmo Commercial License. Also available under the GNU GPL Version 3 license.
 * licensing@wijmo.com
 * http://wijmo.com/widgets/license/
 *
 *
 **/
(function(a){"use strict";function b(a){return new Date(a.getFullYear(),a.getMonth(),a.getDate())}function h(){var b,c,a;b="";for(a=0;a<32;a+=1){if(a===8||a===12||a===16||a===20)b=b+"-";c=Math.floor(Math.random()*16).toString(16).toUpperCase();b=b+c}return b}var e,i="C1EventsCalendarDB",j="1.1",f=false,c;function g(b,d,a){if(f){c=amplify.store("wijevcal_tables1");if(!c)c={};if(!c[b]){c[b]={fields:d};amplify.store("wijevcal_tables1",c);amplify.store("wijevcal_tbl_"+b,{})}a&&a()}else e&&e.transaction(function(c){c.executeSql("SELECT COUNT(*) FROM "+b,[],function(){a&&a()},function(c){c.executeSql("CREATE TABLE "+b+" "+d,[],a,a)})})}function d(j,m,o,l){var n={rowsAffected:0,rows:[]},k,a,p,s,r,b,i,t,d,u,q,v,g,h;if(!m)m=[];if(!n.rows.item)n.rows.item=function(a){return this[a]};if(f)try{p=new RegExp("(SELECT) *(.*) *FROM (\\w+)");s=new RegExp("(INSERT OR REPLACE|INSERT) *(.*) *INTO *(\\w*) *\\(([\\w|,| ]*)\\)");r=new RegExp("(DELETE) *(.*) *FROM (\\w+) *(\\w*)WHERE (\\w+)='*([^']+)");if(j.match(s)){b=s.exec(j);if(b&&b.length>1){i=b[3];t=c[i];d=amplify.store("wijevcal_tbl_"+i);if(d){q=b[4].split(",");k={};for(a=0;a<q.length;a+=1)if(q[a]){if(a===0)d[m[a]]=k;v=q[a].replace(" ","");k[v]=m[a]}}amplify.store("wijevcal_tbl_"+i,d)}}else if(j.match(p)){b=p.exec(j);if(b&&b.length>1){i=b[3];t=c[i];d=amplify.store("wijevcal_tbl_"+i);if(d){g=j.replace(p,"");if(g.toUpperCase().indexOf(" WHERE ")===0){g=g.substr(7);h=g.split(" OR ");for(a=0;a<h.length;a+=1){h[a]=h[a].split("=");g=h[a][1];if(g.indexOf("'")===0){g=g.substring(1,g.length-1);h[a][1]=g}else h[a][1]=parseFloat(g)}}for(u in d)if(d.hasOwnProperty(u)){k=d[u];if(k)if(h)for(a=0;a<h.length;a+=1)k[h[a][0]]===h[a][1]&&n.rows.push(k);else n.rows.push(k)}}}}else if(j.match(r)){b=r.exec(j);if(b&&b.length>1){i=b[3];t=c[i];d=amplify.store("wijevcal_tbl_"+i);if(d)if(d[b[6]])delete d[b[6]];amplify.store("wijevcal_tbl_"+i,d)}}o&&o(n)}catch(w){l&&l(w)}else{if(!e){l("Local data storage not found.");return}e.transaction(function(a){a.executeSql(j,m,function(b,a){o&&o(a)},function(b,a){l&&l(a.message);return})})}}a.widget("wijmo.wijevcal",{widgetEventPrefix:"wijevcal",options:{culture:"",localization:null,datePagerLocalization:null,readOnly:false,webServiceUrl:"",colors:null,dataStorage:{addEvent:null,updateEvent:null,deleteEvent:null,loadEvents:null,addCalendar:null,updateCalendar:null,deleteCalendar:null,loadCalendars:null},dataSource:null,eventsData:[],appointments:[],calendars:[],disabled:false,editCalendarTemplate:"",enableLogs:false,eventTitleFormat:"{2}",titleFormat:{day:false,week:"_formatWeekTitle",month:"_formatMonthTitle",list:false},firstDayOfWeek:0,headerBarVisible:true,navigationBarVisible:true,rightPaneVisible:false,selectedDate:null,selectedDates:null,statusBarVisible:false,timeInterval:30,timeIntervalHeight:15,timeRulerInterval:60,timeRulerFormat:"{0:h tt}",dayHeaderFormat:"{0:d }",firstRowDayHeaderFormat:"{0:ddd d}",dayViewHeaderFormat:{day:"all-day events",week:"{0:d dddd}",list:"{0:d dddd}"},viewType:"day",visibleCalendars:["Default"]},_setOption:function(e,c){var d=this.options;switch(e){case"dataSource":d.dataSource=c;this._bindDataView();break;case"eventsData":d.eventsData=c;d.appointments=c;this._onEventsDataChanged();break;case"appointments":d.eventsData=c;d.appointments=c;this._onEventsDataChanged();break;case"culture":d.culture=c;this.element.find(".wijmo-wijdatepager").wijdatepager("option","culture",d.culture);this._editEventDialog&&this._editEventDialog.find(".wijmo-wijinput-date").wijinputdate("option","culture",d.culture);this.element.find(".wijmo-wijcalendar").wijcalendar("option","culture",d.culture);this._redrawActiveView();break;case"disabled":if(d.disabled!==c){d.disabled=c;this._ensureDisabled()}break;case"enableLogs":d.enableLogs=c;this._initLogPanel();break;case"selectedDate":if(c){c=b(c);if(d.selectedDates[0].getTime()!==c.getTime()){d.selectedDates[0]=c;this._onSelectedDatesChanged()}}return;case"selectedDates":if(c){d.selectedDates=c;this._onSelectedDatesChanged()}return;case"statusBarVisible":d.statusBarVisible=c;this._initStatusbar();this.invalidate();return;case"headerBarVisible":d.headerBarVisible=c;this._initHeaderbar();this.invalidate();return;case"navigationBarVisible":d.navigationBarVisible=c;this._initNavigationbar();this.invalidate();return;case"rightPaneVisible":d.rightPaneVisible=c;this._initRightPane();this.invalidate();return;case"timeInterval":if(d.timeInterval!==c){d.timeInterval=c;this._redrawActiveView()}break;case"timeIntervalHeight":if(d.timeIntervalHeight!==c){d.timeIntervalHeight=c;this._redrawActiveView()}break;case"timeRulerInterval":if(d.timeRulerInterval!==c){d.timeRulerInterval=c;this._redrawActiveView()}break;case"viewType":if(d.viewType!==c){d.viewType=c;this._onViewTypeChanged()}}a.Widget.prototype._setOption.apply(this,arguments)},_ensureDisabled:function(){var a=this.options;if(a.disabled){this.element.addClass("ui-state-disabled");try{this.element.find(".wijmo-wijcalendar").wijcalendar("option","disabled",true);this.element.find(".wijmo-wijsuperpanel").wijsuperpanel("option","disabled",true);this.element.find(".wijmo-wijdatepager").wijdatepager("option","disabled",true);this.element.find(".ui-buttonset").buttonset("option","disabled",true);this.element.find(".wijmo-wijev-today.ui-button").button("option","disabled",true)}catch(b){this.log(b,"error")}this._unbindEvents()}else{this.element.removeClass("ui-state-disabled");try{this.element.find(".wijmo-wijcalendar").wijcalendar("option","disabled",false);this.element.find(".wijmo-wijsuperpanel").wijsuperpanel("option","disabled",false);this.element.find(".wijmo-wijdatepager").wijdatepager("option","disabled",false);this.element.find(".ui-buttonset").buttonset("option","disabled",false);this.element.find(".wijmo-wijev-today.ui-button").button("option","disabled",false)}catch(b){this.log(b,"error")}this._bindEvents();this._updateTitleText()}},_onViewTypeChanged:function(){this._renderActiveView();this._updateTitleText();this._trigger("viewTypeChanged",null,this.options.viewType);this.element.find(".wijmo-wijev-datepager").wijdatepager("option","viewType",this.options.viewType)},_onSelectedDatesChanged:function(){var a=this.options;a.selectedDate=a.selectedDates[0];this.element.find(".wijmo-wijev-datepager").wijdatepager("option","selectedDate",a.selectedDate);this._trigger("selectedDatesChanged",null,{selectedDates:a.selectedDates});this._renderActiveView();this._updateTitleText()},_updateHeaderTitleText:function(){var a=this.options,b=a.titleFormat,c=a.selectedDates[0],d=a.selectedDates[a.selectedDates.length-1];if(b[a.viewType])b=b[a.viewType];else if(b[a.viewType]===false){this.element.find(".wijmo-wijev-view .wijmo-wijev-header-title").hide();return}else b=b.toString();if(a.viewType==="list")d=this._addDays(c,14);this.element.find(".wijmo-wijev-view .wijmo-wijev-header-title").show().html(this._formatString(b,c,d))},_updateTitleText:function(){var b=this.options,d=b.selectedDates[0],e=b.selectedDates[b.selectedDates.length-1],a=new Date,c=false;c=this._compareDayDates(d,a)===0||d<a&&e>a;this.element.find(".wijmo-wijev-navigationbar .wijmo-wijev-today").button("option","disabled",c);this._updateHeaderTitleText()},localizeString:function(b,c){var a=this.options;return a.localization&&a.localization[b]?a.localization[b]:c},_create:function(){if(a.isFunction(window.wijmoApplyWijTouchUtilEvents))a=window.wijmoApplyWijTouchUtilEvents(a);a.isFunction(window.wijmoASPNetParseOptions)&&wijmoASPNetParseOptions(this.options);var d,c,b=this.options;if(!b.colors)b.colors=["red","darkorchid","green","blue","cornflowerblue","yellow","bronze"];if(!this.wijevcalnamespacekey)this.wijevcalnamespacekey="wijevcal"+ +new Date;if(!this.element[0].id)this.element[0].id="wijevcal_dynid_"+ +new Date;this._uidPref=this.element[0].id+"evcdynid";this.element.addClass("wijmo-wijevcal wijmo-wijev ui-widget ui-helper-reset ui-state-default");a('<div class="wijmo-wijev-headerbar ui-widget-header ui-corner-top"><span class="wijmo-wijev-tools"><input id="'+this._uidPref+'_daybtn" name="viewselection" type="radio" class="wijmo-wijev-day" /><label for="'+this._uidPref+'_daybtn">'+this.localizeString("buttonDayView","Day")+'</label><input id="'+this._uidPref+'_weekbtn" name="viewselection" type="radio" class="wijmo-wijev-week" /><label for="'+this._uidPref+'_weekbtn">'+this.localizeString("buttonWeekView","Week")+'</label><input id="'+this._uidPref+'_monthbtn" name="viewselection" type="radio" class="wijmo-wijev-month" /><label for="'+this._uidPref+'_monthbtn">'+this.localizeString("buttonMonthView","Month")+'</label><input id="'+this._uidPref+'_listbtn" name="viewselection" type="radio" class="wijmo-wijev-list" /><label for="'+this._uidPref+'_listbtn">'+this.localizeString("buttonListView","List")+"</label></span></div>").appendTo(this.element);a('<div class="wijmo-wijev-view-container"><div class="wijmo-wijev-leftpane wijmo-wijev-viewdetails ui-widget-content wijmo-wijev-day-details"><div class="wijmo-wijev-leftpane-inner"><div class="wijmo-wijev-daycalendar"></div><div class="wijmo-wijev-monthday-container"><div class="wijmo-wijev-monthday-label">...</div><div class="wijmo-wijev-fulldate-label">'+this.localizeString("activityLoading","Loading...")+'</div><div class="wijmo-wijev-year-label">...</div></div><div class="wijmo-wijev-agenda-container ui-widget-content ui-corner-all ui-helper-clearfix"></div></div></div><div class="wijmo-wijev-leftpane wijmo-wijev-viewdetails ui-widget-content wijmo-wijev-list-details"><div class="wijmo-wijev-leftpane-inner"><div class="wijmo-wijev-agenda-container ui-widget-content ui-corner-all ui-helper-clearfix">&nbsp;</div></div></div><div class="wijmo-wijev-rightpane">&nbsp;</div></div>').appendTo(this.element);a('<div class="wijmo-wijev-loading-modal-frame"></div><div class="wijmo-wijev-loading"><div class="wijmo-wijev-loading-text">'+this.localizeString("activityLoading","Loading...")+"</div></div>").appendTo(this.element);a('<div class="wijmo-wijev-navigationbar ui-widget-header ui-corner-bottom ui-helper-clearfix"><a class="wijmo-wijev-today">'+this.localizeString("buttonToday","today")+'</a><div class="wijmo-wijev-datepager"></div></div>').appendTo(this.element);a('<div class="wijmo-wijev-statusbar ui-widget-header ui-corner-bottom"></div>').appendTo(this.element);d=this.element.find(".wijmo-wijev-navigationbar");c=this.element.find(".wijmo-wijev-headerbar .wijmo-wijev-tools");d.find(".wijmo-wijev-today").button({text:this.localizeString("buttonToday","today")}).click(a.proxy(this._onTodayClick,this));this.element.find(".wijmo-wijev-datepager").wijdatepager({selectedDate:b.selectedDate,localization:b.datePagerLocalization,culture:b.culture,viewType:b.viewType,nextTooltip:this.localizeString("navigatorBarNextTooltip","right"),prevTooltip:this.localizeString("navigatorBarPrevTooltip","left"),firstDayOfWeek:b.firstDayOfWeek,selectedDateChanged:a.proxy(function(b,a){this.goToDate(a.selectedDate)},this)});c.find(".wijmo-wijev-day").button().click(a.proxy(this._onDayViewClick,this));c.find(".wijmo-wijev-week").button().click(a.proxy(this._onWeekViewClick,this));c.find(".wijmo-wijev-month").button().click(a.proxy(this._onMonthViewClick,this));c.find(".wijmo-wijev-list").button().click(a.proxy(this._onListViewClick,this));c.buttonset();this.showLoadingLabel()},showLoadingLabel:function(a,b){if(a===false)this.element.find(".wijmo-wijev-loading-text").hide();else{this.element.find(".wijmo-wijev-loading-text").show();if(!a)a=this.localizeString("activityLoading","Loading...")}(b===undefined||b===true)&&this.element.find(".wijmo-wijev-loading-modal-frame").show();this.element.find(".wijmo-wijev-loading").show();this.element.find(".wijmo-wijev-loading-text").html(a)},hideLoadingLabel:function(){this.element.find(".wijmo-wijev-loading-modal-frame").hide();this.element.find(".wijmo-wijev-loading").hide()},_init:function(){var c=this.options;if(c.selectedDates&&c.selectedDates.length>0)c.selectedDate=c.selectedDates[0]=b(c.selectedDates[0]);else if(c.selectedDate){c.selectedDate=b(c.selectedDate);if(!c.selectedDates)c.selectedDates=[];c.selectedDates[0]=c.selectedDate}else{c.selectedDate=b(new Date);c.selectedDates=[c.selectedDate]}c.disabled&&this.element.addClass("ui-state-disabled");this._initHeaderbar();this._initNavigationbar();this._initStatusbar();this._initRightPane();c.fullScreen&&this._onFullScreenModeChanged(c.fullScreen);this._initLogPanel();this._initLocalDataStorage();this.element.ajaxError(jQuery.proxy(this._onAjaxError,this));a(window).bind("resize."+this.wijevcalnamespacekey,a.proxy(this._onWindowResize,this));this._renderActiveView();this._bindDataView()},_isDataViewLoaded:function(a){return a&&(a.isLoaded()||a.count()>0)},_isDataview:function(b){if(b&&typeof b==="object"&&!a.isArray(b))return true},_getDataViewInst:function(){return this.element.data("wijdataview")},_bindDataView:function(){var c=this.options,a=c.dataSource,b=this;if(!a&&this._getDataViewInst()){a=this._getDataViewInst();a=c.dataSource=a}if(a&&this._isDataview(a))if(this._isDataViewLoaded(a)){this._dataView=a;this._setOption("eventsData",a.toArray())}else a.element.bind("dataloaded",function(){b._dataView=a;b._setOption("eventsData",a.toArray())});else this._dataView=null},_initLocalDataStorage:function(){try{if(window.amplify&&window.amplify.store)try{c=amplify.store("wijevcal_tables1");f=true;this.log("Using amplify.store for the local data storage")}catch(b){this.log("amplify.store exception:"+b);this._loadData();return}else if(window.openDatabase){try{e=window.openDatabase(i,j,"Wijmo Events Calendar Offline DB",2e5)}catch(h){this.log("web sql database error: "+h);this._loadData();return}if(!e){this.log("Failed to open the database on disk. This is probably because the version was bad or there is not enough space left in this domain's quota");this._loadData();return}this.log("Using Web SQL Database for the local data storage.")}else{this.log(this.localizeString("logCouldntOpenLocalStorage","Couldn't open built-in local data storage. Please, add amplify.store references."));this._loadData();return}g("calendars","(id TEXT PRIMARY KEY, name TEXT, location TEXT, description TEXT, color TEXT, tag TEXT)");g("events","(id TEXT PRIMARY KEY, calendar TEXT, subject TEXT, location TEXT, start TIMESTAMP, end TIMESTAMP, description TEXT, color TEXT, allday INTEGER, properties TEXT, tag TEXT)",a.proxy(this._loadData,this))}catch(d){this.log("local datastorage initialization error:"+d)}},_initStatusbar:function(){var a=this.element.find(".wijmo-wijev-statusbar");if(!this.options.statusBarVisible){a.hide();return}else a.show();if(this.statusbarEventsAdded)return true;this.statusbarEventsAdded=true},_initHeaderbar:function(){var a=this.element.find(".wijmo-wijev-headerbar");if(!this.options.headerBarVisible){a.hide();return}else a.show()},_initNavigationbar:function(){var a=this.element.find(".wijmo-wijev-navigationbar");if(!this.options.navigationBarVisible){a.hide();return}else a.show()},_initRightPane:function(){var a=this.element.find(".wijmo-wijev-rightpane");if(!this.options.rightPaneVisible){a.hide();return}else a.show()},_initLogPanel:function(){if(this.options.enableLogs){this._createLogPanel();this.log=this._log}else{this.logDialog&&this.logDialog.wijdialog("close");this.log=function(){}}},_handleServerError:function(a){if(a&&a.toString().indexOf("error:")===0){this.status(a.toString(),"error");return true}return false},_loadData:function(){var e=this.options,b=this,c,h,f,j,m,n,i,k,l,g;this.showLoadingLabel();g=function(){b.hideLoadingLabel()};e.calendars=[];m=this._calendarsById={};k=function(a){if(!a)return;if(typeof a==="string"){if(b._handleServerError(a)){g(a);return}try{a=b._jsonParse(a)}catch(d){b.status("Unable to parse received calendars data. "+d,"error");return}}if(a.calendars&&a.calendars.length)a=a.calendars;for(c=0;c<a.length;c+=1){f=b._cloneObj(a[c]);f.prevData=b._cloneObj(f);e.calendars.push(f);m[f.id]=f}b._onCalendarsChanged()};if(e.dataStorage.loadCalendars)e.dataStorage.loadCalendars(k,g);else if(e.webServiceUrl)a.getJSON(e.webServiceUrl+"?clientId="+this.element[0].id+"&command=loadCalendars&calendars="+e.calendars,k);else d("SELECT * FROM calendars",[],function(a){for(c=0,h=a.rows.length;c<h;c+=1){f=b._cloneObj(a.rows.item(c));f.prevData=b._cloneObj(f);e.calendars.push(f);m[f.id]=f}b._onCalendarsChanged()},g);if(this._dataView)e.eventsData=this._dataView.toArray();else e.eventsData=[];if(!this._eventsDataById)n=this._eventsDataById={};else n=this._eventsDataById;l=function(a){if(!a)return;if(typeof a==="string"){if(b._handleServerError(a)){g(a);return}try{a=b._jsonParse(a)}catch(d){b.log("Unable to parse received calendars data. "+d);return}}if(a.events&&a.events.length)a=a.events;for(c=0;c<a.length;c+=1){j=b._readEventData(a[c]);b._storeEventWithSort(j)}b._onEventsDataChanged();b._onInitialized()};if(e.dataStorage.loadEvents)e.dataStorage.loadEvents(e.visibleCalendars,l,g);else if(e.webServiceUrl)a.ajax({url:e.webServiceUrl+"?clientId="+this.element[0].id+"&command=loadEvents&timestamp="+ +new Date,dataType:"text",contentType:"application/json; charset=utf-8",type:"POST",data:"jsonData="+this._jsonStringify({visibleCalendars:e.visibleCalendars}),success:l,error:g});else{if(this._dataView){this._onInitialized();return}i="SELECT * FROM events where ";for(c=0;c<e.visibleCalendars.length;c+=1){if(c>0)i+=" OR ";i+="calendar='"+e.visibleCalendars[c]+"'"}d(i,[],function(a){for(c=0,h=a.rows.length;c<h;c+=1){j=b._readEventData(a.rows.item(c));b._storeEventWithSort(j)}b._onEventsDataChanged();b._onInitialized()},g)}},_onInitialized:function(){this._ensureDisabled();this.hideLoadingLabel();this._trigger("initialized")},_readEventData:function(b){var a=this._cloneObj(b);a.start=new Date(a.start);a.end=new Date(a.end);if(typeof a.allday==="string"){if(a.allday==="false")a.allday=false;if(a.allday==="true")a.allday=true}if(a.start.getTime()>=a.end.getTime())a.end=this._addMinutes(a.start,this.options.timeInterval);this._deSerializeProperties(a.properties,a);a.prevData=this._cloneObj(a);return a},_prepareEventsForView:function(){this._eventsView=this.getOccurrences()},_cloneObj:function(b){var c={},a;for(a in b)if(b.hasOwnProperty(a))c[a]=b[a];return c},_onDayViewClick:function(){var a=this.options;if(a.viewType!=="day"){a.viewType="day";this._onViewTypeChanged()}a.selectedDates=[a.selectedDate];this._onSelectedDatesChanged()},_onWeekViewClick:function(){var b=this.options,c,d,a;if(b.viewType!=="week"){b.viewType="week";this._onViewTypeChanged()}c=b.selectedDate;a=b.firstDayOfWeek-c.getDay();if(Math.abs(a)>6)a=c.getDay()-b.firstDayOfWeek;c=this._addDays(c,a);b.selectedDates=[];for(a=0;a<7;a+=1){d=this._addDays(c,a);b.selectedDates.push(d)}this._onSelectedDatesChanged()},_onMonthViewClick:function(){var a=this.options;if(a.viewType!=="month"){a.viewType="month";this._onViewTypeChanged()}},_onListViewClick:function(){var a=this.options;if(a.viewType!=="list"){a.viewType="list";this._onViewTypeChanged()}a.selectedDates=[a.selectedDate];this._onSelectedDatesChanged()},_ensureEditCalendarDialogCreated:function(){var d=this.options,b,c={};if(!this._editCalendarDialog){b=d.editCalendarTemplate;if(!b)b="<p><label>"+this.localizeString("labelCalendarName","Calendar name")+'</label><input type="text" class="wijmo-wijev-name" value=""> <div class="wijmo-wijev-color-button"><div class="wijmo-wijev-color ui-wijmo-wijev-event-color-default">&nbsp;</div></div></p><p><label>'+this.localizeString("labelLocation","Location")+'</label><input type="text" class="wijmo-wijev-location" value=""></p><p><label>'+this.localizeString("labelDescription","Description")+'</label><textarea class="wijmo-wijev-description" /></p>';this._editCalendarDialog=a('<div class="wijmo-wijev-editcalendar-dialog">'+b+"</div>");this.element.append(this._editCalendarDialog);c[this.localizeString("buttonSave","Save")]=a.proxy(function(){try{var a=this._validateAndReadCalendarDialogFields(this._editCalendarDialog);if(a.prevData)this.updateCalendar(a);else this.addCalendar(a);this._editCalendarDialog.wijdialog("close")}catch(b){alert(b)}},this);this._editCalendarDialog.wijdialog({autoOpen:true,height:340,width:440,modal:true,title:this.localizeString("titleEditCalendar","Edit calendar"),buttons:c,captionButtons:{pin:{visible:false},refresh:{visible:false},toggle:{visible:false},minimize:{visible:false},maximize:{visible:false}}});this._editCalendarDialog.find(".wijmo-wijev-name, .wijmo-wijev-location, .wijmo-wijev-description").wijtextbox();this._editCalendarDialog.find(".wijmo-wijev-color-button").button({icons:{primary:"ui-icon-triangle-1-s"}}).click(a.proxy(this._onColorButtonClick,{dlg:this._editCalendarDialog,self:this}))}},_ensureEditEventDialogCreated:function(){if(!this._editEventDialog){var b=this.options.editEventDialogTemplate;if(!b)b='<div class="wijmo-wijev-event-dialog ui-widget-content ui-corner-all"><ul class="wijmo-wijev-brief-content"><li><label>'+this.localizeString("labelName","name")+'</label><input type="text" name="subject" class="wijmo-wijev-subject" value=""><div class="wijmo-wijev-color-button"><div class="wijmo-wijev-color ui-wijmo-wijev-event-color-default">&nbsp;</div></div></li><li><label for="'+this._uidPref+'_alldaybtn">'+this.localizeString("labelAllDay","all-day")+'</label><input type="checkbox" class="wijmo-wijev-allday" id="'+this._uidPref+'_alldaybtn" /></li><li><label>'+this.localizeString("labelStarts","Starts")+'</label><input type="text" class="wijmo-wijev-start" value=""><input type="text" class="wijmo-wijev-start-time" value=""></li><li><label>'+this.localizeString("labelEnds","Ends")+'</label><input type="text" class="wijmo-wijev-end" value=""><input type="text" class="wijmo-wijev-end-time" value=""></li></ul><ul class="wijmo-wijev-detailed-content ui-corner-all"><li><label>'+this.localizeString("labelLocation","Location")+'</label><input type="text" class="wijmo-wijev-location" value=""></li><li><label>'+this.localizeString("labelRepeat","Repeat")+'</label><select class="wijmo-wijev-repeat"><option value="none">'+this.localizeString("repeatNone","None")+'</option><option value="daily">'+this.localizeString("repeatDaily","Every Day")+'</option><option value="workdays">'+this.localizeString("repeatWorkDays","Work days")+'</option><option value="weekly">'+this.localizeString("repeatWeekly","Every Week")+'</option><option value="monthly">'+this.localizeString("repeatMonthly","Every Month")+'</option><option value="yearly">'+this.localizeString("repeatYearly","Every Year")+"</option></select></li><li><label>"+this.localizeString("labelCalendar","Calendar")+'</label><select class="wijmo-wijev-calendar"></select></li><li class="wijmo-wijev-description-item"><label>'+this.localizeString("labelDescription","Description")+'</label><textarea class="wijmo-wijev-description" /></li></ul><div class="footer"><a href="#" class="wijmo-wijev-delete">'+this.localizeString("buttonDelete","Delete")+'</a><a href="#" class="wijmo-wijev-save">'+this.localizeString("buttonOK","OK")+'</a><a href="#" class="wijmo-wijev-cancel">'+this.localizeString("buttonCancel","Cancel")+'</a></div><div class="wijmo-wijev-angle"></div></div>';this._editEventDialog=a(b);this.element.append(this._editEventDialog);this._editEventDialog.find(".wijmo-wijev-color-button").button({icons:{primary:"ui-icon-triangle-1-s"}}).click(a.proxy(this._onColorButtonClick,{dlg:this._editEventDialog,self:this}));this._editEventDialog.find(".wijmo-wijev-delete").button().click(a.proxy(function(){this.deleteEvent(this._editEventDialog.appt);this._editEventDialog.wijpopup("hide")},this));this._editEventDialog.find(".wijmo-wijev-cancel").button().click(a.proxy(function(){this._editEventDialog.wijpopup("hide")},this));this._editEventDialog.find(".wijmo-wijev-start").width(114).wijinputdate({culture:this.options.culture,titleFormat:this.localizeString("calendarTitleFormat","MMMM yyyy"),toolTipFormat:this.localizeString("calendarToolTipFormat","dddd, MMMM dd, yyyy"),nextTooltip:this.localizeString("calendarNextTooltip","Next"),prevTooltip:this.localizeString("calendarPrevTooltip","Previous"),showTrigger:true,dateFormat:"d",dateChanged:a.proxy(function(c,a){var b=this._editEventDialog.find(".wijmo-wijev-end").wijinputdate("option","date");a.date>b&&this._editEventDialog.find(".wijmo-wijev-end").wijinputdate("option","date",a.date)},this)});this._editEventDialog.find(".wijmo-wijev-start-time").width(80).wijinputdate({culture:this.options.culture,titleFormat:this.localizeString("calendarTitleFormat","MMMM yyyy"),toolTipFormat:this.localizeString("calendarToolTipFormat","dddd, MMMM dd, yyyy"),nextTooltip:this.localizeString("calendarNextTooltip","Next"),prevTooltip:this.localizeString("calendarPrevTooltip","Previous"),dateFormat:"t",dateChanged:a.proxy(function(d,a){var c=this._editEventDialog.find(".wijmo-wijev-end-time").wijinputdate("option","date"),b=this._editEventDialog.find(".wijmo-wijev-start").wijinputdate("option","date");if(a.date.getDate()!==b.getDate()){a.date.setDate(b.getDate());this._editEventDialog.find(".wijmo-wijev-start-time").wijinputdate("option","date",a.date)}a.date>c&&this._editEventDialog.find(".wijmo-wijev-end-time").wijinputdate("option","date",a.date)},this)});this._editEventDialog.find(".wijmo-wijev-end").width(114).wijinputdate({culture:this.options.culture,titleFormat:this.localizeString("calendarTitleFormat","MMMM yyyy"),toolTipFormat:this.localizeString("calendarToolTipFormat","dddd, MMMM dd, yyyy"),nextTooltip:this.localizeString("calendarNextTooltip","Next"),prevTooltip:this.localizeString("calendarPrevTooltip","Previous"),showTrigger:true,dateFormat:"d",dateChanged:a.proxy(function(c,a){var b=this._editEventDialog.find(".wijmo-wijev-start").wijinputdate("option","date");a.date<b&&this._editEventDialog.find(".wijmo-wijev-start").wijinputdate("option","date",a.date)},this)});this._editEventDialog.find(".wijmo-wijev-end-time").width(80).wijinputdate({culture:this.options.culture,titleFormat:this.localizeString("calendarTitleFormat","MMMM yyyy"),toolTipFormat:this.localizeString("calendarToolTipFormat","dddd, MMMM dd, yyyy"),nextTooltip:this.localizeString("calendarNextTooltip","Next"),prevTooltip:this.localizeString("calendarPrevTooltip","Previous"),dateFormat:"t"});this._editEventDialog.find(".wijmo-wijev-allday").wijcheckbox().change(a.proxy(this._eventDialogEnsureTimePartState,this));this._editEventDialog.find(".wijmo-wijev-subject,.wijmo-wijev-location,.wijmo-wijev-description").wijtextbox();this._editEventDialog.find(".wijmo-wijev-save").button().click(a.proxy(function(){try{var a=this._validateAndReadApptDialogFields(this._editEventDialog);if(a.prevData)this.updateEvent(a);else this.addEvent(a);this._editEventDialog.wijpopup("hide")}catch(b){alert(b)}},this));this._editEventDialog.wijpopup({autoHide:true,hiding:a.proxy(function(){this._colorMenu&&this._colorMenu.wijpopup("hide");this.element.find(".wijmo-wijev-dayview .ui-selected").removeClass("ui-selected")},this),shown:a.proxy(function(){var a=this;if(!this._dropDownInitialized){this._editEventDialog.find(".wijmo-wijev-calendar").wijdropdown().bind("change",function(){var b=a._calendarsById[this.value];if(b&&b.color)a._addColorClass(a._editEventDialog.find(".wijmo-wijev-color"),b.color);else a._editEventDialog.appt&&a._editEventDialog.appt.color&&a._addColorClass(a._editEventDialog.find(".wijmo-wijev-color"),a._editEventDialog.appt.color)});this._editEventDialog.find(".wijmo-wijev-repeat").wijdropdown().bind("change",function(){var c=this.value,b=a._editEventDialog.appt;switch(c){case"none":b.recurrenceState=null;b.recurrencePattern=null;break;case"daily":b.recurrenceState="master";b.recurrencePattern={parentRecurrenceId:b.id,recurrenceType:"daily"};break;case"workdays":b.recurrenceState="master";b.recurrencePattern={parentRecurrenceId:b.id,recurrenceType:"workdays"};break;case"weekly":b.recurrenceState="master";b.recurrencePattern={parentRecurrenceId:b.id,recurrenceType:"weekly"};break;case"monthly":b.recurrenceState="master";b.recurrencePattern={parentRecurrenceId:b.id,recurrenceType:"monthly"};break;case"yearly":b.recurrenceState="master";b.recurrencePattern={parentRecurrenceId:b.id,recurrenceType:"yearly"};break;case"custom":alert("show custom recurrence pattern.")}});this._dropDownInitialized=true}else{this._editEventDialog.find(".wijmo-wijev-calendar").wijdropdown("refresh");this._editEventDialog.find(".wijmo-wijev-repeat").wijdropdown("refresh")}this._onEditEventDialogShown(this._editEventDialog,this._editEventDialog.appt);this._editEventDialog.find(".wijmo-wijev-subject").focus();this._updateEditEventPopupCallout()},this)})}},_updateEditEventPopupCallout:function(){if(this._editEventDialog&&this._editEventDialog._arrowTarget){var b=this._editEventDialog,f=a(b._arrowTarget),c=f.offset(),e=b.offset(),d;if(c.left<e.left)b.removeClass("wijmo-wijev-rightangle").addClass("wijmo-wijev-leftangle");else b.removeClass("wijmo-wijev-leftangle").addClass("wijmo-wijev-rightangle");d=Math.round(c.top-e.top+f.outerHeight(true)/2);this._editEventDialog.find(".wijmo-wijev-angle").css("top",d)}},_onColorButtonClick:function(){var e=this.self,b=this.dlg,d,g=e.options,c=g.colors,f="";if(c&&c.length>0)for(d=0;d<c.length;d+=1)f+='<span class="wijmo-wijev-listcolor wijmo-wijev-event-color-'+c[d]+'">&nbsp;</span>';if(!b._colorMenu){b._colorMenu=a('<div class="wijmo-wijev-color-menu ui-widget-content ui-corner-all"></div>');b.append(b._colorMenu);b._colorMenu.wijpopup({autoHide:true})}b._colorMenu.html(f);b._colorMenu.find(".wijmo-wijev-listcolor").click(a.proxy(function(c){this._addColorClass(b.find(".wijmo-wijev-color"),this._readColorFromClass(a(c.target),"default"));b._colorMenu.wijpopup("hide")},e));b._colorMenu.wijpopup("show",{of:b.find(".wijmo-wijev-color-button"),my:"left top",at:"left bottom"})},_validateAndReadCalendarDialogFields:function(b){var a=b.cal||{};a.name=b.find(".wijmo-wijev-name").val();a.location=b.find(".wijmo-wijev-location").val();a.description=b.find(".wijmo-wijev-description").val();a.color=this._readColorFromClass(b.find(".wijmo-wijev-color"),a.color||"default");if(!a.name)throw"Calendar name can not be empty";return a},_validateAndReadApptDialogFields:function(c){var a=c.appt,g,h,e,f,d;g=b(c.find(".wijmo-wijev-start").wijinputdate("option","date"));h=b(c.find(".wijmo-wijev-end").wijinputdate("option","date"));e=c.find(".wijmo-wijev-start-time").wijinputdate("option","date");f=c.find(".wijmo-wijev-end-time").wijinputdate("option","date");if(g.getTime()===h.getTime()&&e.getTime()>f.getTime())throw this.localizeString("messageEndOccursBeforeStart","The end date you entered occurs before the start date.");a.subject=c.find(".wijmo-wijev-subject").val();a.location=c.find(".wijmo-wijev-location").val();a.start=g;a.end=h;if(c.find(".wijmo-wijev-allday").length>0)a.allday=c.find(".wijmo-wijev-allday")[0].checked;if(!a.allday){a.start=new Date(a.start.getFullYear(),a.start.getMonth(),a.start.getDate(),e.getHours(),e.getMinutes(),e.getSeconds());a.end=new Date(a.end.getFullYear(),a.end.getMonth(),a.end.getDate(),f.getHours(),f.getMinutes(),f.getSeconds())}else if(a.start.getTime()>=a.end.getTime())a.end=this._addMinutes(a.start,this.options.timeInterval);a.calendar=c.find(".wijmo-wijev-calendar").val();a.description=c.find(".wijmo-wijev-description").val();a.color=this._readColorFromClass(c.find(".wijmo-wijev-color"),a.color);d=a.recurrencePattern;if(d&&a.recurrenceState==="master"){d.startTime=a.start;d.endTime=a.end;d.patternStartDate=a.start}return a},_bindApptToDialog:function(b){if(!b)return;var a=this._editEventDialog,d,c;a.appt=b;a.find(".wijmo-wijev-subject").val(b.subject||"");a.find(".wijmo-wijev-location").val(b.location||"");try{a.find(".wijmo-wijev-start").wijinputdate("option","date",b.start);a.find(".wijmo-wijev-start-time").wijinputdate("option","date",b.start);a.find(".wijmo-wijev-end").wijinputdate("option","date",b.end);a.find(".wijmo-wijev-end-time").wijinputdate("option","date",b.end)}catch(e){alert("[e0001a] wijinputdate/wijtextselection firefox error\n"+e)}if(a.find(".wijmo-wijev-allday").length>0)a.find(".wijmo-wijev-allday")[0].checked=b.allday;a.find(".wijmo-wijev-allday").wijcheckbox("refresh");this._fillCalendarsSelect(a.find(".wijmo-wijev-calendar"),b.calendar);this._loadRepeatValue(b,a.find(".wijmo-wijev-repeat"));a.find(".wijmo-wijev-description").val(b.description||"");if(!b.prevData)a.find(".wijmo-wijev-delete").hide();else a.find(".wijmo-wijev-delete").show();if(a.find(".wijmo-wijev-calendar").length>0)d=this._calendarsById[a.find(".wijmo-wijev-calendar")[0].value];c=b.color;if(!c&&d&&d.color)c=d.color;this._addColorClass(a.find(".wijmo-wijev-color"),c);this._eventDialogEnsureTimePartState()},_onEditEventDialogShown:function(a,b){if(b.recurrenceState==="exception")a.find(".wijmo-wijev-repeat").wijdropdown("option","disabled",true);else a.find(".wijmo-wijev-repeat").wijdropdown("option","disabled",false)},_eventDialogEnsureTimePartState:function(){var a=this._editEventDialog;if(a.find(".wijmo-wijev-allday").length>0)if(a.find(".wijmo-wijev-allday")[0].checked){a.find(".wijmo-wijev-start-time").wijinputdate("option","disabled",true);a.find(".wijmo-wijev-end-time").wijinputdate("option","disabled",true)}else{a.find(".wijmo-wijev-start-time").wijinputdate("option","disabled",false);a.find(".wijmo-wijev-end-time").wijinputdate("option","disabled",false)}},_loadRepeatValue:function(b,c){var a="none";if(b.recurrencePattern)switch(b.recurrencePattern.recurrenceType){case"daily":a="daily";break;case"workdays":a="workdays";break;case"weekly":a="weekly";break;case"monthly":a="monthly";break;case"yearly":a="yearly";break;default:a="custom"}c.val(a)},_addColorClass:function(a,d){var b,c=new RegExp("wijmo-wijev-event-color-(\\w+)\\s*");if(a.length>0){b=a[0].className;a[0].className=b.replace(c,"");a.addClass("wijmo-wijev-event-color-"+(d||"default"))}},_readColorFromClass:function(b,c){var d=new RegExp("wijmo-wijev-event-color-(\\w+)\\s*"),a;if(b.length>0){a=d.exec(b[0].className);if(a&&a.length>1)return a[1]}return c},_fillCalendarsSelect:function(f,i){var h="",g=this.options,a,d,e,b=g.calendars.slice(0),c=g.visibleCalendars;if(c&&c.length>0)for(a=0;a<c.length;a+=1){e=false;for(d=0;d<b.length;d+=1)if(b[d].name===c[a])e=true;!e&&b.push({id:c[a],name:c[a]})}if(b.length===0){f.html("");return}for(a=0;a<b.length;a+=1)h+='<option value="'+b[a].id+'">'+b[a].name+"</option>";f.html(h).val(i)},_bindCalendarToDialog:function(a){if(!a)return;var b=this._editCalendarDialog;b.cal=a;b.find(".wijmo-wijev-name").val(a.name||"");b.find(".wijmo-wijev-location").val(a.location||"");b.find(".wijmo-wijev-description").val(a.description||"");this._addColorClass(b.find(".wijmo-wijev-color"),a.color)},_onTodayClick:function(){this.goToday();return false},_bindEvents:function(){if(!this._eventsAttached){a(this.element).find(".wijmo-wijev-appointment").live("click."+this.wijevcalnamespacekey,a.proxy(this._onAppointmentClick,this));a(this.element).find(".wijmo-wijev-dayview .wijmo-wijev-appointment").live("mousedown."+this.wijevcalnamespacekey,a.proxy(this._onDayViewAppointmentMouseDown,this));a(this.element).find(".wijmo-wijev-monthview .wijmo-wijev-appointment").live("mousedown."+this.wijevcalnamespacekey,a.proxy(this._onMonthViewAppointmentMouseDown,this));a(this.element).find(".wijmo-wijev-dayview .wijmo-wijev-timeinterval").live("click."+this.wijevcalnamespacekey,a.proxy(this._onDayViewTimeIntervalClick,this));a(this.element).find(".wijmo-wijev-dayview .wijmo-wijev-allday-cell").live("click."+this.wijevcalnamespacekey,a.proxy(this._onDayViewAllDayCellClick,this));a(this.element).find(".wijmo-wijev-monthview .wijmo-wijev-monthcellheader").live("click."+this.wijevcalnamespacekey,a.proxy(this._onMonthViewDayLabelClick,this));a(this.element).find(".wijmo-wijev-monthview .wijmo-wijev-monthcell-showmore").live("click."+this.wijevcalnamespacekey,a.proxy(this._onMonthViewDayLabelClick,this));a(this.element).find(".wijmo-wijev-weekview .wijmo-wijev-daylabel").live("click."+this.wijevcalnamespacekey,a.proxy(this._onMonthViewDayLabelClick,this));a(this.element).find(".wijmo-wijev-monthview .wijmo-wijev-monthcell").live("click."+this.wijevcalnamespacekey,a.proxy(this._onMonthViewCellClick,this));this._eventsAttached=true}},_unbindEvents:function(){if(this._eventsAttached){a(this.element).find(".wijmo-wijev-appointment").die("click."+this.wijevcalnamespacekey);a(this.element).find(".wijmo-wijev-dayview .wijmo-wijev-daycolumn .wijmo-wijev-appointment").die("mousedown."+this.wijevcalnamespacekey);a(this.element).find(".wijmo-wijev-dayview .wijmo-wijev-dayheadercolumn .wijmo-wijev-daylabel").die("click."+this.wijevcalnamespacekey);a(this.element).find(".wijmo-wijev-dayview .wijmo-wijev-timeinterval").die("click."+this.wijevcalnamespacekey);a(this.element).find(".wijmo-wijev-dayview .wijmo-wijev-allday-cell").die("click."+this.wijevcalnamespacekey);a(this.element).find(".wijmo-wijev-monthview .wijmo-wijev-monthcellheader").die("click."+this.wijevcalnamespacekey);a(this.element).find(".wijmo-wijev-monthview .wijmo-wijev-monthcell-showmore").die("click."+this.wijevcalnamespacekey);a(this.element).find(".wijmo-wijev-weekview .wijmo-wijev-daylabel").die("click."+this.wijevcalnamespacekey);a(this.element).find(".wijmo-wijev-monthview .wijmo-wijev-monthcell").die("click."+this.wijevcalnamespacekey);this._eventsAttached=false}},destroy:function(){this.element.removeClass("wijmo-wijev wijmo-wijevcal ui-widget ui-helper-reset");a(window).unbind("resize."+this.wijevcalnamespacekey);this._unbindEvents();a.Widget.prototype.destroy.apply(this,arguments)},deleteCalendar:function(b,k,l){for(var e=this.options.calendars,j=b.id||b,i=false,h,f,m,g=this,c=0;c<e.length;c+=1)if(e[c].id===j){i=true;b=e[c];if(!this._trigger("beforeDeleteCalendar",null,{data:b}))return false;delete this._calendarsById[b.id];e.splice(c,1);break}if(!i)for(c=0;c<e.length;c+=1)if(e[c].name===j){i=true;b=e[c];if(!this._trigger("beforeDeleteCalendar",null,{data:b}))return false;delete this._calendarsById[b.id];e.splice(c,1);break}if(!i){this.status("Calendar with id/name '"+j+"' not found.");return false}this.showLoadingLabel(this.localizeString("activityDeletingCalendar","Deleting calendar..."));h=function(a){g.status("Calendar '"+b.name+"' deleted.");g._onCalendarsChanged();g.hideLoadingLabel();k&&k(a)};f=function(a){g.status("Unable to delete calendar '"+b.name+"': "+a);g.hideLoadingLabel();l&&l(a)};if(this.options.dataStorage.deleteCalendar)this.options.dataStorage.deleteCalendar(b,h,f);else if(this.options.webServiceUrl){try{m=this._jsonStringify(b)}catch(n){this.status("Unable to prepare calendar data for server. "+n,"error");f("Unable to prepare calendar data for server. "+n);return}a.ajax({url:this.options.webServiceUrl+"?clientId="+this.element[0].id+"&command=deleteCalendar&timestamp="+ +new Date,dataType:"text",contentType:"application/json; charset=utf-8",type:"POST",data:"jsonData="+m,success:h,error:f})}else d("DELETE FROM calendars WHERE id='"+b.id+"'",[],h,f)},addCalendar:function(b,h,i){var g,f,e,c=this;if(!this._trigger("beforeAddCalendar",null,{data:b,prevData:b.prevData||{}})){if(b.prevData)for(f in b.prevData)if(b.prevData.hasOwnProperty(f))b[f]=b.prevData[f];return false}if(!b.id){if(!this._dynIdCounter)this._dynIdCounter=0;this._dynIdCounter+=1;b.id="dynid"+this._dynIdCounter+"ts"+ +new Date}this.showLoadingLabel(this.localizeString("activityCreatingCalendar","Creating calendar..."));g=function(a){if(c._handleServerError(a)){e(a);return}c._readUpdatedServerDataIfAny(a,b);if(!c._calendarsById[b.id]){c.options.calendars.push(b);c._calendarsById[b.id]=b;c.status("Calendar '"+b.name+"' added.")}else c.status("Calendar '"+b.name+"' added.");b.prevData=c._cloneObj(b);c._onCalendarsChanged();c.hideLoadingLabel();h&&h(a)};e=function(a){c.status("Unable to add calendar '"+b.name+"': "+a);c.hideLoadingLabel();i&&i(a)};if(this.options.dataStorage.addCalendar)this.options.dataStorage.addCalendar(b,g,e);else if(this.options.webServiceUrl){try{f=this._jsonStringify(b)}catch(j){this.status("Unable prepare calendar data for server."+j,"error");e("Unable to prepare calendar data for server."+j);return}a.ajax({url:this.options.webServiceUrl+"?clientId="+this.element[0].id+"&command=addCalendar&timestamp="+ +new Date,dataType:"text",contentType:"application/json; charset=utf-8",type:"POST",data:"jsonData="+f,success:g,error:e})}else d("INSERT OR REPLACE INTO calendars (id, name, location, description, color, tag) VALUES(?,?,?,?,?,?);",[b.id,b.name,b.location,b.description,b.color,b.tag],g,e)},updateCalendar:function(b,h,i){var g,f,e,c=this;if(!this._trigger("beforeUpdateCalendar",null,{data:b,prevData:b.prevData||{}})){if(b.prevData)for(f in b.prevData)if(b.prevData.hasOwnProperty(f))b[f]=b.prevData[f];return false}if(!b.id){if(!this._dynIdCounter)this._dynIdCounter=0;this._dynIdCounter+=1;b.id="dynid"+this._dynIdCounter+"ts"+ +new Date}this.showLoadingLabel(this.localizeString("activityUpdatingCalendar","Updating calendar..."));g=function(a){if(c._handleServerError(a)){e(a);return}c._readUpdatedServerDataIfAny(a,b);if(!c._calendarsById[b.id]){c.options.calendars.push(b);c._calendarsById[b.id]=b;c.status("Calendar '"+b.name+"' added.")}else c.status("Calendar '"+b.name+"' updated.");b.prevData=c._cloneObj(b);c._onCalendarsChanged();c.hideLoadingLabel();h&&h(a)};e=function(a){c.status("Unable to update calendar '"+b.name+"': "+a);c.hideLoadingLabel();i&&i(a)};if(this.options.dataStorage.updateCalendar)this.options.dataStorage.updateCalendar(b,g,e);else if(this.options.webServiceUrl){try{f=this._jsonStringify(b)}catch(j){this.status("Unable prepare calendar data for server. "+j,"error");e("Unable to prepare calendar data for server. "+j);return}a.ajax({url:this.options.webServiceUrl+"?clientId="+this.element[0].id+"&command=updateCalendar&timestamp="+ +new Date,dataType:"text",contentType:"application/json; charset=utf-8",type:"POST",data:"jsonData="+f,success:g,error:e})}else d("INSERT OR REPLACE INTO calendars (id, name, location, description, color, tag) VALUES(?,?,?,?,?,?);",[b.id,b.name,b.location,b.description,b.color,b.tag],g,e)},addEvent:function(b,i,j){var g,f,e,c=this;if(!this._trigger("beforeAddEvent",null,{data:b,prevData:b.prevData||{}})){if(b.prevData)for(e in b.prevData)if(b.prevData.hasOwnProperty(e))b[e]=b.prevData[e];return false}if(!b.id){if(!this._dynIdCounter)this._dynIdCounter=0;this._dynIdCounter+=1;b.id=h()}if(!b.calendar)b.calendar="Default";this.showLoadingLabel(this.localizeString("activityCreatingEvent","Creating event..."));f=function(a){c.hideLoadingLabel();c.status("Unable to add event '"+b.subject+"': "+a,"error");if(b.prevData)for(e in b.prevData)if(b.prevData.hasOwnProperty(e))b[e]=b.prevData[e];j&&j(a)};g=function(a){if(c._handleServerError(a)){f(a);return}c._readUpdatedServerDataIfAny(a,b);if(!c._eventsDataById[b.id]||b.recurrenceState==="exception"){c._storeEventWithSort(b);c.status("Event '"+b.subject+"' added.")}else c.status("Event '"+b.subject+"' added.");b.prevData=c._cloneObj(b);c._onEventsDataChanged();c.hideLoadingLabel();i&&i(a)};if(this.options.dataStorage.addEvent)this.options.dataStorage.addEvent(b,g,f);else if(this.options.webServiceUrl){try{e=this._jsonStringify(b)}catch(k){this.status("Unable prepare event data for server. "+k,"error");f("Unable to prepare event data for server. "+k);return}a.ajax({url:this.options.webServiceUrl+"?clientId="+this.element[0].id+"&command=addEvent&timestamp="+ +new Date,dataType:"text",contentType:"application/json; charset=utf-8",type:"POST",data:"jsonData="+e,success:g,error:f})}else d("INSERT OR REPLACE INTO events (id, calendar, subject, location, start, end, description, color, allday, properties, tag) VALUES(?,?,?,?,?,?,?,?,?,?,?);",[b.id,b.calendar,b.subject,b.location,b.start.getTime(),b.end.getTime(),b.description,b.color,b.allday,this._serializeProperties(b),b.tag],g,f)},_storeEventWithSort:function(b){var c=this.options.eventsData,a,d;this._eventsDataById[b.id]=b;for(a=0,d=c.length;a<d;a+=1)if(c[a].start>b.start){c.splice(a,0,b);return}else if(c[a].start.getTime()===b.start.getTime())if(c[a].subject>b.subject){c.splice(a,0,b);return}c.push(b)},_readUpdatedServerDataIfAny:function(a,d){var b=null,c;if(typeof a==="string"&&a.indexOf("update:")===0){a=a.toString().substr("update:".length);try{b=this._jsonParse(a)}catch(e){this.status("Unable to read updated server data. "+e,"warning")}if(b)for(c in b)if(b[c])d[c]=b[c]}},updateEvent:function(b,h,i){var g,f,e,c=this;if(!this._trigger("beforeUpdateEvent",null,{data:b,prevData:b.prevData||{}})){if(b.prevData)for(e in b.prevData)if(b.prevData.hasOwnProperty(e))b[e]=b.prevData[e];this._updateAppointmentVisual(b);return false}if(!b.calendar)b.calendar="Default";this.showLoadingLabel(this.localizeString("activityUpdatingEvent","Updating event..."));f=function(a){c.hideLoadingLabel();c.status("Unable to update event '"+b.subject+"': "+a,"error");if(b.prevData)for(e in b.prevData)if(b.prevData.hasOwnProperty(e))b[e]=b.prevData[e];c._updateAppointmentVisual(b);i&&i(a)};if(!b.id){f("id is empty");return}if(b.recurrenceState==="exception"||b.recurrenceState==="occurrence"){if(!this._eventsDataById[b.parentRecurrenceId]){f("Unable to find master event for event with id:"+b.id);return}if(b.recurrenceState==="occurrence"){this.log(this._formatString("[updateEvent->addEvent] recurrenceState for event {0} changed to 'exception'.",b.id));b.recurrenceState="exception";return this.addEvent(b,h,i)}}g=function(a){if(c._handleServerError(a)){f(a);return}c._readUpdatedServerDataIfAny(a,b);if(!c._eventsDataById[b.id]){c._storeEventWithSort(b);c.status("Event '"+b.subject+"' added.")}else c.status("Event '"+b.subject+"' updated.");b.prevData=c._cloneObj(b);c._onEventsDataChanged();c.hideLoadingLabel();h&&h(a)};if(this.options.dataStorage.updateEvent)this.options.dataStorage.updateEvent(b,g,f);else if(this.options.webServiceUrl){try{e=this._jsonStringify(b)}catch(j){this.status("Unable prepare event data for server. "+j,"error");f("Unable to prepare event data for server. "+j);return}a.ajax({url:this.options.webServiceUrl+"?clientId="+this.element[0].id+"&command=updateEvent&timestamp="+ +new Date,dataType:"text",contentType:"application/json; charset=utf-8",type:"POST",data:"jsonData="+e,success:g,error:f})}else d("INSERT OR REPLACE INTO events (id, calendar, subject, location, start, end, description, color, allday, properties, tag) VALUES(?,?,?,?,?,?,?,?,?,?,?);",[b.id,b.calendar,b.subject,b.location,b.start.getTime(),b.end.getTime(),b.description,b.color,b.allday,this._serializeProperties(b),b.tag],g,f)},_serializeProperties:function(b){var c="",a={};a.parentRecurrenceId=b.parentRecurrenceId;a.recurrenceState=b.recurrenceState;a.recurrencePattern=b.recurrencePattern;a.color=b.color;a.allday=b.allday;try{c=this._jsonStringify(a)}catch(d){this.status("Unable save additional event properties. "+d,"error")}return c},_deSerializeProperties:function(d,c){var b={},a;if(d){if(typeof d==="string")try{b=this._jsonParse(d)}catch(e){this.status("Unable to load additional event properties. "+e,"error");return}else b=d;if(b.parentRecurrenceId)c.parentRecurrenceId=b.parentRecurrenceId;if(b.recurrenceState)c.recurrenceState=b.recurrenceState;if(b.recurrencePattern)c.recurrencePattern=b.recurrencePattern;if(b.color)c.color=b.color;if(b.allday)c.allday=b.allday}if(c&&c.recurrencePattern){a=c.recurrencePattern;a.patternStartDate=a.patternStartDate?new Date(a.patternStartDate):a.patternStartDate;a.startTime=a.startTime?new Date(a.startTime):a.startTime;a.endTime=a.endTime?new Date(a.endTime):a.endTime;if(a.startTime.getTime()>=a.endTime.getTime())a.endTime=this._addMinutes(a.startTime,this.options.timeInterval)}},_jsonStringify:function(b){var a;if(window.__JSONC1)a=window.__JSONC1.stringify(b);else if(window.JSON)a=JSON.stringify(b);else throw"JSON not found.";return a},_jsonParse:function(d){var a,c,b;if(window.__JSONC1)a=window.__JSONC1.parse(d);else if(window.JSON){c=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}(?:\.\d*)?)Z$/;b=/^\/Date\((d|-|.*)\)\/$/;a=window.JSON.parse(d,function(f,d){if(typeof d==="string"){var a=c.exec(d),e;if(a)return new Date(Date.UTC(+a[1],+a[2]-1,+a[3],+a[4],+a[5],+a[6]));a=b.exec(d);if(a){e=a[1].split(/[-,.]/);return new Date(+e[0])}}return d})}else throw"JSON variable not found.";return a},getOccurrences:function(l,o){var t=this.options,r=t.eventsData,b,a,i,g,d,c,m,n,s=100,j,e,h,p=[],q=[],k=[],f={};if(!this._eventsDataById)this._eventsDataById={};for(d=0,m=r.length;d<m;d+=1){b=r[d];this._eventsDataById[b.id]=b;if(b.recurrenceState==="master"){g=b.recurrencePattern;if(g.removedOccurrences)k=k.concat(g.removedOccurrences);n=g.occurrences||s;j=g.patternStartDate||b.start;e=g.startTime||b.start;h=g.endTime||b.end;switch(g.recurrenceType){case"daily":for(c=0;c<n;c+=1){a=this._cloneObj(b);a.parentRecurrenceId=b.id;a.recurrenceState="occurrence";a.start=this._setTime(this._addDays(j,c),e);a.end=this._setTime(a.start,h,e);a.recurrencePattern=null;if(this._testIsEventInTimeInterval(a,l,o)){a.id=this._formatString("{0}_OCCR_{1:yyyy_MM_dd}",b.id,a.start);f[a.id]=a}}break;case"workdays":for(c=0;c<n;c+=1){a=this._cloneObj(b);a.parentRecurrenceId=b.id;a.recurrenceState="occurrence";a.start=this._setTime(this._addDays(j,c),e);if(a.start.getDay()===0||a.start.getDay()===6)continue;a.end=this._setTime(a.start,h,e);a.recurrencePattern=null;if(this._testIsEventInTimeInterval(a,l,o)){a.id=this._formatString("{0}_OCCR_{1:yyyy_MM_dd}",b.id,a.start);f[a.id]=a}}break;case"weekly":for(c=0;c<n;c+=1){a=this._cloneObj(b);a.parentRecurrenceId=b.id;a.recurrenceState="occurrence";a.start=this._setTime(this._addDays(j,c*7),e);a.end=this._setTime(a.start,h,e);a.recurrencePattern=null;if(this._testIsEventInTimeInterval(a,l,o)){a.id=this._formatString("{0}_OCCR_{1:yyyy_MM_dd}",b.id,a.start);f[a.id]=a}}break;case"monthly":for(c=0;c<n;c+=1){a=this._cloneObj(b);a.parentRecurrenceId=b.id;a.recurrenceState="occurrence";a.start=this._setTime(new Date(j),e);a.start.setMonth(a.start.getMonth()+c);a.end=this._setTime(a.start,h,e);a.recurrencePattern=null;if(this._testIsEventInTimeInterval(a,l,o)){a.id=this._formatString("{0}_OCCR_{1:yyyy_MM_dd}",b.id,a.start);f[a.id]=a}}break;case"yearly":for(c=0;c<n;c+=1){a=this._cloneObj(b);a.parentRecurrenceId=b.id;a.recurrenceState="occurrence";a.start=this._setTime(new Date(j),e);a.start.setYear(a.start.getFullYear()+c);a.end=this._setTime(a.start,h,e);a.recurrencePattern=null;if(this._testIsEventInTimeInterval(a,l,o)){a.id=this._formatString("{0}_OCCR_{1:yyyy_MM_dd}",b.id,a.start);f[a.id]=a}}}}else if(this._testIsEventInTimeInterval(b,l,o))if(b.recurrenceState==="exception")q.push(b);else if(b.recurrenceState==="removed"){k.push(b.id);this.log("[warning] Seems we found removed event inside events storage, id:"+b.id)}else p.push(b)}for(d=0,m=q.length;d<m;d+=1){i=q[d];if(f[i.id])delete f[i.id];p.push(i);this._eventsDataById[i.id]=i}for(d=0,m=k.length;d<m;d+=1)if(f[k[d]])delete f[k[d]];for(d in f){a=f[d];p.push(a);this._eventsDataById[a.id]=a}return p},_testIsEventInTimeInterval:function(b,a,c){return!a||!c?true:b.start<c&&b.end>a?true:false},deleteEvent:function(g,k,l){if(g.id)g=g.id;var b=this._eventsDataById[g],h,j,i,e,c=this,m,f;if(!this._trigger("beforeDeleteEvent",null,{data:b}))return false;this.showLoadingLabel(this.localizeString("activityDeletingEvent","Deleting event..."));e=function(a){c.status("Unable to delete event '"+(b?b.subject:"undefined")+"': "+a);c.hideLoadingLabel();l&&l(a)};if(b.recurrenceState==="exception"||b.recurrenceState==="occurrence"){f=this._eventsDataById[b.parentRecurrenceId];if(f){this.log(this._formatString("[deleteEvent] removing {0} with id {1}. Updating master event with id {2}",b.recurrenceState,b.id,f.id));if(!f.recurrencePattern.removedOccurrences)f.recurrencePattern.removedOccurrences=[];f.recurrencePattern.removedOccurrences.push(b.id);this.updateEvent(f,k,l);if(b.recurrenceState==="occurrence"){this.log("No need to delete occurrence from store. Master event should be updated.");return}}else if(b.recurrenceState!=="exception"){e("Unable to find master event with id "+b.parentRecurrenceId);return false}}b.recurrenceState==="master";i=function(a){if(c._handleServerError(a)){e(a);return}if(c._eventsDataById[b.id]){j=c.options.eventsData;for(h=0;h<j.length;h=h+1)j[h].id===g&&j.splice(h,1);delete c._eventsDataById[b.id];c.status("Event '"+b.subject+"' deleted.")}else c.status("Event '"+b.subject+"' deleted.");b.prevData=c._cloneObj(b);c._onEventsDataChanged();c.hideLoadingLabel();k&&k(a)};if(this.options.dataStorage.deleteEvent)this.options.dataStorage.deleteEvent(b,i,e);else if(this.options.webServiceUrl){try{m=this._jsonStringify(b)}catch(n){this.status("Unable prepare event data for server. "+n,"error");e("Unable prepare event data for server. "+n);return}a.ajax({url:this.options.webServiceUrl+"?clientId="+this.element[0].id+"&command=deleteEvent&timestamp="+ +new Date,dataType:"text",contentType:"application/json; charset=utf-8",type:"POST",data:"jsonData="+m,success:i,error:e})}else d("DELETE FROM events WHERE id='"+g+"'",[],i,e)},beginUpdate:function(){this._isUpdating=true;this.showLoadingLabel("Updating...")},endUpdate:function(){this._isUpdating=false;this._pendingRedrawActiveView&&this._redrawActiveView();this.hideLoadingLabel()},goToEvent:function(a){if(a.id)a=a.id;var d=this.options,b,c=this.findEventById(a);switch(d.viewType){case"day":case"week":case"list":b=this.element.find(".wijmo-wijev-dayview .wijmo-wijev-daycolumn ."+this._eventIdToCssClass(a));if(b.length>0)this.element.find(".wijmo-wijev-scrollpanel").wijsuperpanel("scrollChildIntoView",b);else{this._dayViewScrollToEvent=c;this.goToDate(c.start)}break;case"month":this.goToDate(c.start)}},isAllDayEvent:function(b){var a=b;if(!b.id)a=this.findEventById(b);return a.allday?(a.end.getTime()-a.start.getTime())/864e5>=1?true:true:false},goToDate:function(d){d=b(d);var f=this.options,g=d.getDay(),a,e,c=f.selectedDates;if(c&&c.length>0)if(this._isContainsDayDate(c,d))return;else{e=(d-c[0].getTime())/864e5;if(f.viewType==="week")for(a=0;a<c.length;a+=1)if(c[a].getDay()===g){e=e-a;break}for(a=0;a<c.length;a+=1)c[a]=this._addDays(c[a],e);this._onSelectedDatesChanged()}else{f.selectedDates=[d];this._onSelectedDatesChanged()}},goToTime:function(b){var g=this.element.find(".wijmo-wijev-daycolumn .wijmo-wijev-timeinterval:first-child"),a=this.element.find(".wijmo-wijev-daycolumn .wijmo-wijev-timeinterval:last-child"),e=g.position().top,h=a.position().top+a.height(),f,d,c;c=86400;d=b.getHours()*3600+b.getMinutes()*60;f=(h-e)*d/c+e;this.element.find(".wijmo-wijev-scrollpanel").wijsuperpanel("vScrollTo",f)},goToday:function(){this.goToDate(new Date)},goLeft:function(){var b,c=this.options,d=c.viewType,a=c.selectedDates;if(d==="month")this.goToDate(this._addMonths(a[0],-1));else{b=-7;if(a.length===1)b=-1;this.goToDate(this._addDays(a[0],b))}},goRight:function(){var b,c=this.options,d=c.viewType,a=c.selectedDates;if(d==="month")this.goToDate(this._addMonths(a[0],1));else{b=7;if(a.length===1)b=1;this.goToDate(this._addDays(a[0],b))}},refresh:function(){this.invalidate()},invalidate:function(){var a=this.options;switch(a.viewType.toLowerCase()){case"list":case"day":case"week":this._invalidateDayView();break;case"month":this._invalidateMonthView()}},showEditCalendarDialog:function(a){var d=this.options,c=d.calendars,b;if(!a)a={name:"",description:"",location:"",color:""};else if(!a.name)for(b=0;b<c.length;b+=1)if(c[b].name===a){a=c[b];break}this._ensureEditCalendarDialogCreated();this._bindCalendarToDialog(a);this._editCalendarDialog.wijdialog("open")},showEditEventDialog:function(b,g,e){var f=this.options,h,d,i,c=g?a(g):e?a(e.target):null;this._ensureEditEventDialogCreated();this.element.find(".wijmo-wijev-dayview .ui-selected").removeClass("ui-selected");if(c&&c.hasClass("wijmo-wijev-daylabel"))c=c.parent(".wijmo-wijev-allday-cell");if(!b){b={subject:this.localizeString("textNewEvent","New event")};b.isNewEvent=true;if(c&&c.length>0){this._editEventDialog._arrowTarget=c;c.addClass("ui-selected");d=c.parent(".wijmo-wijev-daycolumn");if(d.length<1)d=c.parent(".wijmo-wijev-dayheadercolumn");d=d[0];if(c.hasClass("wijmo-wijev-allday-cell"))b.allday=true;else if(c.hasClass("wijmo-wijev-monthcellcontainer")){d=c[0];b.allday=true}else b.allday=false;if(d){i=this._parseDateFromClass(d.className,b.allday?null:c[0].className);b.start=i;if(b.allday)b.end=this._addMinutes(b.start,1440);else b.end=this._addMinutes(b.start,f.timeInterval)}}else{b.start=new Date(f.selectedDates[0]);b.end=this._addMinutes(b.start,f.timeInterval)}}else{this._editEventDialog._arrowTarget=c;if(b.recurrenceState==="occurrence"){h=this._eventsDataById[b.parentRecurrenceId];if(!window.confirm(this._formatString(this.localizeString("promptOpenOccurrenceFormat","{2}  is recurring event. Do you want to open only this occurrence?"),b.start,b.end,b.subject,b.location)))b=h}}if(this._trigger("beforeEditEventDialogShow",null,{data:b,targetCell:c})){this._bindApptToDialog(b);this._editEventDialog.wijpopup("show",{of:c,my:"left center",at:"right center",offset:(c&&e?Math.round(e.offsetX-c.width()):10)+" 0",collision:"fit"})}},_renderActiveView:function(){var a=this.options,b=this.element.find(".wijmo-wijev-headerbar .wijmo-wijev-tools");this.element.find(".wijmo-wijev-view").hide();this.element.find(".wijmo-wijev-viewdetails").hide();this.element.find(".wijmo-wijev-"+a.viewType.toLowerCase()+"-details").show();switch(a.viewType.toLowerCase()){case"day":case"week":case"list":this.element.find(".wijmo-wijev-view.wijmo-wijev-dayview").show();this._renderDayView();break;case"month":this.element.find(".wijmo-wijev-view.wijmo-wijev-monthview").show();this._renderMonthView()}b.find(".wijmo-wijev-"+a.viewType.toLowerCase())[0].checked=true;b.buttonset("refresh")},_redrawActiveView:function(){if(this._isUpdating){this._pendingRedrawActiveView=true;return}switch(this.options.viewType.toLowerCase()){case"day":case"week":this._clearDayViewCache();this._templateDayColumn=null}this._renderActiveView()},_getDayColumnDates:function(f){var d=this.options,b=d.selectedDates,c,e,a;if(!b)b=[new Date];if(d.viewType==="week"){c=d.selectedDate||b[0];a=d.firstDayOfWeek-c.getDay();if(Math.abs(a)>6)a=c.getDay()-d.firstDayOfWeek;c=this._addDays(c,a);b=[];for(a=0;a<7;a+=1){e=this._addDays(c,a);b.push(e)}}if(f)d.selectedDates=b;return b},_renderDayView:function(){var e=this.options,h=0,u=1440,n,k,o,t=this._getDayColumnDates(true),f,b,c,d,l=new Date,r,q=false,i=this.element.find(".wijmo-wijev-dayview"),p,j,s,g=0,m;if(i.length===0){i=a('<div class="wijmo-wijev-view wijmo-wijev-dayview ui-widget-content"><h3 class="wijmo-wijev-header-title">title</h3><div class="wijmo-wijev-dayview-inner"><div class="wijmo-wijev-headercontainer"><div class="wijmo-wijev-sizer"><div class="wijmo-wijev-gmtlabel">'+this.localizeString("labelAllDay","all-day")+'</div></div></div><div class="wijmo-wijev-scrollpanel"><div class="wijmo-wijev-scrollcontent"><div class="wijmo-wijev-timeruler"><div class="wijmo-wijev-currenttime-indicator"><div class="wijmo-wijev-currenttime-indicator-arrow ui-state-error"></div><div class="wijmo-wijev-currenttime-indicator-line ui-state-error"></div></div></div></div></div></div></div>');i.appendTo(this.element.find(".wijmo-wijev-view-container"));this.element.find(".wijmo-wijev-scrollpanel").wijsuperpanel({hScroller:{scrollBarVisibility:"hidden"},animationOptions:{disabled:true}})}i.removeClass("wijmo-wijev-weekview wijmo-wijev-listview");i.addClass("wijmo-wijev-"+e.viewType.toLowerCase()+"view");p=this.element.find(".wijmo-wijev-headercontainer");j=this.element.find(".wijmo-wijev-scrollcontent");s=j.find(".wijmo-wijev-timeruler");if(!this._templateDayColumn){s.find(".wijmo-wijev-timerulerinterval").remove();n='<div class="wijmo-wijev-daycolumn">';m=true;while(h<u){k="wijmo-wijev-timeinterval ui-widget-content wijmo-wijev-minute-"+h;if(m)k+=" wijmo-wijev-oddrow";m=!m;o="wijmo-wijev-timerulerinterval ui-widget-content wijmo-wijev-minute-"+h;n+='<div class="'+k+'" style="height: '+e.timeIntervalHeight+'px"></div>';h+=e.timeInterval;g+=e.timeInterval;if(g>=e.timeRulerInterval){k+=" wijmo-wijev-timeinterval-hourstart";o+=" wijmo-wijev-timerulerinterval-hourstart";s.append(a('<div class="'+o+'" style="height:'+g/e.timeInterval*e.timeIntervalHeight+'px">'+this._formatString(e.timeRulerFormat,new Date(l.getFullYear(),l.getMonth(),l.getDate(),0,h-g))+"</div>"));g=0}}n+="</div>";this._templateDayColumn=a(n);this._templateDayHeader=a('<div class="wijmo-wijev-dayheadercolumn ui-widget-content"><div class="wijmo-wijev-allday-cell ui-widget-content"><div class="wijmo-wijev-daylabel">3 Monday</div></div></div>')}p.find(".wijmo-wijev-dayheadercolumn").remove();j.find(".wijmo-wijev-daycolumn").remove();for(f=0,r=t.length;f<r;f=f+1){d=t[f];b=this._getCachedDayHeader(d);c=this._getCachedDayColumn(d);if(!b){b=this._templateDayHeader.clone(true);c=this._templateDayColumn.clone(true);b.addClass(this._dayDateToCssClass(d));b.find(".wijmo-wijev-daylabel").html(this._formatDayHeaderDate(d));c.addClass(this._dayDateToCssClass(d));if(q)q=false;else{c.addClass("wijmo-wijev-leftborder");b.addClass("wijmo-wijev-leftborder")}if(this._compareDayDates(d,l)===0){c.addClass("wijmo-wijev-today ui-state-highlight");c.addClass("wijmo-wijev-leftborder");c.addClass("wijmo-wijev-rightborder");b.addClass("wijmo-wijev-today").find(".wijmo-wijev-allday-cell").addClass("ui-state-highlight");b.addClass("wijmo-wijev-leftborder");b.addClass("wijmo-wijev-rightborder");q=true}if(f===r-1){c.addClass("wijmo-wijev-rightborder");b.addClass("wijmo-wijev-rightborder")}}else{b=a(b);b.find(".wijmo-wijev-daylabel").html(this._formatDayHeaderDate(d))}p.append(b);j.append(c)}this._invalidateDayView();this._renderDayViewAppointments()},_getCachedDayHeader:function(a){var b=null;if(this._dayViewCache)if(this._dayViewCache[a])b=this._dayViewCache[a].h;return b},_getCachedDayColumn:function(a){var b=null;if(this._dayViewCache)if(this._dayViewCache[a])b=this._dayViewCache[a].c;return b},_storeDayCache:function(a,c,b){if(!this._dayViewCache)this._dayViewCache={};this._dayViewCache[a]={h:c,c:b}},_clearViewsCache:function(){this._clearDayViewCache();this._clearListViewCache()},_clearDayViewCache:function(){this._dayViewCache={}},_clearListViewCache:function(){var a=this.element.find(".wijmo-wijev-list-details .wijmo-wijev-agenda-container .wijmo-wijsuperpanel-templateouterwrapper");a.data("wijevcal_agenda_initialized",false);a.data("wijevcal_agenda_loadedeventscount",0)},_invalidateDayView:function(){var b=this.element.find(".wijmo-wijev-headercontainer"),k=this.element.find(".wijmo-wijev-scrollcontent"),s=k.find(".wijmo-wijev-timeruler"),j=b.find(".wijmo-wijev-dayheadercolumn"),p=k.find(".wijmo-wijev-daycolumn"),q=this.element.find(".wijmo-wijev-view .wijmo-wijev-header-title"),o,d,l,c,n,f,h,r=s.outerWidth(),g,e,m,i;this._updateHeaderTitleText();o=q.is(":visible")?q.outerHeight(true):0;this._invalidateView();if(!this._maxAllDayEventCount)this._maxAllDayEventCount=0;c=b.find(".wijmo-wijev-dayheadercolumn .wijmo-wijev-appointment").outerHeight(true);if(!c)c=17;n=b.find(".wijmo-wijev-daylabel").outerHeight(true);f=0;for(g=0;g<j.length;g+=1){h=a(j[g]).find(".wijmo-wijev-allday-cell .wijmo-wijev-appointment").length;if(h>f)f=h}l=c*f+n+c;b.outerHeight(l+Math.round(c/2));b.find(".wijmo-wijev-allday-cell").outerHeight(l);d=this.element.find(".wijmo-wijev-view").innerWidth();e=d-r;e=e-18;m=this.element.find(".wijmo-wijev-view").innerHeight()-b.outerHeight(true)-o;i=Math.floor(e/p.length);b.outerWidth(d);k.outerWidth(d);j.outerWidth(i);p.outerWidth(i);this._invalidateCurrentTimeIndicator();this.element.find(".wijmo-wijev-scrollpanel").outerWidth(d).outerHeight(m).wijsuperpanel("refresh");switch(this.options.viewType.toLowerCase()){case"day":this._updateDayViewDetails();break;case"list":this._updateListViewDetails()}},_updateDayViewDetails:function(){var c=this.options,b=c.selectedDate,d=this.element.find(".wijmo-wijev-leftpane"),e=d.find(".wijmo-wijev-agenda-container");if(!this._dayViewDetailsInit){this._dayViewDetailsInit=true;this.element.find(".wijmo-wijev-day-details .wijmo-wijev-daycalendar").wijcalendar({culture:c.culture,titleFormat:this.localizeString("calendarTitleFormat","MMMM yyyy"),toolTipFormat:this.localizeString("calendarToolTipFormat","dddd, MMMM dd, yyyy"),showTitle:false,showOtherMonthDays:false,showWeekNumbers:false,selectionMode:{day:true,days:false},selectedDatesChanged:a.proxy(function(b,a){a.dates&&!c.disabled&&this.goToDate(a.dates[0])},this),nextTooltip:this.localizeString("calendarNextTooltip","Next"),prevTooltip:this.localizeString("calendarPrevTooltip","Previous")});this.element.find(".wijmo-wijev-day-details .wijmo-wijev-agenda-container").wijsuperpanel()}this.element.find(".wijmo-wijev-day-details .wijmo-wijev-daycalendar").wijcalendar("option","displayDate",b).wijcalendar("unSelectAll").wijcalendar("selectDate",b);this.element.find(".wijmo-wijev-day-details .wijmo-wijev-daycalendar").wijcalendar("refresh");this.element.find(".wijmo-wijev-day-details .wijmo-wijev-monthday-label").html(b.getDate());this.element.find(".wijmo-wijev-day-details .wijmo-wijev-fulldate-label").html(this._formatString(this.localizeString("dayDetailsLabelFulldateFormat","{0:dddd, MMMM d}"),b));this.element.find(".wijmo-wijev-day-details .wijmo-wijev-year-label").html(this._formatString(this.localizeString("dayDetailsLabelYearFormat","{0:yyyy}"),b));this._updateAgendaList(this.element.find(".wijmo-wijev-day-details  .wijmo-wijev-agenda-container"),b,b,false)},_listViewAgendaScrolled:function(){var d=this.element.find(".wijmo-wijev-list-details .wijmo-wijev-agenda-container"),c=d.wijsuperpanel("option","vScroller"),b,e=c.scrollValue,f=c.scrollMax-c.scrollLargeChange*2;if(e>=f){b=d.find(".wijmo-wijsuperpanel-templateouterwrapper");if(b.data("wijevcal_agenda_loadnextpage")){b.data("wijevcal_agenda_loadnextpage",false);b.find(".wijmo-wijev-agenda-more-events").show().html(this.localizeString("agendaLoadingMoreEvents","Loading more events..."));if(this._renderAgendaEventsTimeoutId){clearTimeout(this._renderAgendaEventsTimeoutId);this._renderAgendaEventsTimeoutId=null}this._renderAgendaEventsTimeoutId=setTimeout(a.proxy(function(){this._renderAgendaEventsTimeoutId=null;this._renderAgendaEvents(b,null,null,true);b.find(".wijmo-wijev-agenda-more-events").remove()},this),100)}}},_updateListViewDetails:function(){if(!this._listViewDetailsInit){this._listViewDetailsInit=true;this.element.find(".wijmo-wijev-list-details .wijmo-wijev-agenda-container").wijsuperpanel({scrolled:a.proxy(this._listViewAgendaScrolled,this)})}this._updateAgendaList(this.element.find(".wijmo-wijev-list-details  .wijmo-wijev-agenda-container"),null,null,true)},_updateAgendaList:function(b,e,f,c){var d=this.element.find(".wijmo-wijev-leftpane"),a=b;b.outerHeight(d.innerHeight()-b[0].offsetTop);if(a.find(".wijmo-wijsuperpanel-templateouterwrapper").length>0)a=a.find(".wijmo-wijsuperpanel-templateouterwrapper");if(c&&a.data("wijevcal_agenda_initialized")){a.parents(".wijmo-wijsuperpanel").wijsuperpanel("refresh");return}a.data("wijevcal_agenda_initialized",true);a.data("wijevcal_agenda_loadedeventscount",0);a.html("");this._renderAgendaEvents(a,e,f,c)},_renderAgendaEvents:function(h,t,u,n){var j=this._eventsView,f,e,i,s,p=0,m,d="",g="",l=null,o=null,v=this.options,c,r,q=100,k=h.data("wijevcal_agenda_loadedeventscount");if(t){l=b(t);o=this._addDays(b(u),1);s=(o.getTime()-l.getTime())/864e5}if(j){i=j.length<q+k||!n?j.length:q+k;h.data("wijevcal_agenda_loadedeventscount",i);if(!l){g="";for(e=k;e<i;e+=1){f=j[e];if(e===k||c.getDate()!==f.start.getDate()){c=f.start;if(e!==0){d+='<ul class="wijmo-wijev-agenda-list">'+g+"</ul>";d+="</div>"}d+='<div class="wijmo-wijev-agenda-day-container '+this._dayDateToCssClass(c)+'">';if(n)d+=this._renderAgendaDayHeader(c);g=""}g+=this._renderAgendaAppointmentVisual(f);m+=1;if(e===i-1){d+='<ul class="wijmo-wijev-agenda-list">'+g+"</ul>";d+="</div>";if(i<j.length){d+='<div class="wijmo-wijev-agenda-more-events">';d+=this._formatString(this.localizeString("agendaMoreEventsFormat","More events ({0})..."),j.length-i);d+="<div>";h.data("wijevcal_agenda_loadnextpage",true)}else h.data("wijevcal_agenda_loadnextpage",false)}}}else while(p<s){c=this._addDays(l,p);c=new Date(c.getFullYear(),c.getMonth(),c.getDate());r=new Date(c.getFullYear(),c.getMonth(),c.getDate(),23,59,59);m=0;g="";for(e=k;e<i;e+=1){f=j[e];if(f.start<o&&f.end>l&&f.start<r&&f.start>=c){g+=this._renderAgendaAppointmentVisual(f);m+=1}}if(g!==""){d+='<div class="wijmo-wijev-agenda-day-container '+this._dayDateToCssClass(c)+'">';if(n)d+=this._renderAgendaDayHeader(c);d+='<ul class="wijmo-wijev-agenda-list">'+g+"</ul>";d+="</div>"}p+=1}a(d).appendTo(h)}h.find(".wijmo-wijev-agenda-event").live("click",a.proxy(this._onAgendaEventClick,this)).hover(function(){a(this).addClass("ui-state-hover")},function(){a(this).removeClass("ui-state-hover").removeClass("ui-state-active")}).mousedown(function(){a(this).addClass("ui-state-active")}).mouseup(function(){a(this).removeClass("ui-state-active")});h.parents(".wijmo-wijsuperpanel").wijsuperpanel("refresh")},_renderAgendaDayHeader:function(a){return'<div class="wijmo-wijev-agenda-header ui-widget-header"><div class="wijmo-wijev-weekday">'+this._formatString("{0:dddd}",a)+'</div><div class="wijmo-wijev-date">'+this._formatString(this.localizeString("agendaHeaderFullDateFormat","{0:MMMM d, yyyy}"),a)+"</div></div>"},_onAgendaEventClick:function(c){var b=a(c.target);if(!b.hasClass("wijmo-wijev-agenda-event"))b=b.parent(".wijmo-wijev-agenda-event");b.length>0&&this.goToEvent(this._parseEventIdFromClass(b[0].className))},_renderAgendaAppointmentVisual:function(a){return'<li class="wijmo-wijev-agenda-event '+this._dayDateToCssClass(a.start)+" "+this._eventIdToCssClass(a.id)+' ui-state-default ui-helper-clearfix"><div class="wijmo-wijev-agenda-event-color wijmo-wijev-event-color-'+(a.color||"default")+'"><div></div></div><div class="wijmo-wijev-agenda-event-title">'+a.subject+'</div><div class="wijmo-wijev-agenda-event-time">'+(this.isAllDayEvent(a)?this.localizeString("labelAllDay","all-day"):this._formatString(this.localizeString("agendaTimeFormat","{0:hh:mm tt} to {1:hh:mm tt}"),a.start,a.end))+"</div></li>"},_invalidateCurrentTimeIndicator:function(){var c=this.element.find(".wijmo-wijev-timeruler .wijmo-wijev-currenttime-indicator"),a=new Date,b=this.options;a=a.getMinutes()+a.getHours()*60;c.css("top",a/b.timeInterval*b.timeIntervalHeight)},_onEventsDataChanged:function(){this._clearViewsCache();this._prepareEventsForView();this._renderActiveView();this._trigger("eventsDataChanged",null,{eventsData:this.options.eventsData})},_onCalendarsChanged:function(){this._trigger("calendarsChanged",null,{calendars:this.options.calendars})},_renderDayViewAppointments:function(){var p=this._eventsView,d,l,c,v,w,x=this.element.find(".wijmo-wijev-headercontainer"),y=this.element.find(".wijmo-wijev-scrollcontent"),r=x.find(".wijmo-wijev-dayheadercolumn"),g=y.find(".wijmo-wijev-daycolumn"),b,k,m=this.options,f=this._getDayColumnDates(),z=f[0],h,q,e,i,j,s,t,o,u,n=[];h=f[f.length-1];h=new Date(h.getFullYear(),h.getMonth(),h.getDate(),23,59,59);if(p)for(c=0,w=f.length;c<w;c+=1)if(!g[c]._cached){b=f[c];b=new Date(b.getFullYear(),b.getMonth(),b.getDate());k=new Date(b.getFullYear(),b.getMonth(),b.getDate(),23,59,59);for(l=0,v=p.length;l<v;l+=1){d=p[l];if(d.start<h&&d.end>z&&d.start<k&&d.end>b)if(this.isAllDayEvent(d)){q=true;e=a(this._getAllDayEventMarkup(d));a(r[c]).find(".wijmo-wijev-allday-cell").append(e)}else{i=d.start;j=d.end;if(i<b)i=b;if(j>k)j=k;s=(i-b)/6e4;t=(j-b)/6e4;o=Math.round(s*m.timeIntervalHeight/m.timeInterval);u=Math.round(t*m.timeIntervalHeight/m.timeInterval);e=a(this._getEventMarkup(d));e.css("top",o);e.outerHeight(u-o);a(g[c]).append(e)}}this._storeDayCache(f[c],r[c],g[c]);g[c]._cached=true;n.push(g[c])}else n.push(g[c]);this._dayColumnsToResolve=n;this._dayColumnResolveIdx=0;if(!this._resolveDayApptConflictsTimeout){clearTimeout(this._resolveDayApptConflictsTimeout);this._resolveDayApptConflictsTimeout=null}this._resolveDayApptConflictsTimeout=setTimeout(a.proxy(this._resolveDayViewAppointmentConflictsCb1,this),1);q&&this._invalidateDayView(true);if(this._dayViewScrollToEvent){e=this.element.find(".wijmo-wijev-dayview .wijmo-wijev-daycolumn ."+this._eventIdToCssClass(this._dayViewScrollToEvent.id));e.length>0&&this.element.find(".wijmo-wijev-scrollpanel").wijsuperpanel("scrollChildIntoView",e)}},_getAllDayEventMarkup:function(a){return'<div class="wijmo-wijev-appointment '+this._eventIdToCssClass(a.id)+'"><div class=" wijmo-wijev-colordot wijmo-wijev-event-color-'+(a.color||"default")+'"></div><div class="wijmo-wijev-event-title">'+a.subject+"</div></div>"},_getEventMarkup:function(a){return'<div class="wijmo-wijev-appointment wijmo-wijev-event-color-'+(a.color||"default")+" "+this._eventIdToCssClass(a.id)+'"><div class="wijmo-wijev-content"><div class="wijmo-wijev-title">'+this._formatString(this.options.eventTitleFormat,a.start,a.end,a.subject,a.location,"",a.description)+'</div></div><div class="wijmo-wijev-resizer"><div class="ui-icon ui-icon-grip-solid-horizontal">&nbsp;</div></div></div>'},_resolveDayViewAppointmentConflictsCb1:function(){this._resolveDayApptConflictsTimeout=null;if(!this._dayColumnsToResolve||this._dayColumnResolveIdx>=this._dayColumnsToResolve.length)return;this._resolveDayViewAppointmentConflicts(this._dayColumnsToResolve[this._dayColumnResolveIdx]);this._dayColumnResolveIdx=this._dayColumnResolveIdx+1;setTimeout(a.proxy(this._resolveDayViewAppointmentConflictsCb1,this),1)},_resolveDayViewAppointmentConflicts:function(l){var j=a(l).find(".wijmo-wijev-appointment"),f=[],e,b,d,c,h,g,i,k;for(b=0,g=j.length;b<g;b+=1){c=j[b];for(d=0;d<g;d+=1)if(d!==b){h=j[d];if(c.offsetTop<h.offsetTop+h.offsetHeight&&c.offsetTop+c.offsetHeight>h.offsetTop){if(!f[b])f[b]=[c];f[b].push(h)}}}for(b=0,g=f.length;b<g;b+=1){e=f[b];if(e){c=e[0];i=e.length;c.style.width=Math.ceil(100/i)+"%";e.sort(this._sortOffsetTop);for(d=0;d<i;d+=1){c=e[d];k=Math.floor(100*d/i);c.style.marginLeft=k+"%";c.style.zIndex=k}}}},_sortOffsetTop:function(a,b){return a.offsetTop<b.offsetTop?-1:a.offsetTop>b.offsetTop?1:0},_onDayViewTimeIntervalClick:function(a){if(this.options.readOnly)return;this.showEditEventDialog(null,a.target,a)},_onDayViewAllDayCellClick:function(c){if(this.options.readOnly)return;var b=a(c.target);if(b.hasClass("wijmo-wijev-appointment")||b.parents(".wijmo-wijev-appointment").length>0)return;if(b.hasClass("wijmo-wijev-daylabel")||b.parents(".wijmo-wijev-daylabel").length>0)return;this.showEditEventDialog(null,c.target,c)},_onMonthViewDayLabelClick:function(e){var b=a(e.target).parents(".wijmo-wijev-monthcellcontainer"),c=this.options,d;if(b.length<1)b=a(e.target).parents(".wijmo-wijev-dayheadercolumn");if(b[0]){d=this._parseDateFromClass(b[0].className);if(c.viewType!=="day"){c.viewType="day";this._onViewTypeChanged()}c.selectedDates=[new Date(d)];this._onSelectedDatesChanged()}},_onMonthViewCellClick:function(c){var b=a(c.target).parent(".wijmo-wijev-monthcellcontainer");if(this.options.readOnly)return;if(b.length<1)return;this.showEditEventDialog(null,b,c)},_onAppointmentClick:function(d){var b=a(d.target),c;if(this.options.readOnly)return;if(this._apptDragResizeFlag)return;if(!b.hasClass("wijmo-wijev-appointment"))b=b.parents(".wijmo-wijev-appointment");if(b.length>0){c=this.findEventById(b[0].className);this.showEditEventDialog(c,b,d)}},findEventById:function(a){var b;if(a){b=a.indexOf("apptid_");if(b!==-1)a=this._parseEventIdFromClass(a);if(this._eventsDataById)return this._eventsDataById[a]}return null},_onMonthViewAppointmentMouseDown:function(c){if(this.options.readOnly)return;var b=a(c.target),d=b.hasClass("wijmo-wijev-appointment")?b:b.parents(".wijmo-wijev-appointment");c.preventDefault();this.__targetAppt=d;a(document).bind("mouseup.tmp_wijevcal",a.proxy(this._onMonthViewAppointmentMouseUp,this));this.element.find(".wijmo-wijev-monthview .wijmo-wijev-monthcellcontainer").bind("mouseover.tmp_wijevcal",a.proxy(this._onMonthViewCellMouseOver,this))},_onDayViewAppointmentMouseDown:function(d){if(this.options.readOnly)return;var b=a(d.target),c=b.hasClass("wijmo-wijev-appointment")?b:b.parents(".wijmo-wijev-appointment"),e=b.hasClass("wijmo-wijev-resizer")||b.parents(".wijmo-wijev-resizer").length>0;if(this.options.disabled)return;this._isApptResize=e;d.preventDefault();if(this._isApptResize){this.__startApptH=c[0].offsetHeight;this.__startApptY=c[0].offsetTop}else this.__startApptY=c[0].offsetTop;this.__startClientY=d.clientY;this.__targetAppt=c;a(document).bind("mousemove.tmp_wijevcal",a.proxy(this._onDayViewAppointmentMouseMove,this));a(document).bind("mouseup.tmp_wijevcal",a.proxy(this._onDayViewAppointmentMouseUp,this));a(this.element).find(".wijmo-wijev-dayview .wijmo-wijev-daycolumn").bind("mouseover.tmp_wijevcal",a.proxy(this._onDayViewColumnMouseOver,this));a(this.element).find(".wijmo-wijev-dayview .wijmo-wijev-allday-cell").bind("mouseover.tmp_wijevcal",a.proxy(this._onDayViewAllDayMouseOver,this))},_onDayViewAppointmentMouseMove:function(d){d.preventDefault();var c=d.clientY-this.__startClientY,b,f=this.options,a,e;if(!d.ctrlKey)c=Math.round(c/f.timeIntervalHeight)*f.timeIntervalHeight;if(c!==0&&!this._apptDragResizeFlag){this._apptDragResizeFlag=true;this.__targetAppt.addClass("wijmo-wijev-dragging");this.__targetAppt.css("width","100%").css("margin-left","0").css("z-index","1000")}if(this._apptDragResizeFlag){if(this._isApptResize){a=this.__startApptH+c;if(a<0){a=Math.abs(a);b=this.__startApptY-a;if(b>=0){this.__targetAppt.css("height",a);this.__targetAppt.css("top",b)}}else this.__targetAppt.css("height",a)}else{b=this.__startApptY+c;if(b<0)b=0;this.__targetAppt.css("top",b);e=this.__targetAppt.offset().top;this.element.find(".wijmo-wijev-scrollpanel").wijsuperpanel("scrollChildIntoView",this.__targetAppt);this.__startApptY=this.__startApptY-(this.__targetAppt.offset().top-e)}this._onApptVisualDargOrResize(this.__targetAppt,this.findEventById(this.__targetAppt[0].className))}},_onDayViewAppointmentMouseUp:function(){this.__targetAppt&&this.__targetAppt.removeClass("wijmo-wijev-dragging");a(document).unbind(".tmp_wijevcal");a(this.element).find(".wijmo-wijev-dayview .wijmo-wijev-daycolumn").unbind(".tmp_wijevcal");a(this.element).find(".wijmo-wijev-dayview .wijmo-wijev-allday-cell").unbind(".tmp_wijevcal");if(this._apptDragResizeFlag||this._apptMovedFlag){var b=this.findEventById(this.__targetAppt[0].className);this._onApptVisualDargOrResize(this.__targetAppt,b);this._apptMovedFlag=false;this._movedFromTimeInervalApptElem=null;this.updateEvent(b);window.setTimeout(a.proxy(function(){if(this.__targetAppt&&!this.__targetAppt.hasClass("wijmo-wijev-dragging")){this._apptDragResizeFlag=false;this._resolveDayViewAppointmentConflicts(this.__targetAppt.parents(".wijmo-wijev-daycolumn"))}},this),1)}},_updateAppointmentVisual:function(a){var c=this.element.find(".wijmo-wijev-dayview ."+this._eventIdToCssClass(a.id)),d=this.options,h,i,g,j,e,f,k,l;if(c.length===1){this._addColorClass(c,a.color);c.find(".wijmo-wijev-title").html(this._formatString(d.eventTitleFormat,a.start,a.end,a.subject,a.location,"",a.description));e=b(a.start);h=(a.start-e)/6e4;i=(a.end-e)/6e4;g=Math.round(h*d.timeIntervalHeight/d.timeInterval);j=Math.round(i*d.timeIntervalHeight/d.timeInterval);c.css("top",g);c.css("height",j-g);f=this._dayDateToCssClass(e);if(c.parents(".wijmo-wijev-daycolumn."+f).length!==1){k=c[0].parentNode;l=this.element.find(".wijmo-wijev-daycolumn."+f);k.removeChild(c[0]);c.appendTo(l)}}},_onApptVisualDargOrResize:function(d,a){var c=this.options,k=d[0].offsetTop,n=k+d[0].offsetHeight,j,l,f,h,e,m,g,i;if(d.parents(".wijmo-wijev-dayheadercolumn").length>0)i=d.parents(".wijmo-wijev-dayheadercolumn")[0];else i=d.parents(".wijmo-wijev-daycolumn")[0];g=this._parseDateFromClass(i.className,null);j=Math.round(k*c.timeInterval/c.timeIntervalHeight);l=Math.round(n*c.timeInterval/c.timeIntervalHeight);f=new Date(j*6e4+g.getTime());h=new Date(l*6e4+g.getTime());if(a){if(!this._isApptResize){m=a.end.getTime()-a.start.getTime();e=new Date(f.getTime()+m)}else e=h;a.allday=d.parents(".wijmo-wijev-dayheadercolumn").length>0;a.start=f;a.end=e;d.find(".wijmo-wijev-title").html(this._formatString(c.eventTitleFormat,a.start,a.end,a.subject,a.location,"",a.description));!this._isApptResize&&e.getTime()!==h.getTime()&&d.css("height",Math.round((a.end-b(a.start))/6e4*c.timeIntervalHeight/c.timeInterval)-Math.round((a.start-b(a.start))/6e4*c.timeIntervalHeight/c.timeInterval))}},_onDayViewColumnMouseOver:function(d){var c=a(d.target).parents(".wijmo-wijev-daycolumn"),b=this.__targetAppt.parents(".wijmo-wijev-daycolumn");if(c.length<1)return;if(b.length<1){b=this.__targetAppt.parents(".wijmo-wijev-dayheadercolumn");if(b.length<1)return;else if(this._movedFromTimeInervalApptElem){this.__targetAppt.replaceWith(this._movedFromTimeInervalApptElem);this.__targetAppt=a(this._movedFromTimeInervalApptElem);this._movedFromTimeInervalApptElem=null}else this.__targetAppt.html(this._getEventMarkup(this.findEventById(this.__targetAppt[0].className),true))}if(c[0].className!==b[0].className){this.__targetAppt[0].parentNode.removeChild(this.__targetAppt[0]);this._resolveDayViewAppointmentConflicts(b);this.__targetAppt.appendTo(c);this._apptMovedFlag=true}},_onMonthViewCellMouseOver:function(e){var c=a(e.target),b=c.hasClass("wijmo-wijev-monthcellcontainer")?c:c.parents(".wijmo-wijev-monthcellcontainer"),d=this.__targetAppt.parents(".wijmo-wijev-monthcellcontainer");if(b.length<1||d.length<1)return;if(b[0].className!==d[0].className){this.__targetAppt[0].parentNode.removeChild(this.__targetAppt[0]);this.__targetAppt.appendTo(b.find(".wijmo-wijev-monthcell"));this.__targetApptChanged=true}},_onMonthViewAppointmentMouseUp:function(){var c,f=this.__targetAppt.parents(".wijmo-wijev-monthcellcontainer")[0],e=this._parseDateFromClass(f.className,null),d;a(document).unbind(".tmp_wijevcal");this.element.find(".wijmo-wijev-monthview .wijmo-wijev-monthcellcontainer").unbind(".tmp_wijevcal");if(this.__targetApptChanged){this.__targetApptChanged=false;c=this.findEventById(this.__targetAppt[0].className);d=(e.getTime()-b(c.start).getTime())/864e5;c.start=this._addDays(c.start,d);c.end=this._addDays(c.end,d);this.updateEvent(c)}},_onDayViewAllDayMouseOver:function(e){var d=a(e.target).parents(".wijmo-wijev-dayheadercolumn"),b=this.__targetAppt.parents(".wijmo-wijev-daycolumn"),c;if(d.length<1)return;if(b.length>0){c=a(this._getAllDayEventMarkup(this.findEventById(this.__targetAppt[0].className)));this._movedFromTimeInervalApptElem=this.__targetAppt[0].cloneNode(true);this.__targetAppt.replaceWith(c);this.__targetAppt=c}else b=this.__targetAppt.parents(".wijmo-wijev-dayheadercolumn");if(b.length<1)return;if(d[0].className!==b[0].className){this.__targetAppt[0].parentNode.removeChild(this.__targetAppt[0]);this._resolveDayViewAppointmentConflicts(b);this.__targetAppt.appendTo(a(d).find(".wijmo-wijev-allday-cell"));this._apptMovedFlag=true}},_renderMonthView:function(){var m=this.options,d=m.selectedDate,t=m.firstDayOfWeek,i=false,j=false,c,g,h,u=new Date,e,p,o=false,f,q=["","","","","","",""],b,l,k=this.element.find(".wijmo-wijev-view.wijmo-wijev-monthview"),n,s=m.dayHeaderFormat,r=m.firstRowDayHeaderFormat;if(!d)d=new Date;g=new Date(d.getFullYear(),d.getMonth(),1);while(g.getDay()!==t)g=this._addDays(g,-1);h=new Date(d.getFullYear(),d.getMonth(),this._daysInMonth(d.getMonth(),d.getFullYear()));c=g;e=0;p=0;while(c<h||e<7){if(c>h)h=c;b="";f="wijmo-wijev-monthcellcontainer ui-widget-content "+this._dayDateToCssClass(c);j=c.getMonth()!==d.getMonth();if(j)f+=" wijmo-wijev-othermonth";if(o)o=false;else{f+=" wijmo-wijev-leftborder";if(e===6)f+=" wijmo-wijev-rightborder"}i=this._compareDayDates(c,u)===0;if(i){f+=" wijmo-wijev-today";f+=" wijmo-wijev-rightborder";o=true}b+='<div class="'+f+'">';b+='<div class="wijmo-wijev-monthcellheader';if(j)b+=" ui-priority-secondary";if(i)b+=" ui-state-highlight";b+='">';if(i)b+='<span class="wijmo-wijev-todaylabel">'+this.localizeString("labelToday","Today")+"</span>";if(p===0)b+=this._formatString(r,c);else b+=this._formatString(s,c);b+="</div>";b+='<div class="wijmo-wijev-monthcell';if(j)b+=" ui-priority-secondary";if(i)b+=" ui-state-highlight";b+='"></div>';b+="</div>";q[e]=q[e]+b;e+=1;c=this._addDays(c,1);if(e>6){if(c>h)break;e=0;p+=1}}if(k.length===0){k=a('<div class="wijmo-wijev-view wijmo-wijev-monthview ui-widget-content"><h3 class="wijmo-wijev-header-title">title</h3><div class="wijmo-wijev-monthview-inner"></div></div>');k.appendTo(this.element.find(".wijmo-wijev-view-container"))}n=k.find(".wijmo-wijev-monthview-inner");n.find(".wijmo-wijev-monthcolumn").remove();c=g;for(l=0;l<7;l+=1){n.append('<div class="wijmo-wijev-monthcolumn">'+q[l]+"</div>");c=this._addDays(c,1)}this._invalidateMonthView();this._renderMonthViewAppointments()},_invalidateMonthView:function(){var f=this.element.find(".wijmo-wijev-monthview"),c=f.find(".wijmo-wijev-monthview-inner"),b=f.find(".wijmo-wijev-monthcolumn"),j=f.find(".wijmo-wijev-monthcellcontainer"),n=this.element.find(".wijmo-wijev-monthview .wijmo-wijev-header-title"),d,e,g,i,l,m,h,k;this._invalidateView();if(b.length<1)return;d=f.innerWidth();e=f.innerHeight()-n.outerHeight(true);c.outerWidth(d);c.outerHeight(e);d=d-(c.outerWidth(true)-c.innerWidth());e=e-(c.outerHeight(true)-c.innerHeight());g=Math.floor(d/b.length);b.outerWidth(g);k=d-g*b.length;k>0&&a(b[b.length-1]).outerWidth(g+k);h=a(b[0]).find(".wijmo-wijev-weekdayname").outerHeight(true);if(!h)h=0;i=Math.floor((e-h)/a(b[0]).find(".wijmo-wijev-monthcellcontainer").length);j.height(i);l=a(j[0]).find(".wijmo-wijev-monthcellheader").outerHeight(true);m=i-l;j.find(".wijmo-wijev-monthcell").outerHeight(m)},_renderMonthViewAppointments:function(){var h=this._eventsView,b,d,e,i,l,f=this.element.find(".wijmo-wijev-monthcellcontainer"),g,c,k,j;if(h)for(e=0,l=f.length;e<l;e+=1){g=f[e];c=this._parseDateFromClass(g.className);k=new Date(c.getFullYear(),c.getMonth(),c.getDate(),23,59,59);for(d=0,i=h.length;d<i;d+=1){b=h[d];if(b.start<k&&b.end>c){j=a('<div class="wijmo-wijev-appointment '+this._eventIdToCssClass(b.id)+'"><div class=" wijmo-wijev-colordot wijmo-wijev-event-color-'+(b.color||"default")+'"></div><div class="wijmo-wijev-event-title">'+b.subject+"</div></div>");a(g).find(".wijmo-wijev-monthcell").append(j)}}}f.find(".wijmo-wijev-monthcell").each(a.proxy(function(i,h){var b=a(h),e=b.find(".wijmo-wijev-appointment"),f=b.outerHeight(),d=e.outerHeight(),g=e.length*d,c=0;if(g>f){e.each(function(b,a){if(b*d+d>f){a.style.display="none";c+=1}});if(c>0)b.find(".wijmo-wijev-monthcell-showmore").length<1&&b.append(a('<div class="wijmo-wijev-monthcell-showmore">'+this._formatString(this.localizeString("monthCellMoreEventsFormat","{0}  more..."),c)+"</div>"))}},this))},log:function(){},_log:function(d,c){var b;if(this.logPanel){b=new Date;this.logPanel.prepend(a('<span class="'+(c?c:"wijmo-wijev-information")+'">['+b.getHours()+":"+b.getMinutes()+":"+b.getSeconds()+"] "+d+"</span><br/>"))}},_createLogPanel:function(){if(!this.logPanel){this.logDialog=a('<div title="Log"><div class="wijmo-wijev-log"></div></div>');this.logDialog.appendTo(this.element);var b={};b[this.localizeString("buttonClearAll","Clear All")]=function(){a(this).find(".wijmo-wijev-log").html("")};b[this.localizeString("buttonClose","Close")]=function(){a(this).wijdialog("close")};this.logPanel=this.logDialog.wijdialog({captionButtons:{},buttons:b,width:600,height:420,position:["right","top"]}).find(".wijmo-wijev-log")}this.logDialog.wijdialog("open")},status:function(b,a){this.element.find(".wijmo-wijev-statusbar").html("<span class='"+(a?a:"wijmo-wijev-status")+"'>"+b+"</span>");this.log(b,a?a:"wijmo-wijev-status")},_invalidateView:function(){var n=this.element.find(".wijmo-wijev-rightpane"),h=this.element.find(".wijmo-wijev-leftpane"),p=this.element.find(".wijmo-wijev-headerbar"),k=this.element.find(".wijmo-wijev-navigationbar"),o=this.element.find(".wijmo-wijev-statusbar"),b=this.element.find(".wijmo-wijev-view-container"),r=this.element.find(".wijmo-wijev-view"),l,c,j,f,i,q,g,d,m,e;l=this.element.innerWidth()-(b.outerWidth(true)-b.innerWidth());c=this.element.innerHeight()-(b.outerHeight(true)-b.innerHeight());j=p.is(":visible")?p.outerHeight(true):0;f=k.is(":visible")?k.outerHeight(true):0;i=o.is(":visible")?o.outerHeight(true):0;b.outerWidth(l);b.outerHeight(c-j-f-i);d=0;for(e=0;e<h.length;e+=1)if(a(h[e]).is(":visible"))d+=a(h[e]).outerWidth();m=n.is(":visible")?n.outerWidth():0;q=c-j-f-i;g=l-m-d-1;r.outerHeight(q);r.outerWidth(g);p.outerWidth(g+d);k.outerWidth(this.element.innerWidth());o.outerWidth(g+d+m);h.outerHeight(c-j-f-i);n.outerHeight(c+100);this.element.find(".wijmo-wijev-datepager").wijdatepager("refresh")},_daysInMonth:function(a,b){var c=new Date(b,a+1,0);return c.getDate()},_addMinutes:function(a,b){return new Date(a.getFullYear(),a.getMonth(),a.getDate(),a.getHours(),a.getMinutes()+b)},_addDays:function(a,b){return new Date(a.getFullYear(),a.getMonth(),a.getDate()+b,a.getHours(),a.getMinutes(),a.getSeconds(),a.getMilliseconds())},_setTime:function(a,b,d){var c;a=new Date(a);a.setHours(b.getHours());a.setMinutes(b.getMinutes());a.setSeconds(b.getSeconds());a.setMilliseconds(b.getMilliseconds());if(d){c=Math.floor((b.getTime()-d.getTime())/864e5);if(c>0)a=this._addDays(a,c)}return a},_addMonths:function(a,b){return new Date(a.getFullYear(),a.getMonth()+b,a.getDate())},_compareDayDates:function(a,b){a=new Date(a.getFullYear(),a.getMonth(),a.getDate());b=new Date(b.getFullYear(),b.getMonth(),b.getDate());return a<b?-1:a>b?1:0},_dayDateToCssClass:function(a){return"wijmo-wijev-date_"+a.getFullYear()+"_"+a.getMonth()+"_"+a.getDate()},_parseDateFromClass:function(e,d,g){var c,a,b,h=new RegExp("wijmo-wijev-minute-(\\d+)\\s"),f=new RegExp("wijmo-wijev-date_(\\d+_\\d+_\\d+)\\s");if(e){b=f.exec(e+" ")[1].split("_");c=new Date(parseInt(b[0],10),parseInt(b[1],10),parseInt(b[2],10));if(d){a=h.exec(d+" ");if(a){a=parseInt(a[1],10);c.setMinutes(a)}}return c}else return g||null},_eventIdToCssClass:function(a){return"apptid_"+a},_parseEventIdFromClass:function(d){var c="",b,a;b=new RegExp("apptid_(\\S+)");a=b.exec(d);if(a&&a.length>1)c=a[1];return c},_isContainsDayDate:function(b,c){var a;if(b){for(a=0;a<b.length;a+=1)if(this._compareDayDates(b[a],c)===0)return true}else return false},_formatString:function(a){var e,b=arguments,c,d,f=this;if(b.length<=1)return Globalize.format(b);if(typeof a==="string")if(a==="_formatWeekTitle")a=this._formatWeekTitle;else if(a==="_formatMonthTitle")a=this._formatMonthTitle;else if(typeof window[a]==="function")a=window[a];if(typeof a==="function"){d=[];for(c=1;c<b.length;c+=1)d[c-1]=b[c];return a.apply(this,d)}e=new RegExp("\\{(\\d+)(?:,([-+]?\\d+))?(?:\\:([^(^}]+)(?:\\(((?:\\\\\\)|[^)])+)\\)){0,1}){0,1}\\}","g");return a.replace(e,function(a,d,g,c){a=b[Number(d)+1];return c?Globalize.format(a,c,f._getCulture()):a})},_formatMonthTitle:function(a){return this._formatString(this.localizeString("monthViewHeaderFormat","{0:MMMM yyyy}"),a)},_formatWeekTitle:function(a,b){return a.getMonth()!==b.getMonth()?this._formatString(this.localizeString("weekViewHeaderFormat2Months","{0:MMMM} - {1:MMMM yyyy}"),a,b):this._formatString(this.localizeString("weekViewHeaderFormat","{0:MMMM yyyy}"),a)},_formatDayHeaderDate:function(c){var d=this.options,b=d.viewType.toLowerCase(),a=this.options.dayViewHeaderFormat;if(a[b])a=a[b];else if(!a[b])return"";return this._formatString(a,c)},_getCulture:function(a){return Globalize.findClosestCulture(a||this.options.culture)},_isRTL:function(){return!!this._getCulture().isRTL},_onAjaxError:function(d,a,b){if(a){this.status("Ajax error "+a.status+" ("+a.statusText+")","error");this.log("Error, requested url: "+b.url,"error");a.responseText&&this.log("Error, response text: "+a.responseText,"error")}else{this.status("Ajax error detected.","error");this.log("Error, requested url: "+b.url,"error")}},_onWindowResize:function(){this.invalidate()}})})(jQuery);