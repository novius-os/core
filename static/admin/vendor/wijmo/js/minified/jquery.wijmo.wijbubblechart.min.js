/*
 *
 * Wijmo Library 2.3.7
 * http://wijmo.com/
 *
 * Copyright(c) GrapeCity, Inc.  All rights reserved.
 * 
 * Licensed under the Wijmo Commercial License. Also available under the GNU GPL Version 3 license.
 * licensing@wijmo.com
 * http://wijmo.com/widgets/license/
 *
 *
 **/
(function(a){"use strict";var d=0,c=0,b=0;a.widget("wijmo.wijbubblechart",a.wijmo.wijchartcore,{options:{minimumSize:5,maximumSize:20,sizingMethod:"diameter",animation:{enabled:true,duration:1e3,easing:">"},seriesTransition:{enabled:true,duration:400,easing:">"},seriesList:[],seriesHoverStyles:[{opacity:1,"stroke-width":5},{opacity:1,"stroke-width":5},{opacity:1,"stroke-width":5},{opacity:1,"stroke-width":5},{opacity:1,"stroke-width":5},{opacity:1,"stroke-width":5},{opacity:1,"stroke-width":5},{opacity:1,"stroke-width":5},{opacity:1,"stroke-width":5},{opacity:1,"stroke-width":5},{opacity:1,"stroke-width":5},{opacity:1,"stroke-width":5}],chartLabel:{position:"inside",compass:"north",visible:true,style:{},chartLabelFormatString:""},mouseDown:null,mouseUp:null,mouseOver:null,mouseOut:null,mouseMove:null,click:null},widgetEventPrefix:"wijbubblechart",_setOption:function(b,d){var c=this,e=c.options;if(b==="minimumSize"||b==="minimumSize"){if(isNaN(d)||d<0)d=0;e[b]=d;c.redraw()}else if(b==="chartLabel"){a.extend(e.chartLabel,d);c.redraw()}else{if(b==="showChartLabels"||b==="chartLabelStyle"){e[b]=d;c._setLabelOption()}a.wijmo.wijchartcore.prototype._setOption.apply(c,arguments)}if(b==="seriesList"){c.indexs=null;c.bubbleRadius=null}},_create:function(){var b=this,d=b.options,c=b._getDefFill();this._hotFixForJQ1_9();a.each(d.seriesStyles,function(b,a){if(!a.fill)a.fill=c[b]});b._setLabelOption();a.wijmo.wijchartcore.prototype._create.apply(b,arguments);b.chartElement.addClass("wijmo-wijbubblechart")},_setLabelOption:function(){var b=this.options;if(b.showChartLabels!==true&&b.chartLabel.visible===true)b.chartLabel.visible=false;if(!a.isPlainObject(b.chartLabel.style)&&a.isPlainObject(b.chartLabelStyle))b.chartLabel.style=b.chartLabelStyle},_clearChartElement:function(){var c=this,d=c.options,b=c.chartElement.data("fields");a.wijmo.wijchartcore.prototype._clearChartElement.apply(c,arguments);b&&b.bubbleInfos&&a.each(b.bubbleInfos,function(b,a){a.bubble&&a.bubble.wijRemove();a.dcl&&a.dcl.wijRemove();a.symbol&&a.symbol.wijRemove()});b&&b.bubbles&&c._destroyRaphaelArray(b.bubbles);c.element.removeData("plotInfos");if(!d.seriesTransition.enabled)if(b&&b.bubblesAnimationInfos)b.bubblesAnimationInfos=null},destroy:function(){var b=this;b.chartElement.removeClass("wijmo-wijbubblechart ui-helper-reset");b._destroyEles();a.wijmo.wijchartcore.prototype.destroy.apply(b,arguments)},_destroyEles:function(){var b=this,d=b.element,c=d.data("fields");c.bubbleInfos&&a.each(c.bubbleInfos,function(c,a){b._removeEle(a.bubble);b._removeEle(a.dcl);b._removeEle(a.symbol);a=null});d.removeData("fields");b.bubbleRadius=[]},_removeEle:function(b){if(b){b.node&&a(b.node).removeData();b.wijRemove();b=null}},_paintPlotArea:function(){var b=this,f=this.chartElement,c=b.options,e=c.seriesList,d=e.length,i=[].concat(c.seriesStyles.slice(0,d)),g=[].concat(c.seriesHoverStyles.slice(0,d)),h=b.canvasBounds,j=b.axisInfo.x,k=b.axisInfo.y[0];if(d===0)return;b._prepBubbleData();f.wijbubble({seriesList:e,seriesStyles:i,seriesHoverStyles:g,canvas:b.canvas,bounds:h,xAxisInfo:j,yAxisInfo:k,chartLabel:c.chartLabel,textStyle:c.textStyle,chartLabelStyle:c.chartLabelStyle,chartLabelFormatString:c.chartLabelFormatString,bubbleRadius:b.bubbleRadius,animation:c.animation,seriesTransition:c.seriesTransition,sizingMethod:c.sizingMethod,minimumSize:c.minimumSize,maximumSize:c.maximumSize,mouseDown:a.proxy(b._mouseDown,b),mouseUp:a.proxy(b._mouseUp,b),mouseOver:a.proxy(b._mouseOver,b),mouseOut:a.proxy(b._mouseOut,b),mouseMove:a.proxy(b._mouseMove,b),click:a.proxy(b._click,b),disabled:c.disabled,culture:b._getCulture(),widget:this});b.tooltipbubbles=[];a.each(f.data("fields").bubbleInfos,function(c,a){b.tooltipbubbles.push(a.bubble);a.dcl&&b.tooltipbubbles.push(a.dcl);a.symbol&&b.tooltipbubbles.push(a.symbol)});b.tooltip&&b.tooltip.setTargets(b.tooltipbubbles)},_paintLegend:function(){var b=this,l=b.options,d=0,n=0,g=0,h=null,m=l.seriesList,q=l.seriesStyles,e=null,k=null,f=null,o=0,p=0,r=0,i=null,j=null,c=null;a.wijmo.wijchartcore.prototype._paintLegend.apply(b,arguments);if(l.legend.visible){if(b.legends.length&&b.legendIcons.length)for(d=0,n=b.legendIcons.length;d<n;d++){h=b.legendIcons[d];h.attr({fill:h.attr("stroke")})}if(!l.legend.reversed)for(d=0,n=m.length;d<n;d++){e=m[d];k=q[d];if(e.legendEntry){if(e.markers)j=e.markers.type;h=b.legendIcons[g];f=h.wijGetBBox();o=f.x+f.width/2;p=f.y+f.height/2;r=Math.min(f.width,f.height);i=e.markerStyle;i=a.extend({fill:k.stroke,stroke:k.stroke,opacity:1},i);if(!j)j="circle";c=b.canvas.paintMarker(j,o,p,r/2);a.wijraphael.addClass(a(c.node),"chart-legend-dot wijchart-canvas-object wijchart-legend");c.attr(i);a(c.node).data("index",d).data("legendIndex",g);h.remove();b.legendIcons[g]=c;if(!!e.visible){if(l.legend.textWidth)a(b.legends[g][0].node).data("dotOpacity",c.attr("opacity")||1);else a(b.legends[g].node).data("dotOpacity",c.attr("opacity")||1);c.attr("opacity",.3)}g++}}else for(d=m.length-1;d>=0;d--){e=m[d];k=q[m.length-1-d];if(e.legendEntry){if(e.markers)j=e.markers.type;h=b.legendIcons[g];f=h.wijGetBBox();o=f.x+f.width/2;p=f.y+f.height/2;i=e.markerStyle;i=a.extend({fill:k.stroke,stroke:k.stroke,opacity:1},i);if(!j)j="circle";c=b.canvas.paintMarker(j,o,p,7);a.wijraphael.addClass(a(c.node),"chart-legend-dot");c.attr(i);h.remove();b.legendIcons[g]=c;if(!!e.visible){if(l.legend.textWidth)a(b.legends[g][0].node).data("dotOpacity",c.attr("opacity")||1);else a(b.legends[g].node).data("dotOpacity",c.attr("opacity")||1);c.attr("opacity",.3)}g++}}}},_getbubbleIndexs:function(m,l){var d=this,e=d.options,o=e.axis.x.max,p=e.axis.x.min,t=e.axis.y.min,s=e.axis.y.max,q=[],u=[],n=[],r=[],f=[],g=[],i=-1,k=-1,h=-1,j=-1;d.bubbleRadius=[];d._prepBubbleData();a.each(e.seriesList,function(v,i){var h=i.data,k=i.markers||{},j=k.type||"circle";if(h.y1===undefined)return true;a.each(h.y1,function(k,x){var w=a.wijbubble.transform(x,e.maximumSize,e.minimumSize,d.canvasBounds,c,b,e.sizingMethod,j),v,i;if(d._isDate(h.x[k]))v=a.toOADate(h.x[k]);else if(isNaN(h.x[k]))v=k;else v=h.x[k];i=h.y[k];if(d._isDate(i))i=a.toOADate(i);q.push(v-w*(o-p)/m);u.push(i-w*(s-t)/l);n.push(v+w*(o-p)/m);r.push(i+w*(s-t)/l);f.push(v);g.push(i);d.bubbleRadius.push(w)})});i=d._getMinIndex(q);k=d._getMinIndex(u);h=d._getMaxIndex(n);j=d._getMaxIndex(r);d.indexs={xMin:{x:f[i],y:g[i],r:d.bubbleRadius[i]},xMax:{x:f[h],y:g[h],r:d.bubbleRadius[h]},yMin:{x:f[k],y:g[k],r:d.bubbleRadius[k]},yMax:{x:f[j],y:g[j],r:d.bubbleRadius[j]}}},_calculateParameters:function(c,b){a.wijmo.wijchartcore.prototype._calculateParameters.apply(this,arguments);var d=this;if(!b.autoMax&&!b.autoMin)return;d._adjust(b,c)},_adjust:function(e,b){var g=e.unitMinor,a=this,l=e.autoMin,k=e.autoMax,f=a.canvasBounds,j={x:f.startX,y:f.startY},i=f.endX-j.x,h=f.endY-j.y,c=b.max,d=b.min;!a.indexs&&a._getbubbleIndexs(i,h);if(b.id==="x"){if(l)d=a._getMinTick(a.indexs.xMin.x,a.indexs.xMin.r,d,c,i,g);if(k)c=a._getMaxTick(a.indexs.xMax.x,a.indexs.xMax.r,d,c,i,g)}else{if(l)d=a._getMinTick(a.indexs.yMin.y,a.indexs.yMin.r,d,c,h,g);if(k)c=a._getMaxTick(a.indexs.yMax.y,a.indexs.yMax.r,d,c,h,g)}if(c!==b.max||d!==b.min){b.min=d;b.max=c;this._calculateMajorMinor(e,b);a._adjust(e,b)}},_getMinTick:function(e,f,a,d,c,b){return(e-a)*c/(d-a)<f?a-b:a},_getMaxTick:function(e,f,c,a,b,d){return(e-c)*b/(a-c)+f>b?a+d:a},_getMinIndex:function(d){var c=-1,b=0;a.each(d,function(c,a){if(c===0)b=a;else if(a<b)b=a});a.each(d,function(a,d){if(d===b){c=a;return false}});return c},_getMaxIndex:function(d){var c=-1,b=0;a.each(d,function(c,a){if(c===0)b=a;else if(a>b)b=a});a.each(d,function(a,d){if(d===b){c=a;return false}});return c},_showSerieEles:function(b){a.each(b,function(c,b){if(b.bubble){b.bubble.show();b.bubble.tracker&&b.bubble.tracker.show();if(a(b.bubble.node).data("wijchartDataObj"))a(b.bubble.node).data("wijchartDataObj").visible=true}b.dcl&&b.dcl.show();b.symbol&&b.symbol.show()})},_hideSerieEles:function(b){a.each(b,function(c,b){if(b.bubble){b.bubble.hide();b.bubble.tracker&&b.bubble.tracker.hide();if(a(b.bubble.node).data("wijchartDataObj"))a(b.bubble.node).data("wijchartDataObj").visible=false}b.dcl&&b.dcl.hide();b.symbol&&b.symbol.hide()})},_indicatorLineShowing:function(b){a.wijmo.wijchartcore.prototype._indicatorLineShowing.apply(this,arguments);a.each(b,function(b,a){a.bubble&&a.bubble.attr(a.hoverStyle)})},_removeIndicatorStyles:function(b){a.each(b,function(b,a){a.bubble&&a.bubble.attr(a.style)})},_parseTable:function(){if(!this.element.is("table"))return;var e=this,f=e.element,b=e.options,c=a("caption",f),m=a("thead th",f),g=[],n=a("tbody tr",f),l=null,k=null,i=[],j=[],h=[],d=function(b){var c=a.trim(b);if(!isNaN(b))c=parseFloat(b);return c};if(c.length){b.header=a.extend({visible:true,text:a.trim(a(c[0]).text())},b.header);if(c.length>1)b.footer=a.extend({visibel:true,text:a.trim(a(c[1]).text())},b.footer)}b.legend=a.extend({visible:true},b.legend);l=a.trim(m.eq(1).text());n.each(function(e,c){var b=a("td",c);if(b.length>=3){i.push(d(b.eq(0).text()));j.push(d(b.eq(1).text()));h.push(d(b.eq(2).text()))}});k={label:l,legendEntry:true,data:{x:i,y:j,y1:h}};g.push(k);e.options.seriesList=g},_unbindLiveEvents:function(){var b=this;a(".wijbubblechart-bubble",b.chartElement[0]).die(".wijbubblechart").die("wijbubblechart");if(b.tooltip){b.tooltip.destroy();b.tooltip=null}},_paintTooltip:function(){var c=this,b=c.chartElement.data("fields");a.wijmo.wijchartcore.prototype._paintTooltip.apply(this,arguments);if(c.tooltip)if(b&&b.trackers&&b.trackers.length){c.tooltip.setTargets(b.trackers);c.tooltip.setOptions({relatedElement:b.trackers[0]})}},_getTooltipText:function(e,d){var c=a(d.node),b,f;if(c.data("owner"))c=c.data("owner");b=c.data("wijchartDataObj");f={data:b,value:b.value,label:b.label,total:b.total,target:d,fmt:e,x:b.x,y:b.y,y1:b.y1};return a.proxy(e,f)()},_prepBubbleData:function(){var i=this,h=i.options.seriesList,f=-999999999999,g=9999999999999,e;a.each(h,function(c,b){e=b.data;e&&e.y1&&a.each(e.y1,function(b,a){f=Math.max(f,a);g=Math.min(g,a)})});d=f;c=g;b=f-g},getBubble:function(a){return this.chartElement.data("fields").bubbles[a]}});a.fn.extend({wijbubble:function(e){var m=this,d=e,f=m.data("fields")||{},o=0,h=d.bounds,i=d.canvas,D=a.arrayClone(d.seriesList),z=d.seriesStyles,u=d.seriesHoverStyles,I=d.xAxisInfo,J=d.yAxisInfo,k={x:h.startX,y:h.startY},Q=h.endX-k.x,O=h.endY-k.y,j=d.chartLabel,q=[],r=[],F=d.mouseDown,N=d.mouseUp,H=d.mouseOver,L=d.mouseOut,G=d.mouseMove,P=d.click,p=[],K=d.disabled,l=i.set(),M=d.culture,g=d.widget;function n(d,b){var a=d.bubble,e=d.symbol,c;if(a.type==="circle")a.attr({r:.0001,cx:b.startX,cy:b.endY});else{a.transform("s0.01");c=a.wijGetBBox();a.transform("t"+(b.startX-c.x)+","+(b.endY-c.y)+"s0.001")}e&&e.hide()}function x(){var b=d.animation,k=d.bounds,h=f.bubblesAnimationInfos,i=[],j=f.bubbleInfos,c=d.seriesTransition,e,g,l;if(b&&b.enabled){e=b.duration||400;g=b.easing;a.each(j,function(m,f){var a=f.bubble,j,b,d=a.wijGetBBox();if(a.type==="circle")j={r:a.attr("r"),cx:a.attr("cx"),cy:a.attr("cy")};else j={transform:"S1T0,0","stroke-width":a.attr("stroke-width"),width:d.width,x:d.x,y:d.y};if(h&&c.enabled){b=h[m];if(b){if(a.type==="circle")a.attr({cx:b.cx,cy:b.cy,r:b.r});else{d=a.wijGetBBox();l=b.width/d.width;a.transform("s"+l);d=a.wijGetBBox();a.transform("t"+(b.x-d.x)+","+(b.y-d.y)+"")}e=c.duration;g=c.easing}else n(f,k)}else n(f,k);i.push(j);a.wijAnimate(j,e,g,function(){f.dcl&&f.dcl.attr("opacity",1);f.symbol&&f.symbol.show()})});f.bubblesAnimationInfos=i}else a.each(j,function(b,a){a.dcl&&a.dcl.attr("opacity",1)})}function E(c,d){var b;a.each(c,function(a,c){if(a===d){b=c;return false}});return b}function v(c,d){var b=true;a.each(c,function(c,a){if(d===a){b=false;return false}});return b}function C(b,d,e,c){var a;if(i[b])a=i[b](d,e,c);return a}function A(d){var b=i.text(0,0,d),a=b.wijGetBBox(),c;c={width:a.width,height:a.height};b.remove();return c}function t(a,f){var d=e.chartLabel.compass||"north",b=A(f),c=a.r;switch(d){case"north":a.y-=c+b.height/2;break;case"south":a.y+=c+b.height/2;break;case"east":a.x+=c+b.width/2;break;case"west":a.x-=c+b.width/2}}function s(f,h){var g=a.extend(true,{},e.textStyle,e.chartLabelStyle,j.style),c=a.round(h,2),b=j.chartLabelFormatString===""?e.chartLabelFormatString:j.chartLabelFormatString,d;if(b&&b.length)c=Globalize.format(c,b,M);d=i.text(f.x,f.y,c).attr(g);return d}function B(n,z,x,u,w,I,H){var k=n.data,G=u.min,K=w.min,J=u.max,F=w.max,L=I/(J-G),M=H/(F-K),B=[],y=e.bubbleRadius,d,D,A,m;if(k.y1===undefined)return;a.each(k.y1,function(O,S){if(k.x===undefined||k.y===undefined)return true;var P=k.x[O],T=k.y[O],X=n.markers||{},W=X.type||"circle",Y=X.symbol,Z=n.invisibleMarkLabels||[],V,U,J,q,Q,R,K,N,I,H;if(y){I=y[o];o++}else I=a.wijbubble.transform(S,e.maximumSize,e.minimumSize,e.bounds,c,b,e.sizingMethod,W);if(u.isTime)P=a.toOADate(P);else if(isNaN(P))P=O;if(w.isTime)T=a.toOADate(T);Q=h.startX+(P-G)*L;R=h.startY+(F-T)*M;if(Y)K=E(Y,O);q=C(W,Q,R,I);q.attr(z);if(K){D=K.width||I*2;A=K.height||I*2;N=i.image(K.url,Q-I,R-I,D,A)}a.wijraphael.addClass(a(q.node),"wijchart-canvas-object wijbubblechart-bubble");K&&q.attr("opacity",.1);J=a.extend(false,{index:O,bubble:q,style:z,y1:S,x:P,y:T,type:"bubble",hoverStyle:x,visible:true},n);if(K){J.symbol=true;J.hoverStyle=a.extend({},x,{opacity:.1});a(N.node).data("wijchartDataObj",J);a.wijraphael.addClass(a(N.node),"wijbubblechart-symbol")}a(q.node).data("wijchartDataObj",J);g.dataPoints=g.dataPoints||{};g.pointXs=g.pointXs||[];m=a.round(Q,2);if(!g.dataPoints[m.toString()]){g.dataPoints[m.toString()]=[];g.pointXs.push(m)}g.dataPoints[m.toString()].push(J);H=q.clone();if(a.browser.msie&&a.browser.version<9)H.attr({opacity:.01,fill:"white","stroke-width":0,"fill-opacity":.01});else H.attr({opacity:.01,fill:"white","fill-opacity":.01});a(H.node).data("owner",a(q.node));a.wijraphael.addClass(a(H.node),"wijchart-canvas-object wijbubblechart-bubble bubbletracker");q.tracker=H;l.push(H);r.push(q);f.bubbles=r;V={x:Q,y:R,r:I};if(j.visible&&v(Z,O)){j.position==="outside"&&t(V,S);d=s(V,S);d.attr("opacity",0);a(d.node).data("wijchartDataObj",J);a.wijraphael.addClass(a(d.node),"wijbubblechart-label")}U={bubble:q,dcl:d,symbol:N};p.push(U);B.push(U);if(n.visible===false){q.hide();d&&d.hide();H.hide();N&&N.hide()}});f.bubbleInfos=p;q.push(B)}function y(){a.each(D,function(a,d){var c=z[a],b=u[a];B(d,c,b,I,J,Q,O,k)})}function w(b,d,i,f,g,e,j,c){var h={mousedown:function(g){if(c)return;var e=a(g.target),f;if(e.data("owner"))e=e.data("owner");f=e.data("wijchartDataObj");d.call(b,g,f)},mouseup:function(f){if(c)return;var d=a(f.target),e;if(d.data("owner"))d=d.data("owner");e=d.data("wijchartDataObj");i.call(b,f,e)},mouseover:function(g){if(c)return;var d=a(g.target),e;if(d.data("owner"))d=d.data("owner");e=d.data("wijchartDataObj");f.call(b,g,e)},mouseout:function(h){if(c)return;var f=a(h.target),d,e;if(f.data("owner"))f=f.data("owner");d=f.data("wijchartDataObj");e=d.bubble;if(d.symbol)return;if(!d.hoverStyle)e&&e.attr({opacity:"1"});else{d.hoverStyle["stroke-width"]&&!d.style["stroke-width"]&&e.attr("stroke-width","");e.attr(d.style);d.style.opacity&&e.attr("opacity",d.style.opacity)}g.call(b,h,d)},mousemove:function(h){if(c)return;var g=a(h.target),d,f;if(g.data("owner"))g=g.data("owner");d=g.data("wijchartDataObj");f=d.bubble;if(!d.hoverStyle)f&&f.attr({opacity:"0.8"});else f.attr(d.hoverStyle);e.call(b,h,d)},click:function(f){if(c)return;var d=a(f.target),e;if(d.data("owner"))d=d.data("owner");e=d.data("wijchartDataObj");j.call(b,f,e)}};a.each(["click","mouseover","mouseout","mousemove","mousedown","mouseup"],function(d,c){a(".bubbletracker",b).bind(c+".wijbubblechart",h[c])})}y();f.seriesEles=q;x();l.toFront();f.trackers=l;w(m,F,N,H,L,G,P,K);m.data("fields",f)}});a.wijbubble={transform:function(n,k,e,c,o,j,g,i){var f,b=n,h=k-e,m=c.endX-c.startX,l=c.endY-c.startY;if(b<0)b=0;if(j===0)b=1;else b/=d;b=a.wijbubble.transformByArea(b,g,i);b*=h;b+=e;f=Math.min(m,l);b*=f/200;return b},transformByArea:function(d,b,c){var a=d;if(b==="area")switch(c){case"circle":a=Math.sqrt(a/Math.PI);break;case"tri":case"invertedTri":a=Math.sqrt(a/(3*Math.sin(Math.PI/6)*Math.cos(Math.PI/6)));break;case"box":a=Math.sqrt(a/2);break;case"diamond":case"cross":a=Math.sqrt(a/2);break;default:a=Math.sqrt(4*a/Math.PI)}return a}}})(jQuery);