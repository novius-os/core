/*
 *
 * Wijmo Library 2.3.7
 * http://wijmo.com/
 *
 * Copyright(c) GrapeCity, Inc.  All rights reserved.
 * 
 * Licensed under the Wijmo Commercial License. Also available under the GNU GPL Version 3 license.
 * licensing@wijmo.com
 * http://wijmo.com/widgets/license/
 *
 *
 **/
(function(a){"use strict";var r="wijmo-wijupload",j="wijmo-wijupload-fileRow",c="."+j,u="wijmo-wijupload-filesList",t="wijmo-wijupload-commandRow",i="wijmo-wijupload-uploadAll",h="wijmo-wijupload-cancelAll",s="wijmo-wijupload-buttonContainer",m="wijmo-wijupload-upload",f="."+m,l="wijmo-wijupload-cancel",n="."+l,v="wijmo-wijupload-file",b="wijmo-wijupload-progress",k="wijmo-wijupload-loading",w="ui-widget-content",o="ui-corner-all",x="ui-state-highlight",q,p,d=function(a){if(a.indexOf("\\")>-1)a=a.substring(a.lastIndexOf("\\")+1);return a},g=function(c){var e=c.files,b="";if(e){a.each(e,function(c,a){b+=d(a.name)+"; "});if(b.length)b=b.substring(0,b.lastIndexOf(";"))}else b=d(c.value);return b},e=function(d){var b=d.files,c=0;b&&b.length>0&&a.each(b,function(b,a){if(a.size)c+=a.size});return c};q=function(l,f,h){var c,b=a("input",f),k=function(a){if(a){a.abort();a=null}},j=function(a){if(a)a=null},i=function(){var c=this,l=b.get(0).files,m=[],i=0,n=0,p=function(j,h){var f=new XMLHttpRequest;f.open("POST",h,true);f.setRequestHeader("Wijmo-RequestType","XMLHttpRequest");f.setRequestHeader("Cache-Control","no-cache");f.setRequestHeader("Wijmo-FileName",j);f.setRequestHeader("Content-Type","application/octet-stream");f.upload.onprogress=function(h){if(h.lengthComputable){var f;if(a.isFunction(c.onProgress)){f={supportProgress:true,loaded:n+h.loaded,total:e(b[0]),fileName:d(c.currentFile.name),fileNameList:g(b[0]).split("; ")};c.onProgress(f)}}};f.onreadystatechange=function(e){if(this.readyState===4){var d=this.responseText,b;n+=l[i].size;i++;if(l.length>i)o(l[i]);else if(a.isFunction(c.onComplete)){b={e:e,response:d,supportProgress:true};c.onComplete(b)}}};m.push(f);return f},o=function(a){var e=d(a.name),b=p(e,h);c.handleRequest(b,a);c.currentFile=a;b.send(a)};c.fileRow=f;c.inputFile=b;c.upload=function(){o(l[i])};c.cancel=function(){a.each(m,function(b,a){k(a)});a.isFunction(c.onCancel)&&c.onCancel()};c.destroy=function(){a.each(m,function(b,a){j(a)})};c.updateAction=function(a){h=a};c.handleRequest=null;c.onCancel=null;c.onComplete=null;c.onProgress=null};c=new i;return c};p=function(n,j,l){var i,d=a("input",j),m=d.attr("id"),e="wijUploadForm_"+n,b=a("#"+e),g="wijUploadIfm_"+m,f=true,c=a('<iframe id="'+g+'" name="'+g+'">'),k=function(c,a){b.empty();b.attr("target",c.attr("name"));if(a){a.parent().append(a.clone());b.append(a)}b.submit()},p=function(a){a.attr("src","javascript".concat(":false;"))},o=function(a,c){if(c&&b){b.remove();b=null}if(a){a.remove();a=null}},h;if(b.length===0){b=a('<form method="post" enctype="multipart/form-data"></form>');b.attr("action",l).attr("id",e).attr("name",e).appendTo("body")}c.css("position","absolute").css("top","-1000px").css("left","-1000px");c.appendTo("body");h=function(){var e=this;e.fileRow=j;e.iframe=c;e.inputFile=d;e.upload=function(){var b;k(c,d);if(a.isFunction(e.onProgress)){b={supportProgress:false,loaded:1,total:1};e.onProgress(b)}};e.doPost=function(){k(c)};e.cancel=function(){p(c);a.isFunction(e.onCancel)&&e.onCancel()};e.updateAction=function(a){l=a;b.attr("action",a)};e.destroy=function(a){o(c,a)};e.onCancel=null;e.onComplete=null;e.onProgress=null;c.bind("load",function(i){if(!a.browser.safari)if(f&&!e.autoSubmit){f=false;return}if(c.attr("src")==="javascript".concat(":false;"))return;var g=i.target,d,b,h;try{b=g.contentDocument?g.contentDocument:window.frames[0].document;if(b.XMLDocument)d=b.XMLDocument;else if(b.body)d=b.body.innerHTML;else d=b;if(a.isFunction(e.onComplete)){h={e:i,response:d,supportProgress:false};e.onComplete(h)}}catch(j){d=""}})};i=new h;return i};a.widget("wijmo.wijupload",{options:{action:"",autoSubmit:false,change:null,upload:null,totalUpload:null,progress:null,totalProgress:null,complete:null,totalComplete:null,maximumFiles:0,multiple:true,accept:"",enableSWFUploadOnIE:false,swfUploadOptions:{},localization:{},handleRequest:null},_swfAppendAddtionalData:function(a){a.queueData={files:{},filesSelected:0,filesQueued:0,filesReplaced:0,filesCancelled:0,filesErrored:0,uploadsSuccessful:0,uploadsErrored:0,averageSpeed:0,queueLength:0,queueSize:0,uploadSize:0,queueBytesUploaded:0,uploadQueue:[],errorMsg:""};a.widget=this},_swfGetHandlers:function(){var c=this,d=c.element;return{onSelect:function(a){var d=this,b={};c._createFileRow(a);this.queueData.queueSize+=a.size;this.queueData.files[a.id]=a},onDialogOpen:function(){this.queueData.filesReplaced=0;this.queueData.filesCancelled=0},onDialogClose:function(a,b,e){var d=this.settings;this.queueData.filesErrored=a-b;this.queueData.filesSelected=a;this.queueData.filesQueued=b-this.queueData.filesCancelled;this.queueData.queueLength=e;c.isStartUpload=false;if(c.options.autoSubmit){c.uploadAll=true;c._swfUploadFile()}d.onDialogClose&&d.onDialogClose.call(this,this.queueData)},onUploadStart:function(a){this.bytesLoaded=0;if(this.queueData.uploadQueue.length==0)this.queueData.uploadSize=a.size;if(!c.isStartUpload&&c.uploadAll){if(c._trigger("totalUpload",null,null)===false){this.cancelUpload();return false}c.isStartUpload=true}if(c._trigger("upload",null,a)===false){this.cancelUpload(a.id);return false}},onUploadProgress:function(j,e,h){var m=a("#"+j.id,d),f,g,l=Math.round(e/h*100),k=a("."+b,m),n={sender:j.name,loaded:e,total:h},i=this.queueData;k.html(l+"%");c._trigger("progress",null,n);f=i.queueBytesUploaded+e;g=i.queueSize;c._updateSwfProgress(f,g);c._trigger("totalProgress",null,{loaded:f,total:g})},onUploadError:function(e,i,f){var g=this.settings,j=a("#"+e.id,d),h=a("."+b,j),c="Error";switch(i){case SWFUpload.UPLOAD_ERROR.HTTP_ERROR:c="HTTP Error ("+f+")";break;case SWFUpload.UPLOAD_ERROR.MISSING_UPLOAD_URL:c="Missing Upload URL";break;case SWFUpload.UPLOAD_ERROR.IO_ERROR:c="IO Error";break;case SWFUpload.UPLOAD_ERROR.SECURITY_ERROR:c="Security Error";break;case SWFUpload.UPLOAD_ERROR.UPLOAD_LIMIT_EXCEEDED:alert("The upload limit has been reached ("+f+").");c="Exceeds Upload Limit";break;case SWFUpload.UPLOAD_ERROR.UPLOAD_FAILED:c="Failed";break;case SWFUpload.UPLOAD_ERROR.FILE_VALIDATION_FAILED:c="Validation Error";break;case SWFUpload.UPLOAD_ERROR.FILE_CANCELLED:c="Cancelled";this.queueData.queueSize-=e.size;this.queueData.queueLength-=1;if(e.status==SWFUpload.FILE_STATUS.IN_PROGRESS||a.inArray(e.id,this.queueData.uploadQueue)>=0)this.queueData.uploadSize-=e.size;g.onCancel&&g.onCancel.call(this,e);delete this.queueData.files[e.id];break;case SWFUpload.UPLOAD_ERROR.UPLOAD_STOPPED:c="Stopped"}h.text(c);var k=this.getStats();this.queueData.uploadsErrored=k.upload_errors},onUploadSuccess:function(b,i,e){var h=this.getStats();this.queueData.uploadsSuccessful=h.successful_uploads;this.queueData.queueBytesUploaded+=b.size;this.queueData.response=e;var f=a("#"+b.id,d),g=this;g.queueData.queueLength-=1;f.fadeOut(1500,function(){f.remove();c.options.showUploadedFiles&&c._createUploadedFiles(b.name);!g.queueData.queueLength&&c.commandRow.hide()});c._trigger("complete",null,{response:e})},onUploadComplete:function(){var a=this;if(!a.queueData.queueLength&&c.uploadAll){c._cleanSwfProgress();c._trigger("totalComplete",null,a.queueData)}c.uploadAll&&c._swfUploadFile()}}},_cleanSwfProgress:function(){},_updateSwfProgress:function(){},_initSwfUploadOptions:function(k,j){var e=this,g=e.element,b,c=e._swfGetHandlers(),d=e.options,h=e.options.swfUploadOptions,i=g.attr("id"),f=i+"_SWFUpload";a("<input type='file' id='"+f+"'>").appendTo(g);b=a.extend({id:f,swf:"SWFUpload.swf",auto:false,buttonClass:"",buttonCursor:"hand",buttonImage:null,checkExisting:false,debug:false,fileObjName:"Filedata",fileSizeLimit:0,fileTypeDesc:"All Files",fileTypeExts:d.accept?d.accept:"*.*",height:j,itemTemplate:false,method:"post",multi:d.multiple,formData:{},preventCaching:true,progressData:"percentage",queueID:false,queueSizeLimit:999,removeCompleted:true,removeTimeout:3,requeueErrors:false,successTimeout:30,uploadLimit:0,width:k,uploader:d.action,overrideEvents:[]},h);return{assume_success_timeout:b.successTimeout,button_placeholder_id:b.id,button_width:b.width,button_height:b.height,button_text:null,button_text_style:null,button_text_top_padding:0,button_text_left_padding:0,button_action:d.multiple?SWFUpload.BUTTON_ACTION.SELECT_FILES:SWFUpload.BUTTON_ACTION.SELECT_FILE,button_disabled:false,button_cursor:b.buttonCursor=="arrow"?SWFUpload.CURSOR.ARROW:SWFUpload.CURSOR.HAND,button_window_mode:SWFUpload.WINDOW_MODE.TRANSPARENT,debug:b.debug,requeue_on_error:b.requeueErrors,file_post_name:b.fileObjName,file_size_limit:b.fileSizeLimit,file_types:b.fileTypeExts,file_types_description:b.fileTypeDesc,file_queue_limit:b.queueSizeLimit,file_upload_limit:b.uploadLimit,flash_url:b.swf,prevent_swf_caching:b.preventCaching,post_params:b.formData,upload_url:b.uploader,use_query_string:b.method=="get",file_dialog_complete_handler:c.onDialogClose,file_dialog_start_handler:c.onDialogOpen,file_queued_handler:c.onSelect,file_queue_error_handler:c.onSelectError,swfupload_loaded_handler:b.onSWFReady,upload_complete_handler:c.onUploadComplete,upload_error_handler:c.onUploadError,upload_progress_handler:c.onUploadProgress,upload_start_handler:c.onUploadStart,upload_success_handler:c.onUploadSuccess}},_createSWFUpload:function(){var b=this,k=b.element,f=b.addBtn,e,d=b.options.swfUploadOptions,c,j=f.width(),i=f.height(),h=swfobject.getFlashPlayerVersion(),g=h.major>=9;if(g){e=b._initSwfUploadOptions(j,i);c=new SWFUpload(e);b.swfupload=c;a("#"+c.movieName).css({position:"absolute","z-index":100,top:0,left:0});b._swfAppendAddtionalData(c)}else{alert("Please install flash player.");d&&d.onFallback&&d.onFallback.call($this)}},_create:function(){var b=this,c=b.options,e=+new Date,d=b.supportXhr();if(window.wijmoApplyWijTouchUtilEvents)a=window.wijmoApplyWijTouchUtilEvents(a);b.filesLen=0;b.totalUploadFiles=0;b.useXhr=d;b.id=e;b._createContainers();b._createUploadButton();if(c.enableSWFUploadOnIE&&a.browser.msie)b._createSWFUpload();else b._createFileInput();b._bindEvents();c.disabled&&b.disable();b.element.is(":hidden")&&b.element.wijAddVisibilityObserver&&b.element.wijAddVisibilityObserver(function(){b._applyInputPosition();b.element.wijRemoveVisibilityObserver&&b.element.wijRemoveVisibilityObserver()},"wijupload")},_setOption:function(d,c){var b=this;a.Widget.prototype._setOption.apply(this,arguments);if(d==="disabled")b._handleDisabledOption(c,b.upload);else if(d==="accept")b.input&&b.input.attr("accept",c)},_handleDisabledOption:function(b,c){var a=this;if(b){if(!a.disabledDiv)a.disabledDiv=a._createDisabledDiv(c);a.disabledDiv.appendTo("body")}else if(a.disabledDiv){a.disabledDiv.remove();a.disabledDiv=null}},_createDisabledDiv:function(d){var g=this,b=d?d:g.upload,c=b.offset(),f=b.outerWidth(),e=b.outerHeight();return a("<div></div>").addClass("ui-disabled").css({"z-index":"99999",position:"absolute",width:f,height:e,left:c.left,top:c.top})},destroy:function(){var b=this;b.upload.removeClass(r);b.upload.undelegate(b.widgetName).undelegate("."+b.widgetName);b.input.remove();b.addBtn.remove();b.filesList.remove();b.commandRow.remove();b.isCreateByInput===true&&b.element.css({display:""}).unwrap();if(b.uploaders){a.each(b.uploaders,function(b,a){a.destroy&&a.destroy(true);a=null});b.uploaders=null}if(b.disabledDiv){b.disabledDiv.remove();b.disabledDiv=null}},widget:function(){return this.upload},supportXhr:function(){var a=false;if(typeof(new XMLHttpRequest).upload==="undefined")a=false;else a=true;return a},_createContainers:function(){var b=this,e,d,c=b.element;if(c.is(":input")&&c.attr("type")==="file"){b.isCreateByInput=true;b.maxDisplay=c.attr("multiple")||b.options.multiple?0:1;b.upload=c.css({display:"none"}).wrap("<div>").parent()}else if(b.element.is("div")){b.maxDisplay=b.options.multiple?0:1;b.upload=c}else throw'The initial markup must be "DIV", "INPUT[type=file]"';b.upload.addClass(r);e=a("<ul>").addClass(u).appendTo(b.upload);d=a("<div>").addClass(t).appendTo(b.upload);b.filesList=e;d.hide();b.commandRow=d;b._createCommandRow(d)},_createCommandRow:function(e){var b=this,d=a("<a>").attr("href","#").text("uploadAll").addClass(i).button({icons:{primary:"ui-icon-circle-arrow-n"},label:b._getLocalization("uploadAll","Upload All")}),c=a("<a>").attr("href","#").text("cancelAll").addClass(h).button({icons:{primary:"ui-icon-cancel"},label:b._getLocalization("cancelAll","Cancel All")});e.append(d).append(c)},_getLocalization:function(c,b){var a=this.options.localization;return a&&a[c]||b},_createUploadButton:function(){var b=this,c=a("<a>").attr("href","#").button({label:b._getLocalization("uploadFiles","Upload files")});c.mousemove(function(a){var d=c.data("button").options.disabled;if(b.input){var e=a.pageX,f=a.pageY;!d&&b.input.offset({left:e+10-b.input.width(),top:f+10-b.input.height()})}});b.addBtn=c;b.upload.prepend(c)},_applyInputPosition:function(){var d=this,a=d.addBtn,b=a.offset(),c=d.cuurentInput;c.offset({left:b.left+a.width()-c.width(),top:b.top}).height(a.height())},_createFileInput:function(){var b=this,d=b.addBtn,e=d.offset(),g=b.element.attr("accept")||b.options.accept,h="wijUpload_"+b.id+"_input"+b.filesLen,c=a("<input>").attr("type","file").prependTo(b.upload),i=b.options.maximumFiles||b.maxDisplay;i!==1&&b.maxDisplay===0&&c.attr("multiple","multiple");g&&c.attr("accept",g);b.cuurentInput=c;b.filesLen++;c.attr("id",h).attr("name",h).css("position","absolute").offset({left:e.left+d.width()-c.width(),top:e.top}).css("z-index","9999").css("opacity",0).height(d.height()).css("cursor","pointer");b.input=c;c.bind("change",function(g){var e,d;if(b._trigger("change",g,a(this))===false)return false;b._createFileInput();e=b._createFileRow(a(this));b._setAddBtnState();if(b.options.autoSubmit){d=a(f,e);d&&d.click()}c.unbind("change")});b.uploadAll=false},_createUploadedFiles:function(){},_setAddBtnState:function(){var b=this,d=b.options.maximumFiles||b.maxDisplay,c=b.addBtn,e;if(!d)return;if(!c)return;if(!b.maskDiv)b.maskDiv=a("<div></div>").css("position","absolute").css("z-index","9999").width(c.outerWidth()).height(c.outerHeight()).appendTo(b.upload).offset(c.offset());e=a("li",b.filesList);if(e.length>=d){c.button({disabled:true});b.maskDiv.show();b.input&&b.input.css("left","-1000px")}else{c.button({disabled:false});b.maskDiv.hide()}},_createFileRow:function(f){var e=this,q=e.options,d=a("<li>"),i="",p,n,k,h=a("<span>").addClass(s),t=a("<a>").attr("href","#").text("upload").addClass(m).button({text:false,icons:{primary:"ui-icon-circle-arrow-n"},label:e._getLocalization("upload","upload")}),r=a("<a>").attr("href","#").text("cancel").addClass(l).button({text:false,icons:{primary:"ui-icon-cancel"},label:e._getLocalization("cancel","cancel")});d.addClass(j).addClass(w).addClass(o);if(q.enableSWFUploadOnIE&&a.browser.msie){i=f.name;d.attr("id",f.id).data("file",f)}else{d.append(f);f.hide();i=g(f[0])}p=a("<span>"+i+"</span>").addClass(v).addClass(x).addClass(o);d.append(p);d.append(h);n=a("<span />").addClass(b);h.append(n);h.append(t).append(r);d.appendTo(e.filesList);k=a(c,e.upload);if(k.length){e.commandRow.show();(!q.enableSWFUploadOnIE||!a.browser.msie)&&e._createUploader(d);e._resetProgressAll()}return d},_createUploader:function(f){var c=this,i=a("input",f),g=c.options.action,h=c.options.handleRequest,d;if(c.useXhr){d=q(c.id,f,g);d.handleRequest=function(d,b){a.isFunction(h)&&h.call(c,d,b)}}else d=p(c.id,f,g);d.onCancel=function(){var a=this;c._trigger("cancel",null,a.inputFile);c.totalUploadFiles--;c.totalUploadFiles===0&&c.uploadAll&&c._trigger("totalComplete")};if(c._wijUpload()){d.onProgress=function(d){var e=a("."+b,this.fileRow),f={sender:d.fileName,loaded:d.loaded,total:d.total},g=this.inputFile.attr("id");if(d.supportProgress){e.html(Math.round(1e3*d.loaded/d.total)/10+"%");if(d.fileNameList)f.fileNameList=d.fileNameList;c._trigger("progress",null,f);c._progressTotal(g,d.loaded)}else e.addClass(k)};d.onComplete=function(f){var d=this,h=d.inputFile.attr("id"),j=c.uploaders[h],i=e(d.inputFile[0]),g=a("."+b,d.fileRow);c._trigger("complete",f.e,d.inputFile);g.removeClass(k);g.html("100%");c._removeFileRow(d.fileRow,j,true);c._progressTotal(h,i);c.totalUploadFiles--;c.totalUploadFiles===0&&c.uploadAll&&c._trigger("totalComplete",f.e,f)}}if(typeof c.uploaders==="undefined")c.uploaders={};c.uploaders[i.attr("id")]=d},_progressTotal:function(f,e){var b=this,a=b.progressAll,c,d;if(!b.uploadAll)return;if(a&&a.loadedSize){a.loadedSize[f]=e;c=b._getLoadedSize(a.loadedSize);d=a.totalSize}b._trigger("totalProgress",null,{loaded:c,total:d})},_getLoadedSize:function(c){var b=0;a.each(c,function(c,a){b+=a});return b},_getTotalSize:function(){var c=this,b=0;c.uploaders&&a.each(c.uploaders,function(c,a){b+=e(a.inputFile[0])});return b},_resetProgressAll:function(){this.progressAll={totalSize:0,loadedSize:{}}},_wijUpload:function(){return true},_wijcancel:function(){},_upload:function(){},_swfUploadFile:function(a){this.swfupload.startUpload(a)},_bindEvents:function(){var b=this,g=b.options,d=b.progressAll;b.upload.delegate(n,"click."+b.widgetName,function(){var j=a(this),h=j.parents(c),f,i;if(g.enableSWFUploadOnIE&&a.browser.msie){var k=h.data("file");b.swfupload.cancelUpload(k.id);h.fadeOut(1500,function(){h.remove();b.swfupload.queueData.queueLength==0&&b.commandRow.hide()})}else{f=a("input",h[0]);i=b.uploaders[f.attr("id")];b._wijcancel(f);b._wijUpload()&&i&&i.cancel();if(d){d.totalSize-=e(f[0]);if(d.loadedSize[f.val()])delete d.loadedSize[f.val()]}b._removeFileRow(h,i,false)}});b.upload.delegate(f,"click."+b.widgetName,function(h){var j=a(this),f=j.parents(c),e,d;if(g.enableSWFUploadOnIE&&a.browser.msie){var i=f.data("file");b.uploadAll=false;if(b._wijUpload())b._swfUploadFile(i.id);else b._upload(i.id,true)}else{e=a("input",f[0]);d=b.uploaders[e.attr("id")];if(b._trigger("upload",h,e)===false)return false;if(b.options.autoSubmit){d.autoSubmit=true;if(b._trigger("totalUpload",h,null)===false)return false}b.totalUploadFiles++;b._upload(f);d&&b._wijUpload()&&d.upload()}h.preventDefault()});b.upload.delegate("."+i,"click."+b.widgetName,function(c){if(g.enableSWFUploadOnIE&&a.browser.msie){b.uploadAll=true;if(b._wijUpload())b._swfUploadFile();else b._upload(true,true)}else{b.uploadAll=true;!b.progressAll&&b._resetProgressAll();if(b._trigger("totalUpload",c,null)===false)return false;b.progressAll.totalSize=b._getTotalSize();b._wijuploadAll(a(f,b.filesList[0]));b._wijUpload()&&a(f,b.filesList[0]).each(function(c,b){a(b).click()})}});b.upload.delegate("."+h,"click."+b.widgetName,function(){if(g.enableSWFUploadOnIE&&a.browser.msie){a.each(b.swfupload.queueData.files,function(a){b.swfupload.cancelUpload(a)});a(c,b.element).fadeOut(1500,function(){a(this).remove();b.commandRow.hide()})}else{b._resetProgressAll();a(n,b.filesList[0]).each(function(c,b){a(b).click()})}})},_wijuploadAll:function(){},_wijFileRowRemoved:function(){this._setAddBtnState()},_removeFileRow:function(f,b,h){var d=this,e,g;if(b)e=b.inputFile.attr("id");f.fadeOut(1500,function(){f.remove();d._wijFileRowRemoved(f,b.inputFile,h);if(d.uploaders[e])delete d.uploaders[e];g=a(c,d.upload);if(g.length){d.commandRow.show();b&&b.destroy&&b.destroy()}else{d.commandRow.hide();d._resetProgressAll();b&&b.destroy&&b.destroy(true)}})},_getFileName:function(a){return d(a)},_getFileNameByInput:function(a){return g(a)},_getFileSize:function(a){return e(a)}})})(jQuery);